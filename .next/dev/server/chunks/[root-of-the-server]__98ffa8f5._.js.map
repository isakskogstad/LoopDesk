{
  "version": 3,
  "sources": [],
  "debugId": "2118cd0e-cbac-d324-1dd9-b6f3da95a21d",
  "sections": [
    {"offset": {"line": 43, "column": 0}, "map": {"version":3,"sources":["file:///Users/isak/CLAUDE/projects/1.%20Loop%20Desk/src/lib/db.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\nimport { PrismaPg } from \"@prisma/adapter-pg\";\nimport { Pool } from \"pg\";\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined;\n};\n\nfunction createPrismaClient(): PrismaClient {\n  const connectionString = process.env.DATABASE_URL;\n\n  if (!connectionString) {\n    throw new Error(\"DATABASE_URL environment variable is not set\");\n  }\n\n  // Create pg Pool for Supabase connection pooling\n  const pool = new Pool({ connectionString });\n  const adapter = new PrismaPg(pool);\n\n  return new PrismaClient({\n    adapter,\n    log: process.env.NODE_ENV === \"development\" ? [\"error\", \"warn\"] : [\"error\"],\n  });\n}\n\n// Lazy initialization to avoid errors during build\nlet prismaInstance: PrismaClient | null = null;\n\nexport const prisma = new Proxy({} as PrismaClient, {\n  get(_target, prop) {\n    if (!prismaInstance) {\n      prismaInstance = globalForPrisma.prisma ?? createPrismaClient();\n      if (process.env.NODE_ENV !== \"production\") {\n        globalForPrisma.prisma = prismaInstance;\n      }\n    }\n    return (prismaInstance as unknown as Record<string, unknown>)[prop as string];\n  },\n});\n\n// Helper to create title hash for grouping related articles\nexport function createTitleHash(title: string): string {\n  // Normalize title for comparison\n  const normalized = title\n    .toLowerCase()\n    .replace(/[^\\w\\s]/g, \"\")\n    .replace(/\\s+/g, \" \")\n    .trim()\n    .split(\" \")\n    .slice(0, 6) // First 6 words\n    .join(\" \");\n\n  // Simple hash function\n  let hash = 0;\n  for (let i = 0; i < normalized.length; i++) {\n    const char = normalized.charCodeAt(i);\n    hash = ((hash << 5) - hash) + char;\n    hash = hash & hash;\n  }\n  return hash.toString(36);\n}\n\n// Check if article matches any keywords\nexport async function checkKeywordMatches(\n  articleId: string,\n  title: string,\n  description: string | null\n): Promise<void> {\n  const keywords = await prisma.keyword.findMany({\n    where: { isActive: true },\n  });\n\n  for (const keyword of keywords) {\n    const term = keyword.term.toLowerCase();\n    const titleLower = title.toLowerCase();\n    const descLower = (description || \"\").toLowerCase();\n\n    let matchedIn: string | null = null;\n\n    if (titleLower.includes(term)) {\n      matchedIn = \"title\";\n    } else if (descLower.includes(term)) {\n      matchedIn = \"description\";\n    }\n\n    if (matchedIn) {\n      await prisma.keywordMatch.upsert({\n        where: {\n          articleId_keywordId: {\n            articleId,\n            keywordId: keyword.id,\n          },\n        },\n        create: {\n          articleId,\n          keywordId: keyword.id,\n          matchedIn,\n        },\n        update: {},\n      });\n    }\n  }\n}\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;AACA;;;;;;;;;AAEA,MAAM,kBAAkB;AAIxB,SAAS;IACP,MAAM,mBAAmB,QAAQ,GAAG,CAAC,YAAY;IAEjD,IAAI,CAAC,kBAAkB;QACrB,MAAM,IAAI,MAAM;IAClB;IAEA,iDAAiD;IACjD,MAAM,OAAO,IAAI,gMAAI,CAAC;QAAE;IAAiB;IACzC,MAAM,UAAU,IAAI,oNAAQ,CAAC;IAE7B,OAAO,IAAI,iPAAY,CAAC;QACtB;QACA,KAAK,uCAAyC;YAAC;YAAS;SAAO,GAAG;IACpE;AACF;AAEA,mDAAmD;AACnD,IAAI,iBAAsC;AAEnC,MAAM,SAAS,IAAI,MAAM,CAAC,GAAmB;IAClD,KAAI,OAAO,EAAE,IAAI;QACf,IAAI,CAAC,gBAAgB;YACnB,iBAAiB,gBAAgB,MAAM,IAAI;YAC3C,wCAA2C;gBACzC,gBAAgB,MAAM,GAAG;YAC3B;QACF;QACA,OAAO,AAAC,cAAqD,CAAC,KAAe;IAC/E;AACF;AAGO,SAAS,gBAAgB,KAAa;IAC3C,iCAAiC;IACjC,MAAM,aAAa,MAChB,WAAW,GACX,OAAO,CAAC,YAAY,IACpB,OAAO,CAAC,QAAQ,KAChB,IAAI,GACJ,KAAK,CAAC,KACN,KAAK,CAAC,GAAG,GAAG,gBAAgB;KAC5B,IAAI,CAAC;IAER,uBAAuB;IACvB,IAAI,OAAO;IACX,IAAK,IAAI,IAAI,GAAG,IAAI,WAAW,MAAM,EAAE,IAAK;QAC1C,MAAM,OAAO,WAAW,UAAU,CAAC;QACnC,OAAO,AAAC,CAAC,QAAQ,CAAC,IAAI,OAAQ;QAC9B,OAAO,OAAO;IAChB;IACA,OAAO,KAAK,QAAQ,CAAC;AACvB;AAGO,eAAe,oBACpB,SAAiB,EACjB,KAAa,EACb,WAA0B;IAE1B,MAAM,WAAW,MAAM,OAAO,OAAO,CAAC,QAAQ,CAAC;QAC7C,OAAO;YAAE,UAAU;QAAK;IAC1B;IAEA,KAAK,MAAM,WAAW,SAAU;QAC9B,MAAM,OAAO,QAAQ,IAAI,CAAC,WAAW;QACrC,MAAM,aAAa,MAAM,WAAW;QACpC,MAAM,YAAY,CAAC,eAAe,EAAE,EAAE,WAAW;QAEjD,IAAI,YAA2B;QAE/B,IAAI,WAAW,QAAQ,CAAC,OAAO;YAC7B,YAAY;QACd,OAAO,IAAI,UAAU,QAAQ,CAAC,OAAO;YACnC,YAAY;QACd;QAEA,IAAI,WAAW;YACb,MAAM,OAAO,YAAY,CAAC,MAAM,CAAC;gBAC/B,OAAO;oBACL,qBAAqB;wBACnB;wBACA,WAAW,QAAQ,EAAE;oBACvB;gBACF;gBACA,QAAQ;oBACN;oBACA,WAAW,QAAQ,EAAE;oBACrB;gBACF;gBACA,QAAQ,CAAC;YACX;QACF;IACF;AACF"}},
    {"offset": {"line": 148, "column": 0}, "map": {"version":3,"sources":["file:///Users/isak/CLAUDE/projects/1.%20Loop%20Desk/src/app/api/person/names/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { prisma } from \"@/lib/db\";\n\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 300; // Cache for 5 minutes\n\n/**\n * GET /api/person/names\n * Returns a map of person names to their IDs for client-side linking\n */\nexport async function GET() {\n  try {\n    const persons = await prisma.person.findMany({\n      select: {\n        id: true,\n        name: true,\n        allabolagId: true,\n      },\n      orderBy: {\n        name: \"asc\",\n      },\n    });\n\n    // Build a map: name -> { id, allabolagId }\n    const personMap: Record<string, { id: string; allabolagId: string | null }> = {};\n\n    for (const person of persons) {\n      // Use the full name as key\n      personMap[person.name] = {\n        id: person.id,\n        allabolagId: person.allabolagId,\n      };\n    }\n\n    return NextResponse.json({\n      persons: personMap,\n      count: persons.length,\n    });\n  } catch (error) {\n    console.error(\"Error fetching person names:\", error);\n    return NextResponse.json(\n      { error: \"Failed to fetch person names\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;;;;;;;AAEO,MAAM,UAAU;AAChB,MAAM,aAAa,KAAK,sBAAsB;AAM9C,eAAe;IACpB,IAAI;QACF,MAAM,UAAU,MAAM,uKAAM,CAAC,MAAM,CAAC,QAAQ,CAAC;YAC3C,QAAQ;gBACN,IAAI;gBACJ,MAAM;gBACN,aAAa;YACf;YACA,SAAS;gBACP,MAAM;YACR;QACF;QAEA,2CAA2C;QAC3C,MAAM,YAAwE,CAAC;QAE/E,KAAK,MAAM,UAAU,QAAS;YAC5B,2BAA2B;YAC3B,SAAS,CAAC,OAAO,IAAI,CAAC,GAAG;gBACvB,IAAI,OAAO,EAAE;gBACb,aAAa,OAAO,WAAW;YACjC;QACF;QAEA,OAAO,2LAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,OAAO,QAAQ,MAAM;QACvB;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gCAAgC;QAC9C,OAAO,2LAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAA+B,GACxC;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}