;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="4b47effa-1a89-4954-d987-c28d4de32c40")}catch(e){}}();
module.exports=[624834,e=>{"use strict";var t=e.i(450526);class r{requests=new Map;cleanupInterval;constructor(){this.cleanupInterval=setInterval(()=>{this.cleanup()},3e5)}check(e,t){let r=Date.now(),a=r-t.windowMs,n=this.requests.get(e);n||(n={timestamps:[]},this.requests.set(e,n)),n.timestamps=n.timestamps.filter(e=>e>a);let o=n.timestamps.length<t.maxRequests;return o&&n.timestamps.push(r),{allowed:o,remaining:Math.max(0,t.maxRequests-n.timestamps.length),resetAt:new Date((n.timestamps[0]||r)+t.windowMs)}}cleanup(){let e=Date.now();for(let[t,r]of this.requests.entries())(0===r.timestamps.length||r.timestamps[r.timestamps.length-1]<e-36e5)&&this.requests.delete(t);console.log(`[RateLimiter] Cleanup: ${this.requests.size} active identifiers`)}reset(e){this.requests.delete(e)}getStats(){let e=0;for(let t of this.requests.values())e+=t.timestamps.length;return{activeIdentifiers:this.requests.size,totalRequests:e}}destroy(){this.cleanupInterval&&clearInterval(this.cleanupInterval)}}let a=new r,n={api:{maxRequests:100,windowMs:6e4},scraping:{maxRequests:10,windowMs:6e4},auth:{maxRequests:5,windowMs:6e4},heavy:{maxRequests:20,windowMs:6e4}};function o(e,t){if(t?.user?.id)return`user:${t.user.id}`;let r=e.headers.get("x-forwarded-for"),a=r?r.split(",")[0].trim():e.headers.get("x-real-ip")||"unknown";return`ip:${a}`}function i(e,r){let o=n[r],{allowed:i,remaining:l,resetAt:s}=a.check(e,o);return i?{allowed:!0}:{allowed:!1,response:t.NextResponse.json({error:"Too many requests",message:`Rate limit exceeded. Try again after ${s.toISOString()}`,retryAfter:Math.ceil((s.getTime()-Date.now())/1e3)},{status:429,headers:{"Retry-After":String(Math.ceil((s.getTime()-Date.now())/1e3)),"X-RateLimit-Limit":String(o.maxRequests),"X-RateLimit-Remaining":"0","X-RateLimit-Reset":s.toISOString()}})}}e.s(["checkRateLimit",()=>i,"getRateLimitIdentifier",()=>o],624834)},378952,(e,t,r)=>{t.exports=e.x("playwright-2d5ef360b5969670",()=>require("playwright-2d5ef360b5969670"))},191039,e=>e.a(async(t,r)=>{try{var a=e.i(517339),n=e.i(624834),o=e.i(881983),i=e.i(522734),l=e.i(814747),s=t([a]);[a]=s.then?(await s)():s;let T="https://poit.bolagsverket.se/poit-app/sok",A={navigationTimeout:parseInt(process.env.SCRAPER_NAVIGATION_TIMEOUT||"90000",10)};async function c(e,t){try{let r=await e.evaluate(()=>{let e=document.body?.innerText||"",t=document.body?.innerHTML||"",r=Array.from(document.querySelectorAll("input")).map(e=>({id:e.id,name:e.name,type:e.type,placeholder:e.placeholder,visible:null!==e.offsetParent,formcontrolname:e.getAttribute("formcontrolname")})),a=Array.from(document.querySelectorAll("button")).map(e=>({text:(e.innerText||"").slice(0,50),disabled:e.disabled,visible:null!==e.offsetParent})),n=!!document.querySelector("[ng-version]")||!!document.querySelector("app-root"),o=e.includes("TypeError")||e.includes("Cannot read")||e.includes("undefined");return{url:window.location.href,title:document.title,bodyLength:e.length,htmlLength:t.length,inputCount:r.length,visibleInputs:r.filter(e=>e.visible),buttons:a.filter(e=>e.visible).slice(0,5),hasNgApp:n,hasAngularError:o,has403:e.includes("403")||e.includes("Forbidden"),hasBlocker:e.includes("human visitor")||!!document.querySelector("#ans"),textPreview:e.slice(0,800)}});console.log(`[DEBUG ${t}] Page state:`,JSON.stringify(r,null,2))}catch(e){console.log(`[DEBUG ${t}] Failed to capture page state:`,e)}}async function u(t){let r=await (0,a.auth)();if(!r?.user?.id)return new Response(JSON.stringify({error:"Unauthorized"}),{status:401,headers:{"Content-Type":"application/json"}});let s=(0,n.getRateLimitIdentifier)(t,r),u=(0,n.checkRateLimit)(s,"scraping");if(!u.allowed)return u.response;let{query:p,orgNumber:m,skipDetails:h=!1,detailLimit:y=5}=await t.json();if(!p||"string"!=typeof p||p.trim().length<2)return new Response(JSON.stringify({error:"Query must be at least 2 characters"}),{status:400,headers:{"Content-Type":"application/json"}});let b=new TextEncoder,E=new ReadableStream({async start(t){let r=e=>{t.enqueue(b.encode(`data: ${JSON.stringify(e)}

`))};try{let t,a;r({type:"status",message:"Startar webbläsare..."}),process.env.TWOCAPTCHA_API_KEY;let n=process.env.PROXY_SERVER||"",s=process.env.PROXY_USERNAME||"",u=process.env.PROXY_PASSWORD||"";try{let{forceRefreshProxies:t}=await e.A(95656);await t()}catch(e){console.warn("[StreamScraper] Failed to refresh proxies:",e)}let{chromium:b}=e.r(378952);n&&"disabled"!==n?(t={server:n,username:s||void 0,password:u||void 0},console.log(`[StreamScraper] Using static proxy from env: ${n}`)):(await o.proxyManager.activate("stream-init"),t=o.proxyManager.getPlaywrightConfig().proxy),t?(console.log(`[Proxy] Using proxy server: ${t.server}`),t.username||console.warn("[Proxy] Username missing - proxy auth may fail"),r({type:"status",message:"Ansluter via proxy..."})):console.log("[Proxy] No proxy configured, using direct connection");try{console.log("[StreamScraper] Trying playwright default browser..."),a=await b.launch({headless:!0,args:["--no-sandbox","--disable-setuid-sandbox","--disable-blink-features=AutomationControlled","--disable-dev-shm-usage","--disable-infobars","--window-size=1920,1080","--disable-extensions","--disable-plugins-discovery","--disable-bundled-ppapi-flash"],proxy:t}),console.log("[StreamScraper] Using playwright default browser")}catch{let e=function(){let e=process.env.PLAYWRIGHT_BROWSERS_PATH||"/ms-playwright";try{let t=(0,i.readdirSync)(e);for(let r of(console.log("[StreamScraper] Available browser directories:",t.join(", ")),t))if(r.startsWith("chrome-")){let t=(0,l.join)(e,r,"chrome-linux","chrome");if((0,i.existsSync)(t))return console.log("[StreamScraper] Found Google Chrome at:",t),t}for(let r of t)if(r.startsWith("chromium-")&&!r.includes("headless")){let t=(0,l.join)(e,r,"chrome-linux","chrome");if((0,i.existsSync)(t))return console.log("[StreamScraper] Found full Chromium at:",t),t}for(let r of t)if(r.startsWith("chromium")&&!r.includes("headless")){for(let t of[(0,l.join)(e,r,"chrome-linux","chrome"),(0,l.join)(e,r,"chrome"),(0,l.join)(e,r,"chromium")])if((0,i.existsSync)(t))return console.log("[StreamScraper] Found Chromium at:",t),t}for(let r of t)if(r.startsWith("chromium_headless_shell-")){let t=(0,l.join)(e,r,"chrome-headless-shell-linux64","chrome-headless-shell");if((0,i.existsSync)(t))return console.log("[StreamScraper] WARNING: Using headless shell (may not work with Angular apps):",t),t}}catch(e){console.warn("[StreamScraper] Could not search for Chromium:",e)}console.log("[StreamScraper] No browser found, will try system default")}();console.log("[StreamScraper] Default failed, using custom path:",e||"none"),a=await b.launch({headless:!0,executablePath:e,args:["--no-sandbox","--disable-setuid-sandbox","--disable-blink-features=AutomationControlled","--disable-dev-shm-usage","--disable-infobars","--window-size=1920,1080","--disable-extensions","--disable-plugins-discovery","--disable-bundled-ppapi-flash"],proxy:t})}r({type:"status",message:"Öppnar Bolagsverkets POIT..."});let E=await a.newContext({userAgent:"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",viewport:{width:1920,height:1080},locale:"sv-SE",timezoneId:"Europe/Stockholm",permissions:["geolocation"],javaScriptEnabled:!0,ignoreHTTPSErrors:!0,extraHTTPHeaders:{"Accept-Language":"sv-SE,sv;q=0.9,en;q=0.8"}}),R=await E.newPage();await R.route("**/assets/index-*.js",async e=>{console.log("[StreamScraper] Intercepting Angular bundle:",e.request().url());try{let t=await e.fetch(),r=await t.text(),a=r.length,n=0,o=r.length;(r=r.replace(/fixLink:function\((\w)\)\{return \1\.replaceAll/g,'fixLink:function($1){if($1==null)return"";return $1.replaceAll')).length!==o&&n++;let i=r.length;(r=r.replace(/throw new Error\('Missing required param "'\+(\w)\+'"\)/g,'console.warn("[Patched] Missing param:",$1);return""')).length!==i&&n++;let l=r.length;(r=r.replace(/throw new Error\(`Missing required param "\$\{(\w)\}"`\)/g,'console.warn("[Patched] Missing param:",$1);return""')).length!==l&&n++;let s=r.length;(r=r.replace(/kungorelseid:(\w)\.id/g,'kungorelseid:$1&&$1.id||"0"')).length!==s&&n++,console.log(`[StreamScraper] Angular bundle patches: ${n} applied (${a} -> ${r.length})`),await e.fulfill({response:t,body:r,headers:{...t.headers(),"Content-Length":String(r.length)}})}catch(t){console.warn("[StreamScraper] Failed to patch Angular bundle, continuing with original:",t),await e.continue()}}),await R.addInitScript(()=>{Object.defineProperty(navigator,"webdriver",{get:()=>void 0});let e=window.navigator.permissions.query;window.navigator.permissions.query=t=>"notifications"===t.name?Promise.resolve({state:Notification.permission}):e(t),Object.defineProperty(navigator,"plugins",{get:()=>[1,2,3,4,5]}),Object.defineProperty(navigator,"languages",{get:()=>["sv-SE","sv","en-US","en"]});let t=String.prototype.replaceAll;String.prototype.replaceAll=function(e,r){return this===null||void 0===this?(console.warn("[Patched] replaceAll called on null/undefined, returning empty string"),""):t.call(this,e,r)},window.onerror=function(e,t,r,a,n){return!!(e&&(e.includes("Cannot read properties of undefined (reading 'replaceAll')")||e.includes("Cannot read properties of null")||e.includes("Missing required param")||e.includes("kungorelseid")||e.includes("fixLink")||e.includes("is not a function")))&&(console.warn("[window.onerror] Suppressed Angular error:",e),!0)},window.addEventListener("error",e=>{if(e.message&&(e.message.includes("Cannot read properties of undefined (reading 'replaceAll')")||e.message.includes("Cannot read properties of null")||e.message.includes("Missing required param")||e.message.includes("kungorelseid")||e.message.includes("fixLink")))return console.warn("[error listener] Suppressed Angular error:",e.message),e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!0},!0),window.addEventListener("unhandledrejection",e=>{let t=e.reason?String(e.reason):"";(t.includes("replaceAll")||t.includes("fixLink")||t.includes("Cannot read properties")||t.includes("Missing required param")||t.includes("kungorelseid"))&&(console.warn("[unhandledrejection] Suppressed:",t),e.preventDefault())});let r=()=>{let e=window.Zone;if(e&&e.current){let t=e.current._zoneDelegate?.handleError;t&&!e.current._zoneDelegate?._patchedHandleError&&(e.current._zoneDelegate.handleError=function(e,r){let a=r?String(r.message||r):"";return a.includes("replaceAll")||a.includes("fixLink")||a.includes("Cannot read properties")||a.includes("Missing required param")||a.includes("kungorelseid")?(console.warn("[Zone.js] Suppressed Angular error:",a),!0):t.call(this,e,r)},e.current._zoneDelegate._patchedHandleError=!0)}};r(),setTimeout(r,1e3),setTimeout(r,3e3);let a=()=>{try{document.querySelectorAll("script").forEach(e=>{(e.textContent||"").includes("fixLink")&&console.log("[Runtime] Found script with fixLink reference")});let e=document.querySelector("app-root");if(e){let t=e=>{let r=e.__ngContext__;r&&Array.isArray(r)&&r.forEach(e=>{if(e&&"object"==typeof e&&"function"==typeof e.fixLink){let t=e.fixLink.bind(e);e.fixLink=function(e){return null==e?(console.log("[Runtime] fixLink called with null/undefined, returning empty"),""):t(e)},console.log("[Runtime] Patched fixLink on component instance")}}),Array.from(e.children).forEach(t)};t(e)}}catch(e){console.warn("[Runtime] Error patching fixLink:",e)}};setTimeout(a,500),setTimeout(a,1500),setTimeout(a,3e3),setTimeout(a,5e3),setTimeout(()=>{let e=document.querySelector("app-root");e&&(e.__ngContext__||e.ngContext)&&console.log("[Patch] Angular context found, navigation should work")},2e3)});let C=!1,P=0;R.on("console",e=>{"error"===e.type()&&console.log("[PageConsole] ERROR:",e.text())}),R.on("pageerror",e=>{console.log("[PageError]",e.message)}),R.on("response",e=>{403===e.status()?(C=!0,P++,console.log(`[StreamScraper] Got 403 on ${e.url()} (count: ${P})`)):e.status()>=200&&300>e.status()&&(P=0)});try{await R.goto(T,{waitUntil:"load",timeout:6e4}),console.log("[StreamScraper] Waiting for Angular to bootstrap..."),await R.waitForFunction(()=>{let e=document.body?.innerText||"",t=!!document.querySelector("app-root")||!!document.querySelector("[ng-version]"),r=e.length>100;return t||r},{timeout:3e4}).catch(()=>{console.log("[StreamScraper] Angular bootstrap timeout, continuing...")}),await R.waitForTimeout(3e3),console.log("[StreamScraper] Initial page loaded, capturing state..."),await c(R,"initial-load"),C&&P>=3&&(r({type:"error",message:"Bolagsverket blockerar anslutningen (403). Försöker igen..."}),console.log("[StreamScraper] Multiple 403s detected, waiting before retry..."),await c(R,"403-blocked"),await R.waitForTimeout(5e3),C=!1,P=0,await R.goto(T,{waitUntil:"load",timeout:6e4}),await R.waitForTimeout(3e3)),await R.waitForTimeout(1e3),r({type:"status",message:"Kontrollerar captcha..."}),await d(R,r),r({type:"status",message:"Öppnar sökformulär..."});let e=await f(R);await d(R,r),e||(console.log("[StreamScraper] First navigation failed, reloading page..."),await R.goto(T,{waitUntil:"load",timeout:3e4}),await R.waitForTimeout(3e3),await d(R,r),e=await f(R)),await w(R),r({type:"search",message:`S\xf6ker: "${p.trim()}"...`});let a=!1;for(let e=1;e<=3;e++){if(a=await x(R,p.trim()),!0===a){console.log("[StreamScraper] Search submitted successfully");break}if("disabled"===a)throw r({type:"error",message:"Sökfältet inaktiverat - ogiltigt sökord"}),Error("Invalid search query");console.log(`[StreamScraper] Input not found, retrying (attempt ${e}/3)...`),await c(R,`input-not-found-attempt-${e}`),r({type:"status",message:`F\xf6rs\xf6ker igen (${e}/3)...`}),await R.goto(R.url(),{waitUntil:"domcontentloaded",timeout:A.navigationTimeout}).catch(()=>{}),await R.waitForTimeout(1e3),await d(R,r),await f(R),await w(R)}if(!0!==a)throw await c(R,"search-form-final-failure"),Error("Kunde inte hitta sökformulär efter 3 försök");try{await R.waitForFunction(()=>!(document.body?.innerText||"").includes("Laddar"),{timeout:2e4}).catch(()=>console.log("[StreamScraper] Still shows 'Laddar' after 20s")),await R.waitForFunction(()=>{let e=document.body?.innerText||"";return null!==document.querySelector("table")||null!==document.querySelector('a[href*="kungorelse/"]')||e.includes("Antal träffar")||e.includes("inga träffar")||e.includes("0 träffar")||e.includes("Inga kungörelser")},{timeout:15e3})}catch{console.log("[StreamScraper] Timeout waiting for search results")}await R.waitForTimeout(2e3),await d(R,r),await g(R),r({type:"status",message:"Samlar in resultat..."});let n=R.url();console.log("[StreamScraper] Current URL after search:",n);let o=await S(R,r,p.trim());r({type:"result",message:`Hittade ${o.length} kung\xf6relser`,data:{count:o.length}});let i=[];if(!h&&o.length>0){let e=Math.min(y,o.length);r({type:"status",message:`H\xe4mtar detaljer f\xf6r ${e} av ${o.length} kung\xf6relser...`});let a=0;for(let n=0;n<e;n++){let l=o[n];r({type:"detail",message:`H\xe4mtar detalj ${n+1}/${e}: ${l.type||"Kungörelse"}`,data:{current:n+1,total:e,id:l.id}});let s=Date.now()-a;if(s<3e3&&a>0){let e=3e3-s;await new Promise(t=>setTimeout(t,e))}a=Date.now();let c="",u=5e3,d=!1;for(let e=1;e<=5;e++)try{let n=d?t?.server:void 0;console.log(`[StreamScraper] Detail attempt ${e}/5 for ${l.id}, useProxy=${d}`);let o=await v(E,l,{proxyUrl:n,proxyUsername:d?t?.username:void 0,proxyPassword:d?t?.password:void 0});if(c=o.text||"",o.got429){r({type:"error",message:`⚠️ Rate limit f\xf6r ${l.id}, aktiverar proxy (${e}/5)...`}),d=!0,await new Promise(e=>setTimeout(e,u)),u*=2,a=Date.now();continue}if(c&&c.trim())break;e<5&&(r({type:"status",message:`Tom text f\xf6r ${l.id}, f\xf6rs\xf6ker igen (${e}/5)...`}),await new Promise(e=>setTimeout(e,4e3)))}catch(t){5===e?r({type:"error",message:`✗ Kunde inte h\xe4mta detalj efter 5 f\xf6rs\xf6k: ${t instanceof Error?t.message:"Okänt fel"}`}):(r({type:"status",message:`Fel f\xf6r ${l.id}, f\xf6rs\xf6ker igen (${e}/5)...`}),await new Promise(e=>setTimeout(e,4e3)))}c&&c.trim()||console.log(`[StreamScraper] All 5 attempts failed for ${l.id}`),c?(l.detailText=c.length>500?c.slice(0,500)+"...":c,l.fullText=c,r({type:"success",message:`✓ Detalj ${n+1}/${e} h\xe4mtad`,data:{id:l.id,hasText:!0}})):r({type:"error",message:`✗ Kunde inte h\xe4mta detalj f\xf6r ${l.id} efter alla f\xf6rs\xf6k`,data:{id:l.id,hasText:!1}}),i.push(l)}for(let t=e;t<o.length;t++)i.push(o[t])}else i.push(...o);r({type:"status",message:"Sparar till databas..."});let l=await k(p.trim(),m,i);r({type:"complete",message:`Klar! ${l} kung\xf6relser sparade`,data:{total:o.length,saved:l,withDetails:i.filter(e=>e.fullText).length}})}finally{try{await E.close()}catch(e){console.log("[StreamScraper] Context already closed:",e)}try{await a.close()}catch(e){console.log("[StreamScraper] Browser already closed:",e)}}}catch(e){console.log("[StreamScraper] Error:",e),r({type:"error",message:`Fel: ${e instanceof Error?e.message:"Okänt fel"}`})}finally{t.close()}}});return new Response(E,{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"}})}async function d(e,t){for(let r=1;r<=5;r++){if(!await e.evaluate(()=>{let e=document.body?document.body.innerText:"";return!!document.querySelector("#ans")||e.includes("human visitor")}))return!0;t({type:"captcha",message:`Captcha uppt\xe4ckt, l\xf6ser... (f\xf6rs\xf6k ${r}/5)`});let a=await e.evaluate(()=>{let e=Array.from(document.querySelectorAll("img")).find(e=>(e.src||"").includes("base64"));return e?e.src:null});if(!a){await e.goto(e.url(),{waitUntil:"domcontentloaded",timeout:A.navigationTimeout}).catch(()=>{}),await e.waitForTimeout(3e3);continue}try{let r=await p(a,t),n=e.locator("#ans");await n.fill(r),await e.locator("#jar").click(),await e.waitForTimeout(3e3),await e.waitForFunction(()=>{let e=document.body?.innerText||"",t=e.includes("human visitor")||!!document.querySelector("#ans"),r=!!document.querySelector("app-root")||!!document.querySelector("[ng-version]"),a=e.length>500;return!t&&(r||a)},{timeout:15e3}).catch(()=>{console.log("[solveBlockerWithProgress] Timeout waiting for Angular after CAPTCHA")}),await e.waitForTimeout(2e3),t({type:"captcha",message:"Captcha löst!"})}catch(r){t({type:"error",message:`Captcha-fel: ${r instanceof Error?r.message:"Okänt"}`}),await e.goto(e.url(),{waitUntil:"domcontentloaded",timeout:A.navigationTimeout}).catch(()=>{}),await e.waitForTimeout(3e3)}}return!1}async function p(e,t){let r=process.env.TWOCAPTCHA_API_KEY||"";if(!r)throw Error("TWOCAPTCHA_API_KEY ej konfigurerad");t({type:"captcha",message:"Skickar captcha till 2captcha..."});let a=new URL("https://2captcha.com/in.php");a.searchParams.set("key",r),a.searchParams.set("method","base64"),a.searchParams.set("json","1");let n=e.includes("base64,")?e.split("base64,")[1]:e,o=await fetch(a.toString(),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({body:n})}),i=await o.json();if(1!==i.status)throw Error(`2captcha submit failed: ${i.request}`);let l=i.request;t({type:"captcha",message:`V\xe4ntar p\xe5 2captcha (ID: ${l})...`});let s=new URL("https://2captcha.com/res.php");s.searchParams.set("key",r),s.searchParams.set("action","get"),s.searchParams.set("id",l),s.searchParams.set("json","1");for(let e=0;e<30;e++){await new Promise(e=>setTimeout(e,2e3));let r=await fetch(s.toString()),a=await r.json();if(1===a.status)return a.request;if("CAPCHA_NOT_READY"!==a.request)throw Error(`2captcha failed: ${a.request}`);e%5==0&&t({type:"captcha",message:`V\xe4ntar p\xe5 captcha-svar... (${2*e}s)`})}throw Error("2captcha timeout")}async function m(e){let t=process.env.TWOCAPTCHA_API_KEY||"";for(let r=1;r<=3;r++){if(!await e.evaluate(()=>{let e=document.body?document.body.innerText:"";return!!document.querySelector("#ans")||e.includes("human visitor")}))return!0;console.log(`[solveBlockerSilent] CAPTCHA detected, solving... (attempt ${r}/3)`);let a=await e.evaluate(()=>{let e=Array.from(document.querySelectorAll("img")).find(e=>(e.src||"").includes("base64"));return e?e.src:null});if(!a){console.log("[solveBlockerSilent] No CAPTCHA image found, reloading..."),await e.goto(e.url(),{waitUntil:"domcontentloaded",timeout:2e4}).catch(()=>{}),await e.waitForTimeout(3e3);continue}if(!t){console.log("[solveBlockerSilent] No 2captcha API key, cannot solve CAPTCHA");break}try{let r=new URL("https://2captcha.com/in.php");r.searchParams.set("key",t),r.searchParams.set("method","base64"),r.searchParams.set("json","1");let n=a.includes("base64,")?a.split("base64,")[1]:a,o=await fetch(r.toString(),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({body:n})}),i=await o.json();if(1!==i.status){console.log(`[solveBlockerSilent] 2captcha submit failed: ${i.request}`);continue}let l=i.request;console.log(`[solveBlockerSilent] Waiting for 2captcha (ID: ${l})...`);let s=new URL("https://2captcha.com/res.php");s.searchParams.set("key",t),s.searchParams.set("action","get"),s.searchParams.set("id",l),s.searchParams.set("json","1");let c="";for(let e=0;e<20;e++){await new Promise(e=>setTimeout(e,2e3));let e=await fetch(s.toString()),t=await e.json();if(1===t.status){c=t.request;break}if("CAPCHA_NOT_READY"!==t.request){console.log(`[solveBlockerSilent] 2captcha error: ${t.request}`);break}}if(c){let t=e.locator("#ans");await t.fill(c),await e.locator("#jar").click(),await e.waitForTimeout(3e3),await e.waitForFunction(()=>{let e=document.body?.innerText||"";return!(e.includes("human visitor")||document.querySelector("#ans"))&&e.length>300},{timeout:15e3}).catch(()=>{}),console.log("[solveBlockerSilent] CAPTCHA solved!")}}catch(t){console.log(`[solveBlockerSilent] Error: ${t instanceof Error?t.message:"Unknown"}`),await e.goto(e.url(),{waitUntil:"domcontentloaded",timeout:2e4}).catch(()=>{}),await e.waitForTimeout(3e3)}}return!1}async function g(e){try{for(let t of['button[data-cookiefirst-action="reject"]','button[data-cookiefirst-action="accept"]','.cookiefirst-root button:has-text("Avvisa")','.cookiefirst-root button:has-text("Acceptera")','dialog[aria-label*="Cookie"] button','[class*="cookie"] button:first-of-type']){let r=e.locator(t).first();if(await r.count()>0&&await r.isVisible()){await r.click({timeout:3e3}).catch(()=>{}),await e.waitForTimeout(500),console.log("[StreamScraper] Dismissed cookie banner");return}}await e.keyboard.press("Escape"),await e.waitForTimeout(300)}catch(e){}}async function h(e){let t=e.getByRole("heading",{name:/Sök kungörelse/i});try{return await t.first().waitFor({timeout:15e3}),!0}catch{return!1}}async function f(e){await g(e);let t=await e.$("#namn"),r=await e.$("#personOrgnummer");if(t||r)return!0;console.log("[maybeNavigateToSearch] Opening search form...");let a=e.getByRole("link",{name:/Sök kungörelse/i});if(await a.count())try{await Promise.all([a.first().click(),e.waitForURL(/\/poit-app\/sok/,{timeout:15e3}).catch(()=>{})])}catch{await a.first().click({force:!0,timeout:5e3}).catch(()=>{})}else await e.evaluate(()=>{let e=Array.from(document.querySelectorAll("a")).find(e=>(e.innerText||"").includes("Sök kungörelse"));e&&e.click()});await e.waitForTimeout(1e3),await h(e),await w(e);let n=await e.$("#namn"),o=await e.$("#personOrgnummer");return!!(n||o)}async function w(e){await e.waitForFunction(()=>{for(let e of["#namn","#personOrgnummer",'input[id*="namn"]','input[id*="org"]','input[name*="namn"]','input[name*="org"]','input[placeholder*="Företag"]','input[placeholder*="Org"]',"input[formcontrolname]",'input[type="text"]']){let t=document.querySelector(e);if(t&&null!==t.offsetParent)return!0}return!1},{timeout:2e4}).catch(()=>{console.log("[waitForSearchInputs] Timeout waiting for inputs")})}async function y(e,t){for(let r of t?["#personOrgnummer",'input[id*="org"]','input[id*="Org"]','input[name*="org"]','input[name*="Org"]','input[formcontrolname*="org"]','input[formcontrolname*="Org"]','input[placeholder*="Org"]','input[placeholder*="organisationsnummer"]','input[placeholder*="Organisationsnummer"]','input[aria-label*="Org"]','input[type="text"]:near(:text("Organisationsnummer"))']:["#namn",'input[id*="namn"]','input[id*="Namn"]','input[name*="namn"]','input[name*="Namn"]','input[formcontrolname*="namn"]','input[formcontrolname*="Namn"]','input[placeholder*="Företag"]','input[placeholder*="företag"]','input[placeholder*="namn"]','input[placeholder*="Namn"]','input[aria-label*="namn"]','input[aria-label*="Namn"]','input[type="text"]:near(:text("Företagsnamn"))','input[type="text"]:near(:text("Namn"))'])try{let t=e.locator(r);if(await t.count()>0)return console.log(`[resolveSearchInput] Found input with selector: ${r}`),t.first()}catch{}console.log("[resolveSearchInput] Trying generic text input fallback...");let r=e.locator('input[type="text"]:visible');return await r.count()>0?(console.log(`[resolveSearchInput] Found ${await r.count()} generic text inputs`),r.first()):null}async function x(e,t){let r=t.replace(/\D/g,""),a=r.length>=10,n=a&&r.length>=10?`${r.slice(0,6)}-${r.slice(6,10)}`:t,o=Date.now(),i=null;for(;!i&&Date.now()-o<15e3;)(i=await y(e,a))||(console.log("[submitSearch] Input not found, waiting 1s..."),await e.waitForTimeout(1e3));if(!i)return console.log("[submitSearch] Input not found after 15s retry"),!1;console.log("[submitSearch] Found input, filling with:",n),await i.fill(n),await e.evaluate(()=>{let e=document.querySelector("#namn")||document.querySelector("#personOrgnummer")||document.querySelector('input[name*="namn"]')||document.querySelector('input[name*="org"]');e&&(e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),e.blur())}),await e.waitForTimeout(500),console.log("[submitSearch] Clicking search button...");let l=e.getByRole("button",{name:/Sök kungörelse/i}),s=!1;if(await l.count()){if(!await l.first().isEnabled()){console.log("[submitSearch] Button disabled, trying Enter key");try{await i.press("Enter")}catch{}return"disabled"}try{await l.first().click({timeout:5e3}),s=!0,console.log("[submitSearch] Button clicked successfully via Playwright")}catch(r){console.log("[submitSearch] Playwright click failed, trying JavaScript click...");let t=await e.evaluate(()=>{let e=Array.from(document.querySelectorAll("button")).find(e=>{let t=e.innerText||e.textContent||"";return t.includes("Sök kungörelse")||t.includes("Sök")});if(e)return e.click(),!0;let t=document.querySelector('button[type="submit"]');return!!t&&(t.click(),!0)});s=t,t&&console.log("[submitSearch] Button clicked via JavaScript")}}s||(console.log("[submitSearch] Trying fallback methods..."),await e.evaluate(()=>{let e=Array.from(document.querySelectorAll("button")).find(e=>(e.innerText||"").includes("Sök kungörelse"));e&&e.click()}));try{await i.press("Enter"),console.log("[submitSearch] Pressed Enter key as backup")}catch{}return!0}async function S(e,t,r){for(let a=0;a<10;a++){await e.waitForTimeout(1500),await d(e,t);let n=await e.evaluate(()=>{let e=document.body?.innerText||"",t=e.toLowerCase();return{noResults:t.includes("inga träffar")||t.includes("inga kungörelser")||t.includes("0 träffar"),hasTypeError:e.includes("TypeError"),hasLoading:e.includes("Laddar"),bodyText:e.slice(0,500)}});if(n.hasTypeError&&a<4&&r){console.log(`[collectResults] Angular TypeError detected (attempt ${a+1}), restarting from homepage...`),t({type:"status",message:`Angular-fel, startar om... (${a+1}/4)`});let n=3e3+2e3*a;console.log(`[collectResults] Waiting ${n}ms before retry...`),await e.waitForTimeout(n),await e.goto("https://poit.bolagsverket.se/poit-app/",{waitUntil:"load",timeout:A.navigationTimeout}).catch(()=>{}),await e.evaluate(()=>{let e=()=>{let e=window.Zone;if(e&&e.current){let t=e.current._zoneDelegate;if(t&&t.handleError&&!t._patchedHandleError){let e=t.handleError;t.handleError=function(t,r){let a=r?String(r.message||r):"";return a.includes("replaceAll")||a.includes("fixLink")||a.includes("Cannot read properties")?(console.warn("[Zone.js retry] Suppressed Angular error:",a),!0):e.call(this,t,r)},t._patchedHandleError=!0}}};e(),setTimeout(e,500)}),await e.waitForFunction(()=>{let e=document.body?.innerText||"";return(!!document.querySelector("app-root")||!!document.querySelector("[ng-version]"))&&e.length>300},{timeout:2e4}).catch(()=>console.log("[collectResults] Angular bootstrap timeout on homepage")),await e.waitForTimeout(3e3),await d(e,t),await e.goto("https://poit.bolagsverket.se/poit-app/sok",{waitUntil:"load",timeout:A.navigationTimeout}).catch(()=>{}),await e.evaluate(()=>{let e=window.Zone;if(e&&e.current&&e.current._zoneDelegate){let t=e.current._zoneDelegate;if(t.handleError&&!t._patchedHandleError){let e=t.handleError;t.handleError=function(t,r){let a=r?String(r.message||r):"";return!!(a.includes("replaceAll")||a.includes("fixLink")||a.includes("Cannot read properties"))||e.call(this,t,r)},t._patchedHandleError=!0}}}),await e.waitForTimeout(3e3),await d(e,t),await w(e),await x(e,r),await e.waitForTimeout(4e3);continue}if(n.noResults)return console.log("[collectResults] No results message found on page"),t({type:"status",message:"Sidan visar 'Inga träffar'"}),[];let o=await e.evaluate(()=>{let e=new Set,t=[],r=Array.from(document.querySelectorAll('a.kungorelse__link, a[href*="kungorelse/"]'));for(let a of(console.log("[collectResults] Found",r.length,"potential kungorelse links"),r)){let r=a.href||"",n=r.split("/").pop()?.split("?")[0]||"";if(!n||e.has(n))continue;e.add(n);let o=a.closest("tr")||a.closest("[role=row]")||a.closest("div"),i=[];o&&(i=Array.from(o.querySelectorAll("td")).map(e=>(e.innerText||"").trim()).filter(Boolean),0===i.length&&(i=Array.from(o.querySelectorAll('[role="cell"]')).map(e=>(e.innerText||"").trim()).filter(Boolean)),0===i.length&&o.innerText&&(i=o.innerText.split("\n").map(e=>e.trim()).filter(Boolean))),t.push({id:n,url:r,reporter:i[1]||"",type:i[2]||"",subject:i[3]||"",pubDate:i[4]||""})}return t});if(o.length>0)return console.log(`[collectResults] Found ${o.length} results`),o;let i=await e.evaluate(()=>{let e=document.body?.innerText||"",t=document.body?.innerHTML||"",r=!!document.querySelector("table"),a=t.includes("kungorelse"),n=document.querySelectorAll("a").length,o=window.location.href,i=Array.from(document.querySelectorAll("a")).filter(e=>e.href.includes("kungorelse")).map(e=>({href:e.href,text:(e.innerText||"").slice(0,50),className:e.className}));return{url:o,bodyLength:e.length,hasTable:r,hasResults:a,linkCount:n,kungorelseLinkCount:i.length,kungorelseLinks:i.slice(0,5),sample:e.slice(0,300)}});console.log(`[collectResults] Attempt ${a+1}: Page state:`,JSON.stringify(i,null,2)),0===a&&t({type:"status",message:`F\xf6rs\xf6ker hitta resultat (${i.kungorelseLinkCount} kung\xf6relse-l\xe4nkar av ${i.linkCount} totalt)`})}return console.log("[collectResults] No results found after retries"),[]}async function v(t,r,a={}){let n,{chromium:o}=e.r(378952),i={apiTimeout:a.apiTimeout||15e3,detailTimeout:a.detailTimeout||2e4,waitTextTimeout:a.waitTextTimeout||15e3,postGotoWait:a.postGotoWait||1500},l=!1;if(a.proxyUrl&&"disabled"!==a.proxyUrl)try{let e="browser"in t?t.browser():null;if(e){let r=await t.cookies();console.log(`[fetchDetailText] Copying ${r.length} cookies to proxy context`),n=await e.newContext({proxy:{server:a.proxyUrl,username:a.proxyUsername,password:a.proxyPassword},userAgent:"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",viewport:{width:1920,height:1080},locale:"sv-SE",timezoneId:"Europe/Stockholm",javaScriptEnabled:!0,ignoreHTTPSErrors:!0,extraHTTPHeaders:{"Accept-Language":"sv-SE,sv;q=0.9,en;q=0.8"}}),r.length>0&&await n.addCookies(r),l=!0,console.log(`[fetchDetailText] Using proxy: ${a.proxyUrl}`)}else n=t}catch(e){console.warn("[fetchDetailText] Failed to create context with proxy:",e),n=t}else n=t;let s=await n.newPage(),c=!1;await s.addInitScript(()=>{Object.defineProperty(navigator,"webdriver",{get:()=>void 0});let e=window.navigator.permissions.query;window.navigator.permissions.query=t=>"notifications"===t.name?Promise.resolve({state:Notification.permission}):e(t),Object.defineProperty(navigator,"plugins",{get:()=>[1,2,3,4,5]}),Object.defineProperty(navigator,"languages",{get:()=>["sv-SE","sv","en-US","en"]});let t=String.prototype.replaceAll;String.prototype.replaceAll=function(e,r){return this===null||void 0===this?"":t.call(this,e,r)},window.onerror=function(e){return!!(e&&(e.includes("Cannot read properties of undefined (reading 'replaceAll')")||e.includes("Cannot read properties of null")||e.includes("fixLink")||e.includes("is not a function")))},window.addEventListener("error",e=>{if(e.message&&(e.message.includes("Cannot read properties of undefined (reading 'replaceAll')")||e.message.includes("Cannot read properties of null")||e.message.includes("fixLink")))return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!0},!0),window.addEventListener("unhandledrejection",e=>{let t=e.reason?String(e.reason):"";(t.includes("replaceAll")||t.includes("fixLink")||t.includes("Cannot read properties"))&&e.preventDefault()});let r=()=>{let e=window.Zone;if(e&&e.current&&e.current._zoneDelegate){let t=e.current._zoneDelegate;if(t.handleError&&!t._patchedHandleError){let e=t.handleError;t.handleError=function(t,r){let a=r?String(r.message||r):"";return!!(a.includes("replaceAll")||a.includes("fixLink")||a.includes("Cannot read properties"))||e.call(this,t,r)},t._patchedHandleError=!0}}};r(),setTimeout(r,1e3),setTimeout(r,3e3)});try{s.on("response",e=>{429===e.status()&&e.url().includes("/poit/rest/")&&(c=!0,console.log(`[fetchDetailText] Got 429 for ${r.id}`))});let e="",t=s.waitForResponse(e=>e.url().includes("/poit/rest/SokKungorelse?kungorelseid=")&&200===e.status(),{timeout:i.apiTimeout}).catch(()=>null),a=s.waitForResponse(e=>e.url().includes("/poit/rest/HamtaKungorelse?")&&200===e.status(),{timeout:i.detailTimeout}).catch(()=>null);await s.setExtraHTTPHeaders({Referer:"https://poit.bolagsverket.se/poit-app/sok"}),console.log(`[fetchDetailText] Initializing Angular via homepage for ${r.id}`),await s.goto("https://poit.bolagsverket.se/poit-app/",{waitUntil:"load",timeout:2e4}),await m(s),await s.waitForFunction(()=>!!document.querySelector("app-root")||!!document.querySelector("[ng-version]"),{timeout:1e4}).catch(()=>{console.log(`[fetchDetailText] Angular bootstrap timeout on homepage for ${r.id}`)}),console.log(`[fetchDetailText] Navigating to ${r.url}`),await s.goto(r.url,{waitUntil:"load",timeout:3e4}),await m(s);let n=await s.url();n.includes("/kungorelse/")||n.includes("/enskild/")||(console.log(`[fetchDetailText] Re-navigating to ${r.url} (was on ${n})`),await s.goto(r.url,{waitUntil:"load",timeout:3e4}),await m(s),await s.waitForTimeout(2e3)),await s.waitForFunction(()=>{let e=document.body?.innerText||"",t=!!document.querySelector("app-root")||!!document.querySelector("[ng-version]"),r=e.includes("Kungörelsetext")||e.includes("kungörelse")||e.includes("Bolagsverket")||e.includes("enskild")||e.includes("Organisationsnummer")||e.length>300;return t&&r},{timeout:2e4}).catch(()=>{console.log(`[fetchDetailText] Angular content wait timeout for ${r.id}`)}),await s.waitForTimeout(i.postGotoWait);let o=await s.evaluate(()=>{let e=document.body?.innerText||"";return{bodyLength:e.length,hasKungorelsetext:e.includes("Kungörelsetext"),url:window.location.href,preview:e.substring(0,300).replace(/\s+/g," "),hasAngular:!!document.querySelector("app-root")||!!document.querySelector("[ng-version]")}}).catch(()=>({bodyLength:0,hasKungorelsetext:!1,url:"",preview:"",hasAngular:!1}));if(console.log(`[fetchDetailText] Page state for ${r.id}:`,JSON.stringify(o)),await s.waitForFunction(()=>(document.body?.innerText||"").includes("Kungörelsetext"),{timeout:i.waitTextTimeout}).catch(()=>{}),!await s.evaluate(()=>(document.body?.innerText||"").includes("Kungörelsetext"))){await s.waitForTimeout(3e3);let e=await s.evaluate(()=>Array.from(document.querySelectorAll("a")).slice(0,10).map(e=>({text:e.textContent?.trim().substring(0,50),href:e.href?.substring(0,80)}))).catch(()=>[]);console.log(`[fetchDetailText] Links on page for ${r.id}:`,JSON.stringify(e));let t=!1,a=s.getByRole("link",{name:/^Visa\s/});if(await a.count()>0&&(console.log(`[fetchDetailText] Clicking "Visa" link (by role) for ${r.id}`),await a.first().click().catch(e=>console.log(`[fetchDetailText] Click failed: ${e.message}`)),t=!0),!t){let e=s.getByText(/^Visa\s+K\d+/);await e.count()>0&&(console.log(`[fetchDetailText] Clicking "Visa" link (by text) for ${r.id}`),await e.first().click().catch(e=>console.log(`[fetchDetailText] Click failed: ${e.message}`)),t=!0)}if(!t){let e=s.locator('a[href*="/poit-app/kungorelse/"]').first();if(await e.count()>0){let a=await e.getAttribute("href");console.log(`[fetchDetailText] Clicking kungorelse link for ${r.id}: ${a}`),await e.click().catch(e=>console.log(`[fetchDetailText] Click failed: ${e.message}`)),t=!0,await s.waitForTimeout(2e3)}}if(t){await s.waitForFunction(()=>{let e=document.body?.innerText||"";return e.includes("Kungörelsetext")||e.length>1e3},{timeout:2e4}).catch(()=>{});let e=await s.evaluate(()=>{let e=document.body?.innerText||"";return{bodyLength:e.length,hasKungorelsetext:e.includes("Kungörelsetext"),url:window.location.href,preview:e.substring(0,200).replace(/\s+/g," ")}}).catch(()=>({bodyLength:0,hasKungorelsetext:!1,url:"",preview:""}));console.log(`[fetchDetailText] After navigation for ${r.id}:`,JSON.stringify(e))}else console.log(`[fetchDetailText] No kungorelse link found for ${r.id}`)}let l=await t;if(l)try{let t=await l.json();e=b(t)}catch{}if(!e){let t=await a;if(t)try{let r=await t.json();e=b(r)}catch{}}if(e)return{text:e,got429:c};return{text:await s.evaluate(()=>{let e=document.body?.innerText||"";if(!e)return"";let t=e.split("\n").map(e=>e.trim()).filter(Boolean),r=t.findIndex(e=>/kungörelsetext/i.test(e));if(r>=0){let e=t.findIndex((e,t)=>t>r&&/tillbaka|skriv ut/i.test(e));return e<0&&(e=t.length),t.slice(r+1,e).join("\n").trim()}let a=t.findIndex(e=>/organisationsnummer|org\.?\s*nr/i.test(e));if(a>=0){let e=t.findIndex((e,t)=>t>a&&/tillbaka|skriv ut|stäng/i.test(e));return e<0&&(e=Math.min(a+20,t.length)),t.slice(a,e).join("\n").trim()}let n=t.findIndex(e=>e.length>50);return n>=0?t.slice(n,Math.min(n+15,t.length)).join("\n").trim():""}),got429:c}}finally{await s.close(),l&&n!==t&&await n.close().catch(()=>{})}}function b(e){if(!e)return"";let t=[];return(!function e(r,a){if(r){if("string"==typeof r){let e=/text|kungorelse/i.test(a),n=/org\s*nr|företagsnamn|kungörelsetext/i.test(r);(e||n)&&r.length>20&&t.push(r);return}if(Array.isArray(r)){for(let t of r)e(t,a);return}if("object"==typeof r&&null!==r)for(let[t,n]of Object.entries(r))e(n,`${a}.${t}`)}}(e,"root"),0===t.length)?"":(t.sort((e,t)=>t.length-e.length),t[0].trim())}async function k(t,r,a){let{prisma:n}=await e.A(606844),o=0;for(let e of a)try{var i;await n.announcement.upsert({where:{id:e.id},create:{id:e.id,query:t,reporter:e.reporter||null,type:e.type||null,subject:e.subject,pubDate:e.pubDate||null,publishedAt:e.pubDate&&(i=e.pubDate)&&i.match(/(\d{4})-(\d{2})-(\d{2})/)?new Date(i):null,detailText:e.detailText||null,fullText:e.fullText||null,url:e.url,orgNumber:r?.replace(/-/g,"")||null,scrapedAt:new Date},update:{detailText:e.detailText||void 0,fullText:e.fullText||void 0,updatedAt:new Date}}),o++}catch(t){console.error(`Failed to save announcement ${e.id}:`,t)}return o}e.s(["POST",()=>u]),r()}catch(e){r(e)}},!1),402295,e=>e.a(async(t,r)=>{try{var a=e.i(594236),n=e.i(731205),o=e.i(299044),i=e.i(789986),l=e.i(372874),s=e.i(96846),c=e.i(887304),u=e.i(879328),d=e.i(361547),p=e.i(70569),m=e.i(143981),g=e.i(443147),h=e.i(773331),f=e.i(716859),w=e.i(13751),y=e.i(193695);e.i(882560);var x=e.i(851855),S=e.i(191039),v=t([S]);[S]=v.then?(await v)():v;let T=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/kungorelser/search/stream/route",pathname:"/api/kungorelser/search/stream",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/CLAUDE/projects/1. Loop Desk/src/app/api/kungorelser/search/stream/route.ts",nextConfigOutput:"standalone",userland:S}),{workAsyncStorage:A,workUnitAsyncStorage:E,serverHooks:R}=T;function b(){return(0,o.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:E})}async function k(e,t,r){T.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/kungorelser/search/stream/route";a=a.replace(/\/index$/,"")||"/";let o=await T.prepare(e,t,{srcPage:a,multiZoneDraftMode:!1});if(!o)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:S,params:v,nextConfig:b,parsedUrl:k,isDraftMode:A,prerenderManifest:E,routerServerContext:R,isOnDemandRevalidate:C,revalidateOnlyGenerated:P,resolvedPathname:$,clientReferenceManifest:q,serverActionsManifest:F}=o,D=(0,c.normalizeAppPath)(a),O=!!(E.dynamicRoutes[D]||E.routes[$]),L=async()=>((null==R?void 0:R.render404)?await R.render404(e,t,k,!1):t.end("This page could not be found"),null);if(O&&!A){let e=!!E.routes[$],t=E.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(b.experimental.adapterPath)return await L();throw new y.NoFallbackError}}let _=null;!O||T.isDev||A||(_=$,_="/index"===_?"/":_);let I=!0===T.isDev||!O,j=O&&!I;F&&q&&(0,s.setManifestsSingleton)({page:a,clientReferenceManifest:q,serverActionsManifest:F});let N=e.method||"GET",U=(0,l.getTracer)(),H=U.getActiveScopeSpan(),M={params:v,prerenderManifest:E,renderOpts:{experimental:{authInterrupts:!!b.experimental.authInterrupts},cacheComponents:!!b.cacheComponents,supportsDynamicResponse:I,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:b.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,n)=>T.onRequestError(e,t,a,n,R)},sharedContext:{buildId:S}},K=new u.NodeNextRequest(e),B=new u.NodeNextResponse(t),W=d.NextRequestAdapter.fromNodeNextRequest(K,(0,d.signalFromNodeResponse)(t));try{let o=async e=>T.handle(W,M).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=U.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${N} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${N} ${a}`)}),s=!!(0,i.getRequestMeta)(e,"minimalMode"),c=async i=>{var l,c;let u=async({previousCacheEntry:n})=>{try{if(!s&&C&&P&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await o(i);e.fetchMetrics=M.renderOpts.fetchMetrics;let l=M.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let c=M.renderOpts.collectedTags;if(!O)return await (0,g.sendResponse)(K,B,a,M.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(a.headers);c&&(t[w.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,n=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:x.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==n?void 0:n.isStale)&&await T.onRequestError(e,t,{routerKind:"App Router",routePath:a,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:C})},!1,R),t}},d=await T.handleResponse({req:e,nextConfig:b,cacheKey:_,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:E,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:P,responseGenerator:u,waitUntil:r.waitUntil,isMinimalMode:s});if(!O)return null;if((null==d||null==(l=d.value)?void 0:l.kind)!==x.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(c=d.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",C?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,h.fromNodeOutgoingHttpHeaders)(d.value.headers);return s&&O||p.delete(w.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,f.getCacheControlHeader)(d.cacheControl)),await (0,g.sendResponse)(K,B,new Response(d.value.body,{headers:p,status:d.value.status||200})),null};H?await c(H):await U.withPropagatedContext(e.headers,()=>U.trace(p.BaseServerSpan.handleRequest,{spanName:`${N} ${a}`,kind:l.SpanKind.SERVER,attributes:{"http.method":N,"http.target":e.url}},c))}catch(t){if(t instanceof y.NoFallbackError||await T.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:C})},!1,R),O)throw t;return await (0,g.sendResponse)(K,B,new Response(null,{status:500})),null}}e.s(["handler",()=>k,"patchFetch",()=>b,"routeModule",()=>T,"serverHooks",()=>R,"workAsyncStorage",()=>A,"workUnitAsyncStorage",()=>E]),r()}catch(e){r(e)}},!1)];

//# debugId=4b47effa-1a89-4954-d987-c28d4de32c40
//# sourceMappingURL=%5Broot-of-the-server%5D__4c1f3416._.js.map