{
  "version": 3,
  "sources": [],
  "debugId": "799c85ec-fdc1-e622-a18e-434c07b6de20",
  "sections": [
    {"offset": {"line": 1, "column": 0}, "map": {"version":3,"sources":["../../../../../../CLAUDE/projects/LoopDesk/src/lib/rate-limit-helper.ts","../../../../../../CLAUDE/projects/LoopDesk/src/lib/rate-limiter.ts","../../../../../../CLAUDE/projects/LoopDesk/src/app/api/kungorelser/search/stream/route.ts","../../../../../../CLAUDE/projects/LoopDesk/node_modules/next/src/build/templates/app-route.ts"],"sourcesContent":["/**\n * Rate limit helper for Next.js API routes\n */\n\nimport { NextRequest, NextResponse } from 'next/server';\nimport { rateLimiter, RATE_LIMITS } from './rate-limiter';\nimport type { Session } from 'next-auth';\n\n/**\n * Get identifier for rate limiting (user ID or IP)\n */\nexport function getRateLimitIdentifier(request: NextRequest, session?: Session | null): string {\n  // Prefer user ID if authenticated\n  if (session?.user?.id) {\n    return `user:${session.user.id}`;\n  }\n\n  // Fallback to IP address\n  const forwarded = request.headers.get('x-forwarded-for');\n  const ip = forwarded ? forwarded.split(',')[0].trim() :\n             request.headers.get('x-real-ip') ||\n             'unknown';\n\n  return `ip:${ip}`;\n}\n\n/**\n * Check rate limit and return error response if exceeded\n */\nexport function checkRateLimit(\n  identifier: string,\n  limitType: keyof typeof RATE_LIMITS\n): { allowed: boolean; response?: NextResponse } {\n  const config = RATE_LIMITS[limitType];\n  const { allowed, remaining, resetAt } = rateLimiter.check(identifier, config);\n\n  if (!allowed) {\n    return {\n      allowed: false,\n      response: NextResponse.json(\n        {\n          error: 'Too many requests',\n          message: `Rate limit exceeded. Try again after ${resetAt.toISOString()}`,\n          retryAfter: Math.ceil((resetAt.getTime() - Date.now()) / 1000),\n        },\n        {\n          status: 429,\n          headers: {\n            'Retry-After': String(Math.ceil((resetAt.getTime() - Date.now()) / 1000)),\n            'X-RateLimit-Limit': String(config.maxRequests),\n            'X-RateLimit-Remaining': '0',\n            'X-RateLimit-Reset': resetAt.toISOString(),\n          },\n        }\n      ),\n    };\n  }\n\n  return { allowed: true };\n}\n\n/**\n * Add rate limit headers to response\n */\nexport function addRateLimitHeaders(\n  response: NextResponse,\n  identifier: string,\n  limitType: keyof typeof RATE_LIMITS\n): NextResponse {\n  const config = RATE_LIMITS[limitType];\n  const { remaining, resetAt } = rateLimiter.check(identifier, config);\n\n  response.headers.set('X-RateLimit-Limit', String(config.maxRequests));\n  response.headers.set('X-RateLimit-Remaining', String(remaining));\n  response.headers.set('X-RateLimit-Reset', resetAt.toISOString());\n\n  return response;\n}\n","/**\n * Simple in-memory rate limiter for API routes\n *\n * Uses sliding window algorithm to track requests per IP/user\n * For production with multiple Railway instances, consider Redis-based rate limiting\n */\n\ninterface RateLimitConfig {\n  maxRequests: number;\n  windowMs: number;\n}\n\ninterface RequestLog {\n  timestamps: number[];\n}\n\nclass RateLimiter {\n  private requests = new Map<string, RequestLog>();\n  private cleanupInterval: NodeJS.Timeout;\n\n  constructor() {\n    // Clean up old entries every 5 minutes\n    this.cleanupInterval = setInterval(() => {\n      this.cleanup();\n    }, 5 * 60 * 1000);\n  }\n\n  /**\n   * Check if request is allowed\n   * @returns { allowed: boolean, remaining: number, resetAt: Date }\n   */\n  check(\n    identifier: string,\n    config: RateLimitConfig\n  ): { allowed: boolean; remaining: number; resetAt: Date } {\n    const now = Date.now();\n    const windowStart = now - config.windowMs;\n\n    // Get or create request log\n    let log = this.requests.get(identifier);\n    if (!log) {\n      log = { timestamps: [] };\n      this.requests.set(identifier, log);\n    }\n\n    // Filter out timestamps outside the window\n    log.timestamps = log.timestamps.filter(t => t > windowStart);\n\n    // Check if limit exceeded\n    const allowed = log.timestamps.length < config.maxRequests;\n\n    if (allowed) {\n      // Add current request\n      log.timestamps.push(now);\n    }\n\n    // Calculate remaining requests\n    const remaining = Math.max(0, config.maxRequests - log.timestamps.length);\n\n    // Calculate when the window resets\n    const oldestTimestamp = log.timestamps[0] || now;\n    const resetAt = new Date(oldestTimestamp + config.windowMs);\n\n    return { allowed, remaining, resetAt };\n  }\n\n  /**\n   * Clean up old entries to prevent memory leaks\n   */\n  private cleanup(): void {\n    const now = Date.now();\n    const maxAge = 60 * 60 * 1000; // 1 hour\n\n    for (const [key, log] of this.requests.entries()) {\n      // Remove if no recent requests\n      if (log.timestamps.length === 0 || log.timestamps[log.timestamps.length - 1] < now - maxAge) {\n        this.requests.delete(key);\n      }\n    }\n\n    console.log(`[RateLimiter] Cleanup: ${this.requests.size} active identifiers`);\n  }\n\n  /**\n   * Reset rate limit for an identifier\n   */\n  reset(identifier: string): void {\n    this.requests.delete(identifier);\n  }\n\n  /**\n   * Get current stats\n   */\n  getStats(): { activeIdentifiers: number; totalRequests: number } {\n    let totalRequests = 0;\n    for (const log of this.requests.values()) {\n      totalRequests += log.timestamps.length;\n    }\n    return {\n      activeIdentifiers: this.requests.size,\n      totalRequests,\n    };\n  }\n\n  /**\n   * Cleanup on shutdown\n   */\n  destroy(): void {\n    if (this.cleanupInterval) {\n      clearInterval(this.cleanupInterval);\n    }\n  }\n}\n\n// Singleton instance\nexport const rateLimiter = new RateLimiter();\n\n// Rate limit configurations\nexport const RATE_LIMITS = {\n  // General API endpoints\n  api: {\n    maxRequests: 100,\n    windowMs: 60 * 1000, // 100 requests per minute\n  },\n  // Scraping endpoints (expensive)\n  scraping: {\n    maxRequests: 10,\n    windowMs: 60 * 1000, // 10 searches per minute\n  },\n  // Auth endpoints (sensitive)\n  auth: {\n    maxRequests: 5,\n    windowMs: 60 * 1000, // 5 login attempts per minute\n  },\n  // Heavy endpoints (database intensive)\n  heavy: {\n    maxRequests: 20,\n    windowMs: 60 * 1000, // 20 requests per minute\n  },\n} as const;\n\n/**\n * Create rate limit middleware\n */\nexport function createRateLimitMiddleware(config: RateLimitConfig) {\n  return (identifier: string): { allowed: boolean; remaining: number; resetAt: Date } => {\n    return rateLimiter.check(identifier, config);\n  };\n}\n","import { NextRequest } from \"next/server\";\nimport { auth } from \"@/auth\";\nimport { getRateLimitIdentifier, checkRateLimit } from \"@/lib/rate-limit-helper\";\nimport { proxyManager } from \"@/lib/kungorelser/proxy-manager\";\nimport type { BrowserContext, Page } from \"playwright\";\nimport { existsSync, readdirSync } from \"fs\";\nimport { join } from \"path\";\n\n// Find Chromium/Chrome executable path for playwright-core\nfunction findChromiumPath(): string | undefined {\n  const browsersPath = process.env.PLAYWRIGHT_BROWSERS_PATH || \"/ms-playwright\";\n\n  try {\n    const dirs = readdirSync(browsersPath);\n    console.log(\"[StreamScraper] Available browser directories:\", dirs.join(\", \"));\n\n    // Priority 1: Google Chrome (best compatibility with dynamic sites)\n    for (const dir of dirs) {\n      if (dir.startsWith(\"chrome-\")) {\n        const chromePath = join(browsersPath, dir, \"chrome-linux\", \"chrome\");\n        if (existsSync(chromePath)) {\n          console.log(\"[StreamScraper] Found Google Chrome at:\", chromePath);\n          return chromePath;\n        }\n      }\n    }\n\n    // Priority 2: Full Chromium (preferred over headless shell)\n    for (const dir of dirs) {\n      if (dir.startsWith(\"chromium-\") && !dir.includes(\"headless\")) {\n        const chromePath = join(browsersPath, dir, \"chrome-linux\", \"chrome\");\n        if (existsSync(chromePath)) {\n          console.log(\"[StreamScraper] Found full Chromium at:\", chromePath);\n          return chromePath;\n        }\n      }\n    }\n\n    // Priority 3: Chromium with different path structure (newer Playwright)\n    for (const dir of dirs) {\n      if (dir.startsWith(\"chromium\") && !dir.includes(\"headless\")) {\n        // Try different possible paths\n        const paths = [\n          join(browsersPath, dir, \"chrome-linux\", \"chrome\"),\n          join(browsersPath, dir, \"chrome\"),\n          join(browsersPath, dir, \"chromium\"),\n        ];\n        for (const p of paths) {\n          if (existsSync(p)) {\n            console.log(\"[StreamScraper] Found Chromium at:\", p);\n            return p;\n          }\n        }\n      }\n    }\n\n    // Fallback: headless shell (last resort - may not work with Angular apps)\n    for (const dir of dirs) {\n      if (dir.startsWith(\"chromium_headless_shell-\")) {\n        const headlessPath = join(browsersPath, dir, \"chrome-headless-shell-linux64\", \"chrome-headless-shell\");\n        if (existsSync(headlessPath)) {\n          console.log(\"[StreamScraper] WARNING: Using headless shell (may not work with Angular apps):\", headlessPath);\n          return headlessPath;\n        }\n      }\n    }\n  } catch (e) {\n    console.warn(\"[StreamScraper] Could not search for Chromium:\", e);\n  }\n\n  console.log(\"[StreamScraper] No browser found, will try system default\");\n  return undefined;\n}\n\nconst START_URL = \"https://poit.bolagsverket.se/poit-app/sok\";\n\n// NOTE: Env vars are read inside functions to avoid stale values in serverless environments\n\n// Scraper configuration\nconst SCRAPER_CONFIG = {\n  // Timeout for navigation (ms) - increased to handle slow Bolagsverket pages\n  navigationTimeout: parseInt(process.env.SCRAPER_NAVIGATION_TIMEOUT || '90000', 10),\n};\n\n/**\n * Debug helper: capture page state for error diagnosis\n */\nasync function captureDebugInfo(page: Page, context: string): Promise<void> {\n  try {\n    const info = await page.evaluate(() => {\n      const body = document.body?.innerText || \"\";\n      const html = document.body?.innerHTML || \"\";\n\n      // Get all visible inputs\n      const inputs = Array.from(document.querySelectorAll(\"input\")).map(el => ({\n        id: el.id,\n        name: el.name,\n        type: el.type,\n        placeholder: el.placeholder,\n        visible: el.offsetParent !== null,\n        formcontrolname: el.getAttribute(\"formcontrolname\"),\n      }));\n\n      // Get all buttons\n      const buttons = Array.from(document.querySelectorAll(\"button\")).map(el => ({\n        text: (el.innerText || \"\").slice(0, 50),\n        disabled: el.disabled,\n        visible: el.offsetParent !== null,\n      }));\n\n      // Check for Angular app state\n      const hasNgApp = !!document.querySelector(\"[ng-version]\") || !!document.querySelector(\"app-root\");\n      const hasAngularError = body.includes(\"TypeError\") || body.includes(\"Cannot read\") || body.includes(\"undefined\");\n\n      return {\n        url: window.location.href,\n        title: document.title,\n        bodyLength: body.length,\n        htmlLength: html.length,\n        inputCount: inputs.length,\n        visibleInputs: inputs.filter(i => i.visible),\n        buttons: buttons.filter(b => b.visible).slice(0, 5),\n        hasNgApp,\n        hasAngularError,\n        has403: body.includes(\"403\") || body.includes(\"Forbidden\"),\n        hasBlocker: body.includes(\"human visitor\") || !!document.querySelector(\"#ans\"),\n        textPreview: body.slice(0, 800),\n      };\n    });\n\n    console.log(`[DEBUG ${context}] Page state:`, JSON.stringify(info, null, 2));\n  } catch (err) {\n    console.log(`[DEBUG ${context}] Failed to capture page state:`, err);\n  }\n}\n\ninterface ScrapedResult {\n  id: string;\n  url: string;\n  reporter: string;\n  type: string;\n  subject: string;\n  pubDate: string;\n  detailText?: string;\n  fullText?: string;\n}\n\ntype ProgressCallback = (event: {\n  type: \"status\" | \"captcha\" | \"search\" | \"result\" | \"detail\" | \"success\" | \"error\" | \"complete\";\n  message: string;\n  data?: Record<string, unknown>;\n}) => void;\n\n/**\n * POST /api/kungorelser/search/stream\n * Streaming search with real-time progress updates\n */\nexport async function POST(request: NextRequest) {\n  const session = await auth();\n  if (!session?.user?.id) {\n    return new Response(JSON.stringify({ error: \"Unauthorized\" }), {\n      status: 401,\n      headers: { \"Content-Type\": \"application/json\" },\n    });\n  }\n\n  // Check rate limit (10 searches per minute)\n  const identifier = getRateLimitIdentifier(request, session);\n  const rateLimitCheck = checkRateLimit(identifier, 'scraping');\n  if (!rateLimitCheck.allowed) {\n    return rateLimitCheck.response!;\n  }\n\n  const body = await request.json();\n  const { query, orgNumber, skipDetails = false, detailLimit = 5 } = body;\n\n  if (!query || typeof query !== \"string\" || query.trim().length < 2) {\n    return new Response(JSON.stringify({ error: \"Query must be at least 2 characters\" }), {\n      status: 400,\n      headers: { \"Content-Type\": \"application/json\" },\n    });\n  }\n\n  const encoder = new TextEncoder();\n\n  const stream = new ReadableStream({\n    async start(controller) {\n      const sendEvent: ProgressCallback = (event) => {\n        controller.enqueue(encoder.encode(`data: ${JSON.stringify(event)}\\n\\n`));\n      };\n\n      try {\n        sendEvent({ type: \"status\", message: \"Startar webbläsare...\" });\n\n        // Read env vars fresh (avoid stale values in serverless)\n        const TWOCAPTCHA_API_KEY = process.env.TWOCAPTCHA_API_KEY || \"\";\n        const PROXY_SERVER = process.env.PROXY_SERVER || \"\";\n        const PROXY_USERNAME = process.env.PROXY_USERNAME || \"\";\n        const PROXY_PASSWORD = process.env.PROXY_PASSWORD || \"\";\n\n        // Ensure proxies are fresh before starting\n        try {\n          const { forceRefreshProxies } = await import(\"@/lib/kungorelser/proxy-init\");\n          await forceRefreshProxies();\n        } catch (err) {\n          console.warn(\"[StreamScraper] Failed to refresh proxies:\", err);\n        }\n\n        // Dynamic import for serverless\n        // eslint-disable-next-line @typescript-eslint/no-require-imports\n        const { chromium } = require(\"playwright\") as typeof import(\"playwright\");\n\n        // Build proxy config from env vars (prefer static config over proxyManager)\n        let proxyConfig: { server: string; username?: string; password?: string } | undefined;\n\n        if (PROXY_SERVER && PROXY_SERVER !== \"disabled\") {\n          proxyConfig = {\n            server: PROXY_SERVER,\n            username: PROXY_USERNAME || undefined,\n            password: PROXY_PASSWORD || undefined,\n          };\n          console.log(`[StreamScraper] Using static proxy from env: ${PROXY_SERVER}`);\n        } else {\n          // Fallback to proxy manager\n          await proxyManager.activate(\"stream-init\");\n          proxyConfig = proxyManager.getPlaywrightConfig().proxy;\n        }\n\n        if (proxyConfig) {\n          console.log(`[Proxy] Using proxy server: ${proxyConfig.server}`);\n          if (!proxyConfig.username) {\n            console.warn(\"[Proxy] Username missing - proxy auth may fail\");\n          }\n          sendEvent({ type: \"status\", message: \"Ansluter via proxy...\" });\n        } else {\n          console.log(\"[Proxy] No proxy configured, using direct connection\");\n        }\n\n        // Try playwright's default browser first, fall back to custom path\n        let browser;\n        try {\n          console.log(\"[StreamScraper] Trying playwright default browser...\");\n          browser = await chromium.launch({\n            headless: true,\n            args: [\n              \"--no-sandbox\",\n              \"--disable-setuid-sandbox\",\n              \"--disable-blink-features=AutomationControlled\",\n              \"--disable-dev-shm-usage\",\n              \"--disable-infobars\",\n              \"--window-size=1920,1080\",\n              \"--disable-extensions\",\n              \"--disable-plugins-discovery\",\n              \"--disable-bundled-ppapi-flash\",\n            ],\n            proxy: proxyConfig,\n          });\n          console.log(\"[StreamScraper] Using playwright default browser\");\n        } catch {\n          const executablePath = findChromiumPath();\n          console.log(\"[StreamScraper] Default failed, using custom path:\", executablePath || \"none\");\n          browser = await chromium.launch({\n            headless: true,\n            executablePath,\n            args: [\n              \"--no-sandbox\",\n              \"--disable-setuid-sandbox\",\n              \"--disable-blink-features=AutomationControlled\",\n              \"--disable-dev-shm-usage\",\n              \"--disable-infobars\",\n              \"--window-size=1920,1080\",\n              \"--disable-extensions\",\n              \"--disable-plugins-discovery\",\n              \"--disable-bundled-ppapi-flash\",\n            ],\n            proxy: proxyConfig,\n          });\n        }\n\n        sendEvent({ type: \"status\", message: \"Öppnar Bolagsverkets POIT...\" });\n\n        // Context with anti-detection settings\n        const context = await browser.newContext({\n          userAgent: \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n          viewport: { width: 1920, height: 1080 },\n          locale: \"sv-SE\",\n          timezoneId: \"Europe/Stockholm\",\n          permissions: [\"geolocation\"],\n          javaScriptEnabled: true,\n          ignoreHTTPSErrors: true,\n          extraHTTPHeaders: {\n            \"Accept-Language\": \"sv-SE,sv;q=0.9,en;q=0.8\",\n          },\n        });\n        const page = await context.newPage();\n\n        // CRITICAL: Intercept Angular bundle and patch multiple bugs\n        // 1. fixLink calls replaceAll on undefined, crashing Angular\n        // 2. URL stringify throws \"Missing required param\" when kungorelseid is undefined\n        await page.route('**/assets/index-*.js', async (route) => {\n          console.log('[StreamScraper] Intercepting Angular bundle:', route.request().url());\n          try {\n            const response = await route.fetch();\n            let body = await response.text();\n            const originalLength = body.length;\n            let patchCount = 0;\n\n            // Patch 1: fixLink to safely handle undefined values\n            // ACTUAL code: fixLink:function(e){return e.replaceAll(\"/\",\"-\")}\n            const beforeFixLink = body.length;\n            body = body.replace(\n              /fixLink:function\\((\\w)\\)\\{return \\1\\.replaceAll/g,\n              'fixLink:function($1){if($1==null)return\"\";return $1.replaceAll'\n            );\n            if (body.length !== beforeFixLink) patchCount++;\n\n            // Patch 2: URL parameter stringify - prevent \"Missing required param\" errors\n            // The error comes from validation that throws when a required param is null/undefined\n            // Pattern: throw new Error('Missing required param \"'+e+'\"')\n            const beforeThrow = body.length;\n            body = body.replace(\n              /throw new Error\\('Missing required param \"'\\+(\\w)\\+'\"\\)/g,\n              'console.warn(\"[Patched] Missing param:\",\\$1);return\"\"'\n            );\n            if (body.length !== beforeThrow) patchCount++;\n\n            // Patch 3: Alternative pattern - some builds use template literals\n            const beforeTemplate = body.length;\n            body = body.replace(\n              /throw new Error\\(`Missing required param \"\\$\\{(\\w)\\}\"`\\)/g,\n              'console.warn(\"[Patched] Missing param:\",\\$1);return\"\"'\n            );\n            if (body.length !== beforeTemplate) patchCount++;\n\n            // Patch 4: Handle the URL resolver that passes undefined to stringify\n            // Pattern: function that builds kungorelseid URLs\n            const beforeResolver = body.length;\n            body = body.replace(\n              /kungorelseid:(\\w)\\.id/g,\n              'kungorelseid:$1&&$1.id||\"0\"'\n            );\n            if (body.length !== beforeResolver) patchCount++;\n\n            console.log(`[StreamScraper] Angular bundle patches: ${patchCount} applied (${originalLength} -> ${body.length})`);\n\n            await route.fulfill({\n              response,\n              body,\n              headers: {\n                ...response.headers(),\n                'Content-Length': String(body.length),\n              },\n            });\n          } catch (err) {\n            console.warn('[StreamScraper] Failed to patch Angular bundle, continuing with original:', err);\n            await route.continue();\n          }\n        });\n\n        // Anti-detection: Override navigator.webdriver and other detection vectors\n        await page.addInitScript(() => {\n          // Remove webdriver property\n          Object.defineProperty(navigator, 'webdriver', { get: () => undefined });\n\n          // Override permissions query\n          const originalQuery = window.navigator.permissions.query;\n          window.navigator.permissions.query = (parameters: PermissionDescriptor) =>\n            parameters.name === 'notifications'\n              ? Promise.resolve({ state: Notification.permission } as PermissionStatus)\n              : originalQuery(parameters);\n\n          // Add plugins array\n          Object.defineProperty(navigator, 'plugins', {\n            get: () => [1, 2, 3, 4, 5],\n          });\n\n          // Add languages\n          Object.defineProperty(navigator, 'languages', {\n            get: () => ['sv-SE', 'sv', 'en-US', 'en'],\n          });\n\n          // === AGGRESSIVE ANGULAR ERROR SUPPRESSION ===\n          // The Angular fixLink bug occurs when calling replaceAll on undefined\n          // We need to catch errors at multiple levels to prevent crashes\n\n          // 1. Patch String.prototype.replaceAll to handle undefined 'this'\n          const originalReplaceAll = String.prototype.replaceAll;\n          (String.prototype as any).replaceAll = function(searchValue: any, replaceValue: any) {\n            if (this === null || this === undefined) {\n              console.warn('[Patched] replaceAll called on null/undefined, returning empty string');\n              return '';\n            }\n            return originalReplaceAll.call(this, searchValue, replaceValue);\n          };\n\n          // 2. Global window.onerror - catches errors before they propagate\n          // Return true to prevent the error from being reported to console\n          (window as any).onerror = function(message: string, source: string, lineno: number, colno: number, error: Error) {\n            if (message && (\n              message.includes(\"Cannot read properties of undefined (reading 'replaceAll')\") ||\n              message.includes(\"Cannot read properties of null\") ||\n              message.includes(\"Missing required param\") ||\n              message.includes(\"kungorelseid\") ||\n              message.includes(\"fixLink\") ||\n              message.includes(\"is not a function\")\n            )) {\n              console.warn('[window.onerror] Suppressed Angular error:', message);\n              return true; // Suppress the error\n            }\n            return false;\n          };\n\n          // 3. Error event listener (capture phase) - catches errors that bypass onerror\n          window.addEventListener('error', (event) => {\n            if (event.message && (\n              event.message.includes(\"Cannot read properties of undefined (reading 'replaceAll')\") ||\n              event.message.includes(\"Cannot read properties of null\") ||\n              event.message.includes(\"Missing required param\") ||\n              event.message.includes(\"kungorelseid\") ||\n              event.message.includes(\"fixLink\")\n            )) {\n              console.warn('[error listener] Suppressed Angular error:', event.message);\n              event.preventDefault();\n              event.stopPropagation();\n              event.stopImmediatePropagation();\n              return true;\n            }\n          }, true);\n\n          // 4. Unhandled promise rejection handler\n          window.addEventListener('unhandledrejection', (event) => {\n            const reason = event.reason ? String(event.reason) : '';\n            if (reason.includes('replaceAll') || reason.includes('fixLink') ||\n                reason.includes('Cannot read properties') || reason.includes('Missing required param') ||\n                reason.includes('kungorelseid')) {\n              console.warn('[unhandledrejection] Suppressed:', reason);\n              event.preventDefault();\n            }\n          });\n\n          // 5. Patch Zone.js error handling (Angular's error zone)\n          // This runs after Angular loads, intercepting Zone's error handler\n          const patchZone = () => {\n            const Zone = (window as any).Zone;\n            if (Zone && Zone.current) {\n              const originalHandleError = Zone.current._zoneDelegate?.handleError;\n              if (originalHandleError && !Zone.current._zoneDelegate?._patchedHandleError) {\n                Zone.current._zoneDelegate.handleError = function(zone: any, error: any) {\n                  const errorStr = error ? String(error.message || error) : '';\n                  if (errorStr.includes('replaceAll') || errorStr.includes('fixLink') ||\n                      errorStr.includes('Cannot read properties') || errorStr.includes('Missing required param') ||\n                      errorStr.includes('kungorelseid')) {\n                    console.warn('[Zone.js] Suppressed Angular error:', errorStr);\n                    return true; // Error handled, don't propagate\n                  }\n                  return originalHandleError.call(this, zone, error);\n                };\n                Zone.current._zoneDelegate._patchedHandleError = true;\n              }\n            }\n          };\n\n          // Try to patch Zone immediately and also after a delay\n          patchZone();\n          setTimeout(patchZone, 1000);\n          setTimeout(patchZone, 3000);\n\n          // 6. RUNTIME FALLBACK: Patch any fixLink function found in Angular components\n          // This is a backup in case the bundle patch didn't work\n          const patchFixLinkRuntime = () => {\n            try {\n              // Search through all script contexts for fixLink\n              const scripts = document.querySelectorAll('script');\n              scripts.forEach(script => {\n                const src = script.textContent || '';\n                if (src.includes('fixLink')) {\n                  console.log('[Runtime] Found script with fixLink reference');\n                }\n              });\n\n              // Try to find Angular component instances with fixLink\n              const appRoot = document.querySelector('app-root');\n              if (appRoot) {\n                // Traverse the DOM looking for Angular component instances\n                const walkComponents = (element: Element) => {\n                  // Check for Angular context\n                  const ngContext = (element as any).__ngContext__;\n                  if (ngContext && Array.isArray(ngContext)) {\n                    ngContext.forEach((item: any) => {\n                      if (item && typeof item === 'object' && typeof item.fixLink === 'function') {\n                        const originalFixLink = item.fixLink.bind(item);\n                        item.fixLink = function(value: any) {\n                          if (value === null || value === undefined) {\n                            console.log('[Runtime] fixLink called with null/undefined, returning empty');\n                            return '';\n                          }\n                          return originalFixLink(value);\n                        };\n                        console.log('[Runtime] Patched fixLink on component instance');\n                      }\n                    });\n                  }\n                  // Recurse through children\n                  Array.from(element.children).forEach(walkComponents);\n                };\n                walkComponents(appRoot);\n              }\n            } catch (e) {\n              console.warn('[Runtime] Error patching fixLink:', e);\n            }\n          };\n\n          // Run the runtime patch at various times to catch Angular initialization\n          setTimeout(patchFixLinkRuntime, 500);\n          setTimeout(patchFixLinkRuntime, 1500);\n          setTimeout(patchFixLinkRuntime, 3000);\n          setTimeout(patchFixLinkRuntime, 5000);\n\n          // 7. Monitor for Angular Router and patch its navigation\n          const patchAngularRouter = () => {\n            // Check if Angular Router is available\n            const appRoot = document.querySelector('app-root');\n            if (appRoot) {\n              const ngRef = (appRoot as any).__ngContext__ || (appRoot as any).ngContext;\n              if (ngRef) {\n                console.log('[Patch] Angular context found, navigation should work');\n              }\n            }\n          };\n          setTimeout(patchAngularRouter, 2000);\n        });\n\n        // Track 403 errors for detection\n        let got403 = false;\n        let consecutive403Count = 0;\n\n        // Capture console errors from the page for debugging\n        page.on(\"console\", (msg: { type: () => string; text: () => string }) => {\n          if (msg.type() === \"error\") {\n            console.log(\"[PageConsole] ERROR:\", msg.text());\n          }\n        });\n        page.on(\"pageerror\", (error: Error) => {\n          console.log(\"[PageError]\", error.message);\n        });\n\n        // Track 403 responses\n        page.on(\"response\", (response: { status: () => number; url: () => string }) => {\n          if (response.status() === 403) {\n            got403 = true;\n            consecutive403Count++;\n            console.log(`[StreamScraper] Got 403 on ${response.url()} (count: ${consecutive403Count})`);\n          } else if (response.status() >= 200 && response.status() < 300) {\n            // Reset on successful response\n            consecutive403Count = 0;\n          }\n        });\n\n        try {\n          // Navigate to search - use 'load' event first, then wait for Angular\n          await page.goto(START_URL, { waitUntil: \"load\", timeout: 60000 });\n\n          // Wait for Angular to bootstrap (check for app-root or body content)\n          console.log(\"[StreamScraper] Waiting for Angular to bootstrap...\");\n          await page.waitForFunction(\n            () => {\n              const body = document.body?.innerText || \"\";\n              const hasAngular = !!document.querySelector(\"app-root\") || !!document.querySelector(\"[ng-version]\");\n              const hasContent = body.length > 100;\n              return hasAngular || hasContent;\n            },\n            { timeout: 30000 }\n          ).catch(() => {\n            console.log(\"[StreamScraper] Angular bootstrap timeout, continuing...\");\n          });\n\n          // Additional wait for network to settle\n          await page.waitForTimeout(3000);\n\n          // Log initial page state\n          console.log(\"[StreamScraper] Initial page loaded, capturing state...\");\n          await captureDebugInfo(page, \"initial-load\");\n\n          // Check for 403 blocking\n          if (got403 && consecutive403Count >= 3) {\n            sendEvent({ type: \"error\", message: \"Bolagsverket blockerar anslutningen (403). Försöker igen...\" });\n            console.log(\"[StreamScraper] Multiple 403s detected, waiting before retry...\");\n            await captureDebugInfo(page, \"403-blocked\");\n            await page.waitForTimeout(5000);\n            got403 = false;\n            consecutive403Count = 0;\n            await page.goto(START_URL, { waitUntil: \"load\", timeout: 60000 });\n            await page.waitForTimeout(3000);\n          }\n          await page.waitForTimeout(1000);\n          sendEvent({ type: \"status\", message: \"Kontrollerar captcha...\" });\n\n          // Handle captcha if present\n          await solveBlockerWithProgress(page, sendEvent);\n\n          // Navigate to search form\n          sendEvent({ type: \"status\", message: \"Öppnar sökformulär...\" });\n          let ready = await maybeNavigateToSearch(page);\n          await solveBlockerWithProgress(page, sendEvent);\n\n          // If not ready, reload and try again (like reference code)\n          if (!ready) {\n            console.log(\"[StreamScraper] First navigation failed, reloading page...\");\n            await page.goto(START_URL, { waitUntil: \"load\", timeout: 30000 });\n            await page.waitForTimeout(3000);\n            await solveBlockerWithProgress(page, sendEvent);\n            ready = await maybeNavigateToSearch(page);\n          }\n\n          await waitForSearchInputs(page);\n\n          // Submit search with retry and page reload (like reference code)\n          sendEvent({ type: \"search\", message: `Söker: \"${query.trim()}\"...` });\n          let submitted: boolean | \"disabled\" = false;\n\n          for (let attempt = 1; attempt <= 3; attempt++) {\n            submitted = await submitSearch(page, query.trim());\n\n            if (submitted === true) {\n              console.log(\"[StreamScraper] Search submitted successfully\");\n              break;\n            }\n\n            if (submitted === \"disabled\") {\n              sendEvent({ type: \"error\", message: \"Sökfältet inaktiverat - ogiltigt sökord\" });\n              throw new Error(\"Invalid search query\");\n            }\n\n            // Retry: reload page, solve captcha, navigate to search\n            console.log(`[StreamScraper] Input not found, retrying (attempt ${attempt}/3)...`);\n            await captureDebugInfo(page, `input-not-found-attempt-${attempt}`);\n            sendEvent({ type: \"status\", message: `Försöker igen (${attempt}/3)...` });\n\n            // Use goto instead of reload to avoid timeout issues\n            await page.goto(page.url(), {\n              waitUntil: \"domcontentloaded\",\n              timeout: SCRAPER_CONFIG.navigationTimeout\n            }).catch(() => {});\n            await page.waitForTimeout(1000);\n            await solveBlockerWithProgress(page, sendEvent);\n            await maybeNavigateToSearch(page);\n            await waitForSearchInputs(page);\n          }\n\n          if (submitted !== true) {\n            await captureDebugInfo(page, \"search-form-final-failure\");\n            throw new Error(\"Kunde inte hitta sökformulär efter 3 försök\");\n          }\n\n          // Wait for AJAX search to complete - look for results table or \"no results\" message\n          // Wait for loading to complete and results to appear\n          try {\n            // First wait for \"Laddar\" to disappear (page is loading)\n            await page.waitForFunction(\n              () => {\n                const body = document.body?.innerText || \"\";\n                return !body.includes(\"Laddar\");\n              },\n              { timeout: 20000 }\n            ).catch(() => console.log(\"[StreamScraper] Still shows 'Laddar' after 20s\"));\n\n            // Then wait for results or error message\n            await page.waitForFunction(\n              () => {\n                const body = document.body?.innerText || \"\";\n                // Check for results table, result links, result count, or \"no results\" message\n                return (\n                  document.querySelector('table') !== null ||\n                  document.querySelector('a[href*=\"kungorelse/\"]') !== null ||\n                  body.includes(\"Antal träffar\") ||\n                  body.includes(\"inga träffar\") ||\n                  body.includes(\"0 träffar\") ||\n                  body.includes(\"Inga kungörelser\")\n                );\n              },\n              { timeout: 15000 }\n            );\n          } catch {\n            console.log(\"[StreamScraper] Timeout waiting for search results\");\n          }\n\n          await page.waitForTimeout(2000);\n          await solveBlockerWithProgress(page, sendEvent);\n\n          // Dismiss cookie banner again after search (might reappear)\n          await dismissCookieBanner(page);\n\n          // Collect results\n          sendEvent({ type: \"status\", message: \"Samlar in resultat...\" });\n\n          // Log the current page URL and state\n          const currentUrl = page.url();\n          console.log(\"[StreamScraper] Current URL after search:\", currentUrl);\n\n          const results = await collectResultsWithProgress(page, sendEvent, query.trim());\n\n          sendEvent({\n            type: \"result\",\n            message: `Hittade ${results.length} kungörelser`,\n            data: { count: results.length },\n          });\n\n          // Fetch details if not skipped\n          const enrichedResults: ScrapedResult[] = [];\n\n          if (!skipDetails && results.length > 0) {\n            const limit = Math.min(detailLimit, results.length);\n            const DETAIL_DELAY_MS = 3000; // Increased from 1500ms\n            const MAX_RETRIES = 5;\n\n            sendEvent({\n              type: \"status\",\n              message: `Hämtar detaljer för ${limit} av ${results.length} kungörelser...`,\n            });\n\n            let lastFetchTime = 0;\n\n            for (let i = 0; i < limit; i++) {\n              const item = results[i];\n              sendEvent({\n                type: \"detail\",\n                message: `Hämtar detalj ${i + 1}/${limit}: ${item.type || \"Kungörelse\"}`,\n                data: { current: i + 1, total: limit, id: item.id },\n              });\n\n              // Enforce delay between fetches\n              const now = Date.now();\n              const elapsed = now - lastFetchTime;\n              if (elapsed < DETAIL_DELAY_MS && lastFetchTime > 0) {\n                const waitTime = DETAIL_DELAY_MS - elapsed;\n                await new Promise((r) => setTimeout(r, waitTime));\n              }\n              lastFetchTime = Date.now();\n\n              let text = \"\";\n              let retryDelay = 5000;\n              let success = false;\n\n              // Retry loop - start WITHOUT proxy, use proxy only if rate limited\n              let useProxy = false; // Start without proxy\n              for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {\n                try {\n                  // Use proxy only after getting rate limited\n                  const proxyUrl = useProxy ? proxyConfig?.server : undefined;\n\n                  console.log(`[StreamScraper] Detail attempt ${attempt}/${MAX_RETRIES} for ${item.id}, useProxy=${useProxy}`);\n                  const result = await fetchDetailText(context, item, {\n                    proxyUrl,\n                    proxyUsername: useProxy ? proxyConfig?.username : undefined,\n                    proxyPassword: useProxy ? proxyConfig?.password : undefined,\n                  });\n                  text = result.text || \"\";\n\n                  if (result.got429) {\n                    sendEvent({\n                      type: \"error\",\n                      message: `⚠️ Rate limit för ${item.id}, aktiverar proxy (${attempt}/${MAX_RETRIES})...`,\n                    });\n\n                    useProxy = true; // Switch to proxy after rate limit\n                    await new Promise((r) => setTimeout(r, retryDelay));\n                    retryDelay *= 2; // Exponential backoff\n                    lastFetchTime = Date.now();\n                    continue;\n                  }\n\n                  if (text && text.trim()) {\n                    success = true;\n                    break;\n                  }\n\n                  if (attempt < MAX_RETRIES) {\n                    sendEvent({\n                      type: \"status\",\n                      message: `Tom text för ${item.id}, försöker igen (${attempt}/${MAX_RETRIES})...`,\n                    });\n                    await new Promise((r) => setTimeout(r, 4000));\n                  }\n                } catch (err) {\n                  if (attempt === MAX_RETRIES) {\n                    sendEvent({\n                      type: \"error\",\n                      message: `✗ Kunde inte hämta detalj efter ${MAX_RETRIES} försök: ${err instanceof Error ? err.message : \"Okänt fel\"}`,\n                    });\n                  } else {\n                    sendEvent({\n                      type: \"status\",\n                      message: `Fel för ${item.id}, försöker igen (${attempt}/${MAX_RETRIES})...`,\n                    });\n                    await new Promise((r) => setTimeout(r, 4000));\n                  }\n                }\n              }\n\n              // Log final result\n              if (!text || !text.trim()) {\n                console.log(`[StreamScraper] All ${MAX_RETRIES} attempts failed for ${item.id}`);\n              }\n\n              // Store results\n              if (text) {\n                item.detailText = text.length > 500 ? text.slice(0, 500) + \"...\" : text;\n                item.fullText = text;\n                sendEvent({\n                  type: \"success\",\n                  message: `✓ Detalj ${i + 1}/${limit} hämtad`,\n                  data: { id: item.id, hasText: true },\n                });\n              } else {\n                sendEvent({\n                  type: \"error\",\n                  message: `✗ Kunde inte hämta detalj för ${item.id} efter alla försök`,\n                  data: { id: item.id, hasText: false },\n                });\n              }\n\n              enrichedResults.push(item);\n            }\n\n            // Add remaining results without details\n            for (let i = limit; i < results.length; i++) {\n              enrichedResults.push(results[i]);\n            }\n          } else {\n            enrichedResults.push(...results);\n          }\n\n          // Save to database\n          sendEvent({ type: \"status\", message: \"Sparar till databas...\" });\n          const saved = await saveAnnouncements(query.trim(), orgNumber, enrichedResults);\n\n          sendEvent({\n            type: \"complete\",\n            message: `Klar! ${saved} kungörelser sparade`,\n            data: {\n              total: results.length,\n              saved,\n              withDetails: enrichedResults.filter((r) => r.fullText).length,\n            },\n          });\n        } finally {\n          // Safely close browser resources\n          try {\n            await context.close();\n          } catch (closeErr) {\n            console.log(\"[StreamScraper] Context already closed:\", closeErr);\n          }\n          try {\n            await browser.close();\n          } catch (closeErr) {\n            console.log(\"[StreamScraper] Browser already closed:\", closeErr);\n          }\n        }\n      } catch (error) {\n        console.log(\"[StreamScraper] Error:\", error);\n        sendEvent({\n          type: \"error\",\n          message: `Fel: ${error instanceof Error ? error.message : \"Okänt fel\"}`,\n        });\n      } finally {\n        controller.close();\n      }\n    },\n  });\n\n  return new Response(stream, {\n    headers: {\n      \"Content-Type\": \"text/event-stream\",\n      \"Cache-Control\": \"no-cache\",\n      Connection: \"keep-alive\",\n    },\n  });\n}\n\n// Helper functions (simplified versions from scraper.ts)\n\nasync function solveBlockerWithProgress(page: Page, sendEvent: ProgressCallback): Promise<boolean> {\n  for (let attempt = 1; attempt <= 5; attempt++) {\n    const blocked = await page.evaluate(() => {\n      const body = document.body ? document.body.innerText : \"\";\n      return Boolean(document.querySelector(\"#ans\")) || body.includes(\"human visitor\");\n    });\n\n    if (!blocked) return true;\n\n    sendEvent({\n      type: \"captcha\",\n      message: `Captcha upptäckt, löser... (försök ${attempt}/5)`,\n    });\n\n    const imgSrc = await page.evaluate(() => {\n      const img = Array.from(document.querySelectorAll(\"img\")).find((i) =>\n        (i.src || \"\").includes(\"base64\")\n      );\n      return img ? img.src : null;\n    });\n\n    if (!imgSrc) {\n      // Use goto instead of reload to avoid timeout issues\n      await page.goto(page.url(), {\n        waitUntil: \"domcontentloaded\",\n        timeout: SCRAPER_CONFIG.navigationTimeout\n      }).catch(() => {});\n      await page.waitForTimeout(3000);\n      continue;\n    }\n\n    try {\n      const guess = await solveCaptcha(imgSrc, sendEvent);\n\n      const input = page.locator(\"#ans\");\n      await input.fill(guess);\n      await page.locator(\"#jar\").click();\n\n      // Wait for CAPTCHA to be processed and page to load\n      await page.waitForTimeout(3000);\n\n      // Wait for Angular to bootstrap after CAPTCHA\n      await page.waitForFunction(\n        () => {\n          const body = document.body?.innerText || \"\";\n          const hasBlocker = body.includes(\"human visitor\") || !!document.querySelector(\"#ans\");\n          const hasAngular = !!document.querySelector(\"app-root\") || !!document.querySelector(\"[ng-version]\");\n          const hasContent = body.length > 500;\n          return !hasBlocker && (hasAngular || hasContent);\n        },\n        { timeout: 15000 }\n      ).catch(() => {\n        console.log(\"[solveBlockerWithProgress] Timeout waiting for Angular after CAPTCHA\");\n      });\n\n      await page.waitForTimeout(2000);\n      sendEvent({ type: \"captcha\", message: \"Captcha löst!\" });\n    } catch (err) {\n      sendEvent({\n        type: \"error\",\n        message: `Captcha-fel: ${err instanceof Error ? err.message : \"Okänt\"}`,\n      });\n      // Use goto instead of reload to avoid timeout issues\n      await page.goto(page.url(), {\n        waitUntil: \"domcontentloaded\",\n        timeout: SCRAPER_CONFIG.navigationTimeout\n      }).catch(() => {});\n      await page.waitForTimeout(3000);\n    }\n  }\n\n  return false;\n}\n\nasync function solveCaptcha(imageBase64: string, sendEvent: ProgressCallback): Promise<string> {\n  // Read API key fresh\n  const TWOCAPTCHA_API_KEY = process.env.TWOCAPTCHA_API_KEY || \"\";\n\n  if (!TWOCAPTCHA_API_KEY) {\n    throw new Error(\"TWOCAPTCHA_API_KEY ej konfigurerad\");\n  }\n\n  sendEvent({ type: \"captcha\", message: \"Skickar captcha till 2captcha...\" });\n\n  // Submit captcha\n  const submitUrl = new URL(\"https://2captcha.com/in.php\");\n  submitUrl.searchParams.set(\"key\", TWOCAPTCHA_API_KEY);\n  submitUrl.searchParams.set(\"method\", \"base64\");\n  submitUrl.searchParams.set(\"json\", \"1\");\n\n  const base64Data = imageBase64.includes(\"base64,\")\n    ? imageBase64.split(\"base64,\")[1]\n    : imageBase64;\n\n  const submitResponse = await fetch(submitUrl.toString(), {\n    method: \"POST\",\n    headers: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\n    body: new URLSearchParams({ body: base64Data }),\n  });\n\n  const submitResult = await submitResponse.json();\n  if (submitResult.status !== 1) {\n    throw new Error(`2captcha submit failed: ${submitResult.request}`);\n  }\n\n  const captchaId = submitResult.request;\n  sendEvent({ type: \"captcha\", message: `Väntar på 2captcha (ID: ${captchaId})...` });\n\n  // Poll for result\n  const resultUrl = new URL(\"https://2captcha.com/res.php\");\n  resultUrl.searchParams.set(\"key\", TWOCAPTCHA_API_KEY);\n  resultUrl.searchParams.set(\"action\", \"get\");\n  resultUrl.searchParams.set(\"id\", captchaId);\n  resultUrl.searchParams.set(\"json\", \"1\");\n\n  for (let i = 0; i < 30; i++) {\n    await new Promise((resolve) => setTimeout(resolve, 2000));\n\n    const resultResponse = await fetch(resultUrl.toString());\n    const result = await resultResponse.json();\n\n    if (result.status === 1) {\n      return result.request;\n    }\n\n    if (result.request !== \"CAPCHA_NOT_READY\") {\n      throw new Error(`2captcha failed: ${result.request}`);\n    }\n\n    if (i % 5 === 0) {\n      sendEvent({ type: \"captcha\", message: `Väntar på captcha-svar... (${i * 2}s)` });\n    }\n  }\n\n  throw new Error(\"2captcha timeout\");\n}\n\n// Silent CAPTCHA solver for detail pages (logs to console instead of sendEvent)\nasync function solveBlockerSilent(page: Page): Promise<boolean> {\n  const TWOCAPTCHA_API_KEY = process.env.TWOCAPTCHA_API_KEY || \"\";\n\n  for (let attempt = 1; attempt <= 3; attempt++) {\n    const blocked = await page.evaluate(() => {\n      const body = document.body ? document.body.innerText : \"\";\n      return Boolean(document.querySelector(\"#ans\")) || body.includes(\"human visitor\");\n    });\n\n    if (!blocked) return true;\n\n    console.log(`[solveBlockerSilent] CAPTCHA detected, solving... (attempt ${attempt}/3)`);\n\n    const imgSrc = await page.evaluate(() => {\n      const img = Array.from(document.querySelectorAll(\"img\")).find((i) =>\n        (i.src || \"\").includes(\"base64\")\n      );\n      return img ? img.src : null;\n    });\n\n    if (!imgSrc) {\n      console.log(\"[solveBlockerSilent] No CAPTCHA image found, reloading...\");\n      await page.goto(page.url(), { waitUntil: \"domcontentloaded\", timeout: 20000 }).catch(() => {});\n      await page.waitForTimeout(3000);\n      continue;\n    }\n\n    if (!TWOCAPTCHA_API_KEY) {\n      console.log(\"[solveBlockerSilent] No 2captcha API key, cannot solve CAPTCHA\");\n      return false;\n    }\n\n    try {\n      // Submit to 2captcha\n      const submitUrl = new URL(\"https://2captcha.com/in.php\");\n      submitUrl.searchParams.set(\"key\", TWOCAPTCHA_API_KEY);\n      submitUrl.searchParams.set(\"method\", \"base64\");\n      submitUrl.searchParams.set(\"json\", \"1\");\n\n      const base64Data = imgSrc.includes(\"base64,\") ? imgSrc.split(\"base64,\")[1] : imgSrc;\n\n      const submitResponse = await fetch(submitUrl.toString(), {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\n        body: new URLSearchParams({ body: base64Data }),\n      });\n\n      const submitResult = await submitResponse.json();\n      if (submitResult.status !== 1) {\n        console.log(`[solveBlockerSilent] 2captcha submit failed: ${submitResult.request}`);\n        continue;\n      }\n\n      const captchaId = submitResult.request;\n      console.log(`[solveBlockerSilent] Waiting for 2captcha (ID: ${captchaId})...`);\n\n      // Poll for result\n      const resultUrl = new URL(\"https://2captcha.com/res.php\");\n      resultUrl.searchParams.set(\"key\", TWOCAPTCHA_API_KEY);\n      resultUrl.searchParams.set(\"action\", \"get\");\n      resultUrl.searchParams.set(\"id\", captchaId);\n      resultUrl.searchParams.set(\"json\", \"1\");\n\n      let guess = \"\";\n      for (let i = 0; i < 20; i++) {\n        await new Promise((resolve) => setTimeout(resolve, 2000));\n        const resultResponse = await fetch(resultUrl.toString());\n        const result = await resultResponse.json();\n\n        if (result.status === 1) {\n          guess = result.request;\n          break;\n        }\n        if (result.request !== \"CAPCHA_NOT_READY\") {\n          console.log(`[solveBlockerSilent] 2captcha error: ${result.request}`);\n          break;\n        }\n      }\n\n      if (guess) {\n        const input = page.locator(\"#ans\");\n        await input.fill(guess);\n        await page.locator(\"#jar\").click();\n        await page.waitForTimeout(3000);\n\n        // Wait for page to load after CAPTCHA\n        await page.waitForFunction(\n          () => {\n            const body = document.body?.innerText || \"\";\n            const hasBlocker = body.includes(\"human visitor\") || !!document.querySelector(\"#ans\");\n            return !hasBlocker && body.length > 300;\n          },\n          { timeout: 15000 }\n        ).catch(() => {});\n\n        console.log(\"[solveBlockerSilent] CAPTCHA solved!\");\n      }\n    } catch (err) {\n      console.log(`[solveBlockerSilent] Error: ${err instanceof Error ? err.message : \"Unknown\"}`);\n      await page.goto(page.url(), { waitUntil: \"domcontentloaded\", timeout: 20000 }).catch(() => {});\n      await page.waitForTimeout(3000);\n    }\n  }\n\n  return false;\n}\n\nasync function dismissCookieBanner(page: Page): Promise<void> {\n  try {\n    // Try various cookie banner dismiss buttons\n    const selectors = [\n      'button[data-cookiefirst-action=\"reject\"]',\n      'button[data-cookiefirst-action=\"accept\"]',\n      '.cookiefirst-root button:has-text(\"Avvisa\")',\n      '.cookiefirst-root button:has-text(\"Acceptera\")',\n      'dialog[aria-label*=\"Cookie\"] button',\n      '[class*=\"cookie\"] button:first-of-type',\n    ];\n\n    for (const selector of selectors) {\n      const btn = page.locator(selector).first();\n      if (await btn.count() > 0 && await btn.isVisible()) {\n        await btn.click({ timeout: 3000 }).catch(() => {});\n        await page.waitForTimeout(500);\n        console.log(\"[StreamScraper] Dismissed cookie banner\");\n        return;\n      }\n    }\n\n    // Try to close by pressing Escape\n    await page.keyboard.press(\"Escape\");\n    await page.waitForTimeout(300);\n  } catch (e) {\n    // Ignore errors - banner might not exist\n  }\n}\n\nasync function waitForSearchPage(page: Page): Promise<boolean> {\n  const heading = page.getByRole(\"heading\", { name: /Sök kungörelse/i });\n  try {\n    await heading.first().waitFor({ timeout: 15000 });\n    return true;\n  } catch {\n    return false;\n  }\n}\n\nasync function maybeNavigateToSearch(page: Page): Promise<boolean> {\n  // First, try to dismiss any cookie banners\n  await dismissCookieBanner(page);\n\n  const hasNameField = await page.$(\"#namn\");\n  const hasOrgField = await page.$(\"#personOrgnummer\");\n  if (hasNameField || hasOrgField) return true;\n\n  console.log(\"[maybeNavigateToSearch] Opening search form...\");\n\n  // Try clicking the link with URL wait like reference\n  const link = page.getByRole(\"link\", { name: /Sök kungörelse/i });\n  if (await link.count()) {\n    try {\n      await Promise.all([\n        link.first().click(),\n        page.waitForURL(/\\/poit-app\\/sok/, { timeout: 15000 }).catch(() => {}),\n      ]);\n    } catch {\n      // Try with force if normal click fails\n      await link.first().click({ force: true, timeout: 5000 }).catch(() => {});\n    }\n  } else {\n    // Fallback: click by evaluating text\n    await page.evaluate(() => {\n      const a = Array.from(document.querySelectorAll(\"a\")).find((el) =>\n        (el.innerText || \"\").includes(\"Sök kungörelse\")\n      );\n      if (a) a.click();\n    });\n  }\n\n  await page.waitForTimeout(1000);\n  await waitForSearchPage(page);\n  await waitForSearchInputs(page);\n\n  const hasNameFieldAfter = await page.$(\"#namn\");\n  const hasOrgFieldAfter = await page.$(\"#personOrgnummer\");\n  return Boolean(hasNameFieldAfter || hasOrgFieldAfter);\n}\n\nasync function waitForSearchInputs(page: Page): Promise<void> {\n  // Wait for any of the possible search input selectors (expanded for Angular)\n  await page.waitForFunction(\n    () => {\n      // Try multiple selector strategies\n      const selectors = [\n        \"#namn\",\n        \"#personOrgnummer\",\n        'input[id*=\"namn\"]',\n        'input[id*=\"org\"]',\n        'input[name*=\"namn\"]',\n        'input[name*=\"org\"]',\n        'input[placeholder*=\"Företag\"]',\n        'input[placeholder*=\"Org\"]',\n        'input[formcontrolname]',\n        'input[type=\"text\"]',\n      ];\n\n      for (const sel of selectors) {\n        const el = document.querySelector(sel);\n        if (el && (el as HTMLElement).offsetParent !== null) {\n          return true; // Found visible input\n        }\n      }\n      return false;\n    },\n    { timeout: 20000 }\n  ).catch(() => {\n    console.log(\"[waitForSearchInputs] Timeout waiting for inputs\");\n  });\n}\n\n// Resolve search input with multiple fallback selectors (expanded for Angular)\nasync function resolveSearchInput(page: Page, isOrg: boolean) {\n  const selectors = isOrg\n    ? [\n        \"#personOrgnummer\",\n        'input[id*=\"org\"]',\n        'input[id*=\"Org\"]',\n        'input[name*=\"org\"]',\n        'input[name*=\"Org\"]',\n        'input[formcontrolname*=\"org\"]',\n        'input[formcontrolname*=\"Org\"]',\n        'input[placeholder*=\"Org\"]',\n        'input[placeholder*=\"organisationsnummer\"]',\n        'input[placeholder*=\"Organisationsnummer\"]',\n        'input[aria-label*=\"Org\"]',\n        'input[type=\"text\"]:near(:text(\"Organisationsnummer\"))',\n      ]\n    : [\n        \"#namn\",\n        'input[id*=\"namn\"]',\n        'input[id*=\"Namn\"]',\n        'input[name*=\"namn\"]',\n        'input[name*=\"Namn\"]',\n        'input[formcontrolname*=\"namn\"]',\n        'input[formcontrolname*=\"Namn\"]',\n        'input[placeholder*=\"Företag\"]',\n        'input[placeholder*=\"företag\"]',\n        'input[placeholder*=\"namn\"]',\n        'input[placeholder*=\"Namn\"]',\n        'input[aria-label*=\"namn\"]',\n        'input[aria-label*=\"Namn\"]',\n        'input[type=\"text\"]:near(:text(\"Företagsnamn\"))',\n        'input[type=\"text\"]:near(:text(\"Namn\"))',\n      ];\n\n  for (const sel of selectors) {\n    try {\n      const loc = page.locator(sel);\n      if ((await loc.count()) > 0) {\n        console.log(`[resolveSearchInput] Found input with selector: ${sel}`);\n        return loc.first();\n      }\n    } catch {\n      // Skip invalid selectors\n    }\n  }\n\n  // Last resort: try to find any visible text input\n  console.log(\"[resolveSearchInput] Trying generic text input fallback...\");\n  const genericInputs = page.locator('input[type=\"text\"]:visible');\n  if ((await genericInputs.count()) > 0) {\n    console.log(`[resolveSearchInput] Found ${await genericInputs.count()} generic text inputs`);\n    return genericInputs.first();\n  }\n\n  return null;\n}\n\nasync function submitSearch(page: Page, query: string): Promise<boolean | \"disabled\"> {\n  const digits = query.replace(/\\D/g, \"\");\n  const isOrg = digits.length >= 10;\n\n  const formattedQuery = isOrg && digits.length >= 10\n    ? `${digits.slice(0, 6)}-${digits.slice(6, 10)}`\n    : query;\n\n  // Wait for input to appear with retry (up to 15 seconds) using flexible selectors\n  const start = Date.now();\n  let input = null;\n  while (!input && Date.now() - start < 15000) {\n    input = await resolveSearchInput(page, isOrg);\n    if (!input) {\n      console.log(\"[submitSearch] Input not found, waiting 1s...\");\n      await page.waitForTimeout(1000);\n    }\n  }\n\n  if (!input) {\n    console.log(\"[submitSearch] Input not found after 15s retry\");\n    return false;\n  }\n\n  console.log(\"[submitSearch] Found input, filling with:\", formattedQuery);\n  await input.fill(formattedQuery);\n\n  // Dispatch form events to trigger Angular/React validation (matching reference code)\n  await page.evaluate(() => {\n    const el =\n      document.querySelector(\"#namn\") ||\n      document.querySelector(\"#personOrgnummer\") ||\n      document.querySelector('input[name*=\"namn\"]') ||\n      document.querySelector('input[name*=\"org\"]');\n    if (!el) return;\n    el.dispatchEvent(new Event(\"input\", { bubbles: true }));\n    el.dispatchEvent(new Event(\"change\", { bubbles: true }));\n    (el as HTMLElement).blur();\n  });\n\n  await page.waitForTimeout(500);\n\n  console.log(\"[submitSearch] Clicking search button...\");\n  const button = page.getByRole(\"button\", { name: /Sök kungörelse/i });\n  let clicked = false;\n\n  if (await button.count()) {\n    const enabled = await button.first().isEnabled();\n    if (!enabled) {\n      console.log(\"[submitSearch] Button disabled, trying Enter key\");\n      try {\n        await input.press(\"Enter\");\n      } catch {\n        // ignore\n      }\n      return \"disabled\";\n    }\n\n    // Try clicking with shorter timeout first\n    try {\n      await button.first().click({ timeout: 5000 });\n      clicked = true;\n      console.log(\"[submitSearch] Button clicked successfully via Playwright\");\n    } catch (clickErr) {\n      console.log(\"[submitSearch] Playwright click failed, trying JavaScript click...\");\n      // Fallback: use JavaScript to click the button directly\n      const jsClicked = await page.evaluate(() => {\n        const btns = Array.from(document.querySelectorAll(\"button\"));\n        const btn = btns.find((b) => {\n          const text = b.innerText || b.textContent || \"\";\n          return text.includes(\"Sök kungörelse\") || text.includes(\"Sök\");\n        });\n        if (btn) {\n          btn.click();\n          return true;\n        }\n        // Also try finding any submit button\n        const submitBtn = document.querySelector('button[type=\"submit\"]') as HTMLButtonElement;\n        if (submitBtn) {\n          submitBtn.click();\n          return true;\n        }\n        return false;\n      });\n      clicked = jsClicked;\n      if (jsClicked) {\n        console.log(\"[submitSearch] Button clicked via JavaScript\");\n      }\n    }\n  }\n\n  // Fallback: try clicking button by text or pressing Enter\n  if (!clicked) {\n    console.log(\"[submitSearch] Trying fallback methods...\");\n    await page.evaluate(() => {\n      const btn = Array.from(document.querySelectorAll(\"button\")).find((b) =>\n        (b.innerText || \"\").includes(\"Sök kungörelse\")\n      );\n      if (btn) btn.click();\n    });\n  }\n\n  // Always try Enter key as final backup\n  try {\n    await input.press(\"Enter\");\n    console.log(\"[submitSearch] Pressed Enter key as backup\");\n  } catch {\n    // ignore\n  }\n\n  return true;\n}\n\nasync function collectResultsWithProgress(page: Page, sendEvent: ProgressCallback, query?: string): Promise<ScrapedResult[]> {\n  // Wait for results to load - try multiple times (10 retries like reference poit.js)\n  for (let i = 0; i < 10; i++) {\n    await page.waitForTimeout(1500);\n\n    // Re-check for captcha/blocker on each iteration\n    await solveBlockerWithProgress(page, sendEvent);\n\n    // Check for Angular errors or \"no results\" message\n    const pageCheck = await page.evaluate(() => {\n      const body = document.body?.innerText || \"\";\n      const bodyLower = body.toLowerCase();\n      return {\n        noResults: bodyLower.includes(\"inga träffar\") || bodyLower.includes(\"inga kungörelser\") || bodyLower.includes(\"0 träffar\"),\n        hasTypeError: body.includes(\"TypeError\"),\n        hasLoading: body.includes(\"Laddar\"),\n        bodyText: body.slice(0, 500),\n      };\n    });\n\n    // If Angular crashed, try a fresh navigation to let Angular bootstrap properly\n    if (pageCheck.hasTypeError && i < 4 && query) {\n      console.log(`[collectResults] Angular TypeError detected (attempt ${i + 1}), restarting from homepage...`);\n      sendEvent({ type: \"status\", message: `Angular-fel, startar om... (${i + 1}/4)` });\n\n      // Progressive delay: wait longer on each retry (3s, 5s, 7s, 9s)\n      const retryDelay = 3000 + (i * 2000);\n      console.log(`[collectResults] Waiting ${retryDelay}ms before retry...`);\n      await page.waitForTimeout(retryDelay);\n\n      // Navigate to homepage first to let Angular bootstrap cleanly\n      await page.goto(\"https://poit.bolagsverket.se/poit-app/\", {\n        waitUntil: \"load\",\n        timeout: SCRAPER_CONFIG.navigationTimeout\n      }).catch(() => {});\n\n      // Re-apply Zone.js patch after navigation\n      await page.evaluate(() => {\n        const patchZone = () => {\n          const Zone = (window as any).Zone;\n          if (Zone && Zone.current) {\n            const delegate = Zone.current._zoneDelegate;\n            if (delegate && delegate.handleError && !delegate._patchedHandleError) {\n              const originalHandleError = delegate.handleError;\n              delegate.handleError = function(zone: any, error: any) {\n                const errorStr = error ? String(error.message || error) : '';\n                if (errorStr.includes('replaceAll') || errorStr.includes('fixLink') || errorStr.includes('Cannot read properties')) {\n                  console.warn('[Zone.js retry] Suppressed Angular error:', errorStr);\n                  return true;\n                }\n                return originalHandleError.call(this, zone, error);\n              };\n              delegate._patchedHandleError = true;\n            }\n          }\n        };\n        patchZone();\n        setTimeout(patchZone, 500);\n      });\n\n      // Wait for Angular to bootstrap on homepage with longer timeout\n      await page.waitForFunction(\n        () => {\n          const body = document.body?.innerText || \"\";\n          const hasAngular = !!document.querySelector(\"app-root\") || !!document.querySelector(\"[ng-version]\");\n          return hasAngular && body.length > 300;\n        },\n        { timeout: 20000 }\n      ).catch(() => console.log(\"[collectResults] Angular bootstrap timeout on homepage\"));\n\n      // Longer wait after Angular loads\n      await page.waitForTimeout(3000);\n      await solveBlockerWithProgress(page, sendEvent);\n\n      // Navigate to search page\n      await page.goto(\"https://poit.bolagsverket.se/poit-app/sok\", {\n        waitUntil: \"load\",\n        timeout: SCRAPER_CONFIG.navigationTimeout\n      }).catch(() => {});\n\n      // Re-apply Zone.js patch after search page navigation\n      await page.evaluate(() => {\n        const Zone = (window as any).Zone;\n        if (Zone && Zone.current && Zone.current._zoneDelegate) {\n          const delegate = Zone.current._zoneDelegate;\n          if (delegate.handleError && !delegate._patchedHandleError) {\n            const originalHandleError = delegate.handleError;\n            delegate.handleError = function(zone: any, error: any) {\n              const errorStr = error ? String(error.message || error) : '';\n              if (errorStr.includes('replaceAll') || errorStr.includes('fixLink') || errorStr.includes('Cannot read properties')) {\n                return true;\n              }\n              return originalHandleError.call(this, zone, error);\n            };\n            delegate._patchedHandleError = true;\n          }\n        }\n      });\n\n      await page.waitForTimeout(3000);\n      await solveBlockerWithProgress(page, sendEvent);\n      await waitForSearchInputs(page);\n      await submitSearch(page, query);\n      await page.waitForTimeout(4000); // Longer wait after search submission\n      continue;\n    }\n\n    if (pageCheck.noResults) {\n      console.log(\"[collectResults] No results message found on page\");\n      sendEvent({ type: \"status\", message: \"Sidan visar 'Inga träffar'\" });\n      return [];\n    }\n\n    // Try to find result links (matching reference poit.js pattern)\n    const results = await page.evaluate(() => {\n      const seen = new Set<string>();\n      const items: Array<{\n        id: string;\n        url: string;\n        reporter: string;\n        type: string;\n        subject: string;\n        pubDate: string;\n      }> = [];\n\n      // Use the same selector as reference poit.js\n      const links = Array.from(document.querySelectorAll('a.kungorelse__link, a[href*=\"kungorelse/\"]'));\n\n      console.log(\"[collectResults] Found\", links.length, \"potential kungorelse links\");\n\n      for (const link of links) {\n        // Use link.href (resolved URL) instead of getAttribute (like reference code)\n        const href = (link as HTMLAnchorElement).href || \"\";\n        const id = href.split(\"/\").pop()?.split(\"?\")[0] || \"\";\n\n        if (!id || seen.has(id)) continue;\n        seen.add(id);\n\n        // Try multiple ways to find row data (like reference poit.js)\n        const row = link.closest(\"tr\") || link.closest(\"[role=row]\") || link.closest(\"div\");\n        let cells: string[] = [];\n\n        if (row) {\n          // Try td elements first\n          cells = Array.from(row.querySelectorAll(\"td\"))\n            .map((c) => ((c as HTMLElement).innerText || \"\").trim())\n            .filter(Boolean);\n\n          // Try role=\"cell\" elements\n          if (cells.length === 0) {\n            cells = Array.from(row.querySelectorAll('[role=\"cell\"]'))\n              .map((c) => ((c as HTMLElement).innerText || \"\").trim())\n              .filter(Boolean);\n          }\n\n          // Fall back to splitting row text\n          if (cells.length === 0 && (row as HTMLElement).innerText) {\n            cells = (row as HTMLElement).innerText\n              .split(\"\\n\")\n              .map((s) => s.trim())\n              .filter(Boolean);\n          }\n        }\n\n        items.push({\n          id,\n          url: href,\n          reporter: cells[1] || \"\",\n          type: cells[2] || \"\",\n          subject: cells[3] || \"\",\n          pubDate: cells[4] || \"\",\n        });\n      }\n\n      return items;\n    });\n\n    if (results.length > 0) {\n      console.log(`[collectResults] Found ${results.length} results`);\n      return results;\n    }\n\n    // Log page state for debugging\n    const pageState = await page.evaluate(() => {\n      const body = document.body?.innerText || \"\";\n      const html = document.body?.innerHTML || \"\";\n      const hasTable = !!document.querySelector(\"table\");\n      const hasResults = html.includes(\"kungorelse\");\n      const linkCount = document.querySelectorAll(\"a\").length;\n      const url = window.location.href;\n\n      // Debug: find all links that might be kungorelse links\n      const allLinks = Array.from(document.querySelectorAll(\"a\"));\n      const kungorelseLinks = allLinks\n        .filter((a) => (a as HTMLAnchorElement).href.includes(\"kungorelse\"))\n        .map((a) => ({\n          href: (a as HTMLAnchorElement).href,\n          text: ((a as HTMLElement).innerText || \"\").slice(0, 50),\n          className: a.className,\n        }));\n\n      return {\n        url,\n        bodyLength: body.length,\n        hasTable,\n        hasResults,\n        linkCount,\n        kungorelseLinkCount: kungorelseLinks.length,\n        kungorelseLinks: kungorelseLinks.slice(0, 5), // First 5 for debugging\n        sample: body.slice(0, 300),\n      };\n    });\n\n    console.log(`[collectResults] Attempt ${i + 1}: Page state:`, JSON.stringify(pageState, null, 2));\n\n    // Send debug info (only first attempt to avoid spam)\n    if (i === 0) {\n      sendEvent({\n        type: \"status\",\n        message: `Försöker hitta resultat (${pageState.kungorelseLinkCount} kungörelse-länkar av ${pageState.linkCount} totalt)`,\n      });\n    }\n  }\n\n  console.log(\"[collectResults] No results found after retries\");\n  return [];\n}\n\nasync function fetchDetailText(\n  browserOrContext: BrowserContext,\n  item: ScrapedResult,\n  options: {\n    proxyUrl?: string;\n    proxyUsername?: string;\n    proxyPassword?: string;\n    apiTimeout?: number;\n    detailTimeout?: number;\n    waitTextTimeout?: number;\n    postGotoWait?: number;\n  } = {}\n): Promise<{ text: string; got429: boolean }> {\n  // eslint-disable-next-line @typescript-eslint/no-require-imports\n  const { chromium } = require(\"playwright\") as typeof import(\"playwright\");\n\n  const settings = {\n    apiTimeout: options.apiTimeout || 15000,      // Reduced - using 'load' instead of 'networkidle'\n    detailTimeout: options.detailTimeout || 20000, // Reduced - explicit Angular wait is faster\n    waitTextTimeout: options.waitTextTimeout || 15000, // Reduced\n    postGotoWait: options.postGotoWait || 1500,\n  };\n\n  // Create new context with proxy if specified\n  let detailContext: BrowserContext;\n  let shouldCloseContext = false;\n\n  // Use proxy if provided in options\n  if (options.proxyUrl && options.proxyUrl !== \"disabled\") {\n    try {\n      const browser = \"browser\" in browserOrContext ? browserOrContext.browser() : null;\n      if (browser) {\n        // Get cookies from original context to copy to proxy context\n        const originalCookies = await browserOrContext.cookies();\n        console.log(`[fetchDetailText] Copying ${originalCookies.length} cookies to proxy context`);\n\n        detailContext = await browser.newContext({\n          proxy: {\n            server: options.proxyUrl,\n            username: options.proxyUsername,\n            password: options.proxyPassword,\n          },\n          userAgent:\n            \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n          viewport: { width: 1920, height: 1080 },\n          locale: \"sv-SE\",\n          timezoneId: \"Europe/Stockholm\",\n          javaScriptEnabled: true,\n          ignoreHTTPSErrors: true,\n          extraHTTPHeaders: {\n            \"Accept-Language\": \"sv-SE,sv;q=0.9,en;q=0.8\",\n          },\n        });\n\n        // Copy cookies to new context to preserve session\n        if (originalCookies.length > 0) {\n          await detailContext.addCookies(originalCookies);\n        }\n\n        shouldCloseContext = true;\n        console.log(`[fetchDetailText] Using proxy: ${options.proxyUrl}`);\n      } else {\n        detailContext = browserOrContext;\n      }\n    } catch (err) {\n      console.warn(`[fetchDetailText] Failed to create context with proxy:`, err);\n      detailContext = browserOrContext;\n    }\n  } else {\n    detailContext = browserOrContext;\n  }\n\n  const detailPage = await detailContext.newPage();\n  let got429 = false;\n\n  // Anti-detection: Override navigator.webdriver and other detection vectors\n  await detailPage.addInitScript(() => {\n    // Remove webdriver property\n    Object.defineProperty(navigator, 'webdriver', { get: () => undefined });\n\n    // Override permissions query\n    const originalQuery = window.navigator.permissions.query;\n    window.navigator.permissions.query = (parameters: PermissionDescriptor) =>\n      parameters.name === 'notifications'\n        ? Promise.resolve({ state: Notification.permission } as PermissionStatus)\n        : originalQuery(parameters);\n\n    // Add plugins array\n    Object.defineProperty(navigator, 'plugins', {\n      get: () => [1, 2, 3, 4, 5],\n    });\n\n    // Add languages\n    Object.defineProperty(navigator, 'languages', {\n      get: () => ['sv-SE', 'sv', 'en-US', 'en'],\n    });\n\n    // === AGGRESSIVE ANGULAR ERROR SUPPRESSION (Detail Pages) ===\n\n    // 1. Patch String.prototype.replaceAll\n    const originalReplaceAll = String.prototype.replaceAll;\n    (String.prototype as any).replaceAll = function(searchValue: any, replaceValue: any) {\n      if (this === null || this === undefined) {\n        return '';\n      }\n      return originalReplaceAll.call(this, searchValue, replaceValue);\n    };\n\n    // 2. Global window.onerror\n    (window as any).onerror = function(message: string) {\n      if (message && (\n        message.includes(\"Cannot read properties of undefined (reading 'replaceAll')\") ||\n        message.includes(\"Cannot read properties of null\") ||\n        message.includes(\"fixLink\") ||\n        message.includes(\"is not a function\")\n      )) {\n        return true; // Suppress\n      }\n      return false;\n    };\n\n    // 3. Error event listener (capture phase)\n    window.addEventListener('error', (event) => {\n      if (event.message && (\n        event.message.includes(\"Cannot read properties of undefined (reading 'replaceAll')\") ||\n        event.message.includes(\"Cannot read properties of null\") ||\n        event.message.includes(\"fixLink\")\n      )) {\n        event.preventDefault();\n        event.stopPropagation();\n        event.stopImmediatePropagation();\n        return true;\n      }\n    }, true);\n\n    // 4. Unhandled promise rejection handler\n    window.addEventListener('unhandledrejection', (event) => {\n      const reason = event.reason ? String(event.reason) : '';\n      if (reason.includes('replaceAll') || reason.includes('fixLink') || reason.includes('Cannot read properties')) {\n        event.preventDefault();\n      }\n    });\n\n    // 5. Patch Zone.js error handling\n    const patchZone = () => {\n      const Zone = (window as any).Zone;\n      if (Zone && Zone.current && Zone.current._zoneDelegate) {\n        const delegate = Zone.current._zoneDelegate;\n        if (delegate.handleError && !delegate._patchedHandleError) {\n          const originalHandleError = delegate.handleError;\n          delegate.handleError = function(zone: any, error: any) {\n            const errorStr = error ? String(error.message || error) : '';\n            if (errorStr.includes('replaceAll') || errorStr.includes('fixLink') || errorStr.includes('Cannot read properties')) {\n              return true;\n            }\n            return originalHandleError.call(this, zone, error);\n          };\n          delegate._patchedHandleError = true;\n        }\n      }\n    };\n    patchZone();\n    setTimeout(patchZone, 1000);\n    setTimeout(patchZone, 3000);\n  });\n\n  try {\n    // Track 429 errors\n    detailPage.on(\"response\", (res) => {\n      if (res.status() === 429 && res.url().includes(\"/poit/rest/\")) {\n        got429 = true;\n        console.log(`[fetchDetailText] Got 429 for ${item.id}`);\n      }\n    });\n\n    // Set up response listener for API calls\n    let apiText = \"\";\n\n    const apiResponsePromise = detailPage\n      .waitForResponse(\n        (res) =>\n          res.url().includes(\"/poit/rest/SokKungorelse?kungorelseid=\") &&\n          res.status() === 200,\n        { timeout: settings.apiTimeout }\n      )\n      .catch(() => null);\n\n    const detailResponsePromise = detailPage\n      .waitForResponse(\n        (res) =>\n          res.url().includes(\"/poit/rest/HamtaKungorelse?\") &&\n          res.status() === 200,\n        { timeout: settings.detailTimeout }\n      )\n      .catch(() => null);\n\n    // Set referer header to simulate coming from search page\n    await detailPage.setExtraHTTPHeaders({\n      'Referer': 'https://poit.bolagsverket.se/poit-app/sok',\n    });\n\n    // First navigate to homepage to let Angular bootstrap properly\n    console.log(`[fetchDetailText] Initializing Angular via homepage for ${item.id}`);\n    await detailPage.goto(\"https://poit.bolagsverket.se/poit-app/\", { waitUntil: \"load\", timeout: 20000 });\n\n    // Check for and solve CAPTCHA on homepage\n    await solveBlockerSilent(detailPage);\n\n    // Wait for Angular to bootstrap on homepage\n    await detailPage.waitForFunction(\n      () => !!document.querySelector(\"app-root\") || !!document.querySelector(\"[ng-version]\"),\n      { timeout: 10000 }\n    ).catch(() => {\n      console.log(`[fetchDetailText] Angular bootstrap timeout on homepage for ${item.id}`);\n    });\n\n    // Now navigate to the detail page within the Angular app\n    console.log(`[fetchDetailText] Navigating to ${item.url}`);\n    await detailPage.goto(item.url, { waitUntil: \"load\", timeout: 30000 });\n\n    // Check for and solve CAPTCHA on detail page\n    await solveBlockerSilent(detailPage);\n\n    // After CAPTCHA solve, the page may have redirected - always check and re-navigate if needed\n    const currentUrl = await detailPage.url();\n    if (!currentUrl.includes('/kungorelse/') && !currentUrl.includes('/enskild/')) {\n      console.log(`[fetchDetailText] Re-navigating to ${item.url} (was on ${currentUrl})`);\n      await detailPage.goto(item.url, { waitUntil: \"load\", timeout: 30000 });\n      // Check for another CAPTCHA after re-navigation\n      await solveBlockerSilent(detailPage);\n      // Wait a bit for Angular to bootstrap\n      await detailPage.waitForTimeout(2000);\n    }\n\n    // Wait for Angular to route and load detail content\n    await detailPage.waitForFunction(\n      () => {\n        const body = document.body?.innerText || \"\";\n        const hasAngular = !!document.querySelector(\"app-root\") || !!document.querySelector(\"[ng-version]\");\n        // For detail pages, wait for actual kungörelse content\n        const hasDetailContent = body.includes(\"Kungörelsetext\") ||\n                                 body.includes(\"kungörelse\") ||\n                                 body.includes(\"Bolagsverket\") ||\n                                 body.includes(\"enskild\") ||\n                                 body.includes(\"Organisationsnummer\") ||\n                                 body.length > 300;\n        return hasAngular && hasDetailContent;\n      },\n      { timeout: 20000 }\n    ).catch(() => {\n      console.log(`[fetchDetailText] Angular content wait timeout for ${item.id}`);\n    });\n\n    await detailPage.waitForTimeout(settings.postGotoWait);\n\n    // Log page state for debugging\n    const pageState = await detailPage.evaluate(() => {\n      const body = document.body?.innerText || \"\";\n      return {\n        bodyLength: body.length,\n        hasKungorelsetext: body.includes(\"Kungörelsetext\"),\n        url: window.location.href,\n        preview: body.substring(0, 300).replace(/\\s+/g, \" \"),\n        hasAngular: !!document.querySelector(\"app-root\") || !!document.querySelector(\"[ng-version]\"),\n      };\n    }).catch(() => ({ bodyLength: 0, hasKungorelsetext: false, url: \"\", preview: \"\", hasAngular: false }));\n    console.log(`[fetchDetailText] Page state for ${item.id}:`, JSON.stringify(pageState));\n\n    // Wait for content\n    await detailPage\n      .waitForFunction(\n        () => (document.body?.innerText || \"\").includes(\"Kungörelsetext\"),\n        { timeout: settings.waitTextTimeout }\n      )\n      .catch(() => {});\n\n    // Check if detail text is present, if not click the detail link (like Electron app)\n    const initialHasDetail = await detailPage.evaluate(() =>\n      (document.body?.innerText || \"\").includes(\"Kungörelsetext\")\n    );\n\n    if (!initialHasDetail) {\n      // Wait for page to fully load since Angular might be slow\n      await detailPage.waitForTimeout(3000);\n\n      // Debug: log all links on the page\n      const allLinks = await detailPage.evaluate(() => {\n        const links = Array.from(document.querySelectorAll('a'));\n        return links.slice(0, 10).map(a => ({\n          text: a.textContent?.trim().substring(0, 50),\n          href: a.href?.substring(0, 80),\n        }));\n      }).catch(() => []);\n      console.log(`[fetchDetailText] Links on page for ${item.id}:`, JSON.stringify(allLinks));\n\n      // Look for link to announcement detail and click it\n      // Try multiple selectors for \"Visa\" link\n      let clickedLink = false;\n\n      // Try getByRole first (more reliable)\n      const visaByRole = detailPage.getByRole('link', { name: /^Visa\\s/ });\n      if ((await visaByRole.count()) > 0) {\n        console.log(`[fetchDetailText] Clicking \"Visa\" link (by role) for ${item.id}`);\n        await visaByRole.first().click().catch((e) => console.log(`[fetchDetailText] Click failed: ${e.message}`));\n        clickedLink = true;\n      }\n\n      // Fallback to text selector\n      if (!clickedLink) {\n        const visaByText = detailPage.getByText(/^Visa\\s+K\\d+/);\n        if ((await visaByText.count()) > 0) {\n          console.log(`[fetchDetailText] Clicking \"Visa\" link (by text) for ${item.id}`);\n          await visaByText.first().click().catch((e) => console.log(`[fetchDetailText] Click failed: ${e.message}`));\n          clickedLink = true;\n        }\n      }\n\n      // Click kungörelse link (with stealth plugin, clicking works properly)\n      if (!clickedLink) {\n        const kungorelseLink = detailPage.locator('a[href*=\"/poit-app/kungorelse/\"]').first();\n        if ((await kungorelseLink.count()) > 0) {\n          const href = await kungorelseLink.getAttribute('href');\n          console.log(`[fetchDetailText] Clicking kungorelse link for ${item.id}: ${href}`);\n          await kungorelseLink.click().catch((e) =>\n            console.log(`[fetchDetailText] Click failed: ${e.message}`)\n          );\n          clickedLink = true;\n          // Wait for page transition after click\n          await detailPage.waitForTimeout(2000);\n        }\n      }\n\n      if (clickedLink) {\n        // Wait for Angular to bootstrap and render content\n        await detailPage.waitForFunction(\n          () => {\n            const body = document.body?.innerText || \"\";\n            return body.includes(\"Kungörelsetext\") || body.length > 1000;\n          },\n          { timeout: 20000 }\n        ).catch(() => {});\n\n        // Log new page state after navigation\n        const newPageState = await detailPage.evaluate(() => {\n          const body = document.body?.innerText || \"\";\n          return {\n            bodyLength: body.length,\n            hasKungorelsetext: body.includes(\"Kungörelsetext\"),\n            url: window.location.href,\n            preview: body.substring(0, 200).replace(/\\s+/g, \" \"),\n          };\n        }).catch(() => ({ bodyLength: 0, hasKungorelsetext: false, url: \"\", preview: \"\" }));\n        console.log(`[fetchDetailText] After navigation for ${item.id}:`, JSON.stringify(newPageState));\n      } else {\n        console.log(`[fetchDetailText] No kungorelse link found for ${item.id}`);\n      }\n    }\n\n    // Try to get text from API response\n    const apiResponse = await apiResponsePromise;\n    if (apiResponse) {\n      try {\n        const data = await apiResponse.json();\n        apiText = extractTextFromApiData(data);\n      } catch {}\n    }\n\n    if (!apiText) {\n      const detailResponse = await detailResponsePromise;\n      if (detailResponse) {\n        try {\n          const data = await detailResponse.json();\n          apiText = extractTextFromApiData(data);\n        } catch {}\n      }\n    }\n\n    if (apiText) {\n      return { text: apiText, got429 };\n    }\n\n    // Fallback: extract from page DOM\n    const text = await detailPage.evaluate(() => {\n      const body = document.body?.innerText || \"\";\n      if (!body) return \"\";\n      const lines = body.split(\"\\n\").map((s) => s.trim()).filter(Boolean);\n\n      // Try to find \"Kungörelsetext\" section first\n      const idx = lines.findIndex((l) => /kungörelsetext/i.test(l));\n      if (idx >= 0) {\n        let end = lines.findIndex((l, i) => i > idx && /tillbaka|skriv ut/i.test(l));\n        if (end < 0) end = lines.length;\n        return lines.slice(idx + 1, end).join(\"\\n\").trim();\n      }\n\n      // Fallback for \"enskild\" pages - extract content after company info\n      const orgIdx = lines.findIndex((l) => /organisationsnummer|org\\.?\\s*nr/i.test(l));\n      if (orgIdx >= 0) {\n        let end = lines.findIndex((l, i) => i > orgIdx && /tillbaka|skriv ut|stäng/i.test(l));\n        if (end < 0) end = Math.min(orgIdx + 20, lines.length);\n        return lines.slice(orgIdx, end).join(\"\\n\").trim();\n      }\n\n      // Last resort: return first substantial content\n      const contentStart = lines.findIndex((l) => l.length > 50);\n      if (contentStart >= 0) {\n        return lines.slice(contentStart, Math.min(contentStart + 15, lines.length)).join(\"\\n\").trim();\n      }\n\n      return \"\";\n    });\n\n    return { text, got429 };\n  } finally {\n    await detailPage.close();\n    if (shouldCloseContext && detailContext !== browserOrContext) {\n      await detailContext.close().catch(() => {});\n    }\n  }\n}\n\nfunction extractTextFromApiData(data: unknown): string {\n  if (!data) return \"\";\n  const candidates: string[] = [];\n\n  function walk(val: unknown, path: string) {\n    if (!val) return;\n    if (typeof val === \"string\") {\n      const keyHint = /text|kungorelse/i.test(path);\n      const contentHint = /org\\s*nr|företagsnamn|kungörelsetext/i.test(val);\n      if ((keyHint || contentHint) && val.length > 20) {\n        candidates.push(val);\n      }\n      return;\n    }\n    if (Array.isArray(val)) {\n      for (const item of val) walk(item, path);\n      return;\n    }\n    if (typeof val === \"object\" && val !== null) {\n      for (const [key, item] of Object.entries(val)) {\n        walk(item, `${path}.${key}`);\n      }\n    }\n  }\n\n  walk(data, \"root\");\n  if (candidates.length === 0) return \"\";\n  candidates.sort((a, b) => b.length - a.length);\n  return candidates[0].trim();\n}\n\nasync function saveAnnouncements(\n  query: string,\n  orgNumber: string | undefined,\n  results: ScrapedResult[]\n): Promise<number> {\n  const { prisma } = await import(\"@/lib/db\");\n  let saved = 0;\n\n  for (const r of results) {\n    try {\n      await prisma.announcement.upsert({\n        where: { id: r.id },\n        create: {\n          id: r.id,\n          query,\n          reporter: r.reporter || null,\n          type: r.type || null,\n          subject: r.subject,\n          pubDate: r.pubDate || null,\n          publishedAt: r.pubDate ? parseDate(r.pubDate) : null,\n          detailText: r.detailText || null,\n          fullText: r.fullText || null,\n          url: r.url,\n          orgNumber: orgNumber?.replace(/-/g, \"\") || null,\n          scrapedAt: new Date(),\n        },\n        update: {\n          detailText: r.detailText || undefined,\n          fullText: r.fullText || undefined,\n          updatedAt: new Date(),\n        },\n      });\n      saved++;\n    } catch (err) {\n      console.error(`Failed to save announcement ${r.id}:`, err);\n    }\n  }\n\n  return saved;\n}\n\nfunction parseDate(dateStr: string): Date | null {\n  if (!dateStr) return null;\n  const match = dateStr.match(/(\\d{4})-(\\d{2})-(\\d{2})/);\n  if (match) return new Date(dateStr);\n  return null;\n}\n","import {\n  AppRouteRouteModule,\n  type AppRouteRouteHandlerContext,\n  type AppRouteRouteModuleOptions,\n} from '../../server/route-modules/app-route/module.compiled'\nimport { RouteKind } from '../../server/route-kind'\nimport { patchFetch as _patchFetch } from '../../server/lib/patch-fetch'\nimport type { IncomingMessage, ServerResponse } from 'node:http'\nimport { addRequestMeta, getRequestMeta } from '../../server/request-meta'\nimport { getTracer, type Span, SpanKind } from '../../server/lib/trace/tracer'\nimport { setManifestsSingleton } from '../../server/app-render/manifests-singleton'\nimport { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\nimport { NodeNextRequest, NodeNextResponse } from '../../server/base-http/node'\nimport {\n  NextRequestAdapter,\n  signalFromNodeResponse,\n} from '../../server/web/spec-extension/adapters/next-request'\nimport { BaseServerSpan } from '../../server/lib/trace/constants'\nimport { getRevalidateReason } from '../../server/instrumentation/utils'\nimport { sendResponse } from '../../server/send-response'\nimport {\n  fromNodeOutgoingHttpHeaders,\n  toNodeOutgoingHttpHeaders,\n} from '../../server/web/utils'\nimport { getCacheControlHeader } from '../../server/lib/cache-control'\nimport { INFINITE_CACHE, NEXT_CACHE_TAGS_HEADER } from '../../lib/constants'\nimport { NoFallbackError } from '../../shared/lib/no-fallback-error.external'\nimport {\n  CachedRouteKind,\n  type ResponseCacheEntry,\n  type ResponseGenerator,\n} from '../../server/response-cache'\n\nimport * as userland from 'VAR_USERLAND'\n\n// These are injected by the loader afterwards. This is injected as a variable\n// instead of a replacement because this could also be `undefined` instead of\n// an empty string.\ndeclare const nextConfigOutput: AppRouteRouteModuleOptions['nextConfigOutput']\n\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\n// INJECT:nextConfigOutput\n\nconst routeModule = new AppRouteRouteModule({\n  definition: {\n    kind: RouteKind.APP_ROUTE,\n    page: 'VAR_DEFINITION_PAGE',\n    pathname: 'VAR_DEFINITION_PATHNAME',\n    filename: 'VAR_DEFINITION_FILENAME',\n    bundlePath: 'VAR_DEFINITION_BUNDLE_PATH',\n  },\n  distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n  relativeProjectDir: process.env.__NEXT_RELATIVE_PROJECT_DIR || '',\n  resolvedPagePath: 'VAR_RESOLVED_PAGE_PATH',\n  nextConfigOutput,\n  userland,\n})\n\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { workAsyncStorage, workUnitAsyncStorage, serverHooks } = routeModule\n\nfunction patchFetch() {\n  return _patchFetch({\n    workAsyncStorage,\n    workUnitAsyncStorage,\n  })\n}\n\nexport {\n  routeModule,\n  workAsyncStorage,\n  workUnitAsyncStorage,\n  serverHooks,\n  patchFetch,\n}\n\nexport async function handler(\n  req: IncomingMessage,\n  res: ServerResponse,\n  ctx: {\n    waitUntil: (prom: Promise<void>) => void\n  }\n) {\n  if (routeModule.isDev) {\n    addRequestMeta(req, 'devRequestTimingInternalsEnd', process.hrtime.bigint())\n  }\n  let srcPage = 'VAR_DEFINITION_PAGE'\n\n  // turbopack doesn't normalize `/index` in the page name\n  // so we need to to process dynamic routes properly\n  // TODO: fix turbopack providing differing value from webpack\n  if (process.env.TURBOPACK) {\n    srcPage = srcPage.replace(/\\/index$/, '') || '/'\n  } else if (srcPage === '/index') {\n    // we always normalize /index specifically\n    srcPage = '/'\n  }\n  const multiZoneDraftMode = process.env\n    .__NEXT_MULTI_ZONE_DRAFT_MODE as any as boolean\n\n  const prepareResult = await routeModule.prepare(req, res, {\n    srcPage,\n    multiZoneDraftMode,\n  })\n\n  if (!prepareResult) {\n    res.statusCode = 400\n    res.end('Bad Request')\n    ctx.waitUntil?.(Promise.resolve())\n    return null\n  }\n\n  const {\n    buildId,\n    params,\n    nextConfig,\n    parsedUrl,\n    isDraftMode,\n    prerenderManifest,\n    routerServerContext,\n    isOnDemandRevalidate,\n    revalidateOnlyGenerated,\n    resolvedPathname,\n    clientReferenceManifest,\n    serverActionsManifest,\n  } = prepareResult\n\n  const normalizedSrcPage = normalizeAppPath(srcPage)\n\n  let isIsr = Boolean(\n    prerenderManifest.dynamicRoutes[normalizedSrcPage] ||\n      prerenderManifest.routes[resolvedPathname]\n  )\n\n  const render404 = async () => {\n    // TODO: should route-module itself handle rendering the 404\n    if (routerServerContext?.render404) {\n      await routerServerContext.render404(req, res, parsedUrl, false)\n    } else {\n      res.end('This page could not be found')\n    }\n    return null\n  }\n\n  if (isIsr && !isDraftMode) {\n    const isPrerendered = Boolean(prerenderManifest.routes[resolvedPathname])\n    const prerenderInfo = prerenderManifest.dynamicRoutes[normalizedSrcPage]\n\n    if (prerenderInfo) {\n      if (prerenderInfo.fallback === false && !isPrerendered) {\n        if (nextConfig.experimental.adapterPath) {\n          return await render404()\n        }\n        throw new NoFallbackError()\n      }\n    }\n  }\n\n  let cacheKey: string | null = null\n\n  if (isIsr && !routeModule.isDev && !isDraftMode) {\n    cacheKey = resolvedPathname\n    // ensure /index and / is normalized to one key\n    cacheKey = cacheKey === '/index' ? '/' : cacheKey\n  }\n\n  const supportsDynamicResponse: boolean =\n    // If we're in development, we always support dynamic HTML\n    routeModule.isDev === true ||\n    // If this is not SSG or does not have static paths, then it supports\n    // dynamic HTML.\n    !isIsr\n\n  // This is a revalidation request if the request is for a static\n  // page and it is not being resumed from a postponed render and\n  // it is not a dynamic RSC request then it is a revalidation\n  // request.\n  const isStaticGeneration = isIsr && !supportsDynamicResponse\n\n  // Before rendering (which initializes component tree modules), we have to\n  // set the reference manifests to our global store so Server Action's\n  // encryption util can access to them at the top level of the page module.\n  if (serverActionsManifest && clientReferenceManifest) {\n    setManifestsSingleton({\n      page: srcPage,\n      clientReferenceManifest,\n      serverActionsManifest,\n    })\n  }\n\n  const method = req.method || 'GET'\n  const tracer = getTracer()\n  const activeSpan = tracer.getActiveScopeSpan()\n\n  const context: AppRouteRouteHandlerContext = {\n    params,\n    prerenderManifest,\n    renderOpts: {\n      experimental: {\n        authInterrupts: Boolean(nextConfig.experimental.authInterrupts),\n      },\n      cacheComponents: Boolean(nextConfig.cacheComponents),\n      supportsDynamicResponse,\n      incrementalCache: getRequestMeta(req, 'incrementalCache'),\n      cacheLifeProfiles: nextConfig.cacheLife,\n      waitUntil: ctx.waitUntil,\n      onClose: (cb) => {\n        res.on('close', cb)\n      },\n      onAfterTaskError: undefined,\n      onInstrumentationRequestError: (\n        error,\n        _request,\n        errorContext,\n        silenceLog\n      ) =>\n        routeModule.onRequestError(\n          req,\n          error,\n          errorContext,\n          silenceLog,\n          routerServerContext\n        ),\n    },\n    sharedContext: {\n      buildId,\n    },\n  }\n  const nodeNextReq = new NodeNextRequest(req)\n  const nodeNextRes = new NodeNextResponse(res)\n\n  const nextReq = NextRequestAdapter.fromNodeNextRequest(\n    nodeNextReq,\n    signalFromNodeResponse(res)\n  )\n\n  try {\n    const invokeRouteModule = async (span?: Span) => {\n      return routeModule.handle(nextReq, context).finally(() => {\n        if (!span) return\n\n        span.setAttributes({\n          'http.status_code': res.statusCode,\n          'next.rsc': false,\n        })\n\n        const rootSpanAttributes = tracer.getRootSpanAttributes()\n        // We were unable to get attributes, probably OTEL is not enabled\n        if (!rootSpanAttributes) {\n          return\n        }\n\n        if (\n          rootSpanAttributes.get('next.span_type') !==\n          BaseServerSpan.handleRequest\n        ) {\n          console.warn(\n            `Unexpected root span type '${rootSpanAttributes.get(\n              'next.span_type'\n            )}'. Please report this Next.js issue https://github.com/vercel/next.js`\n          )\n          return\n        }\n\n        const route = rootSpanAttributes.get('next.route')\n        if (route) {\n          const name = `${method} ${route}`\n\n          span.setAttributes({\n            'next.route': route,\n            'http.route': route,\n            'next.span_name': name,\n          })\n          span.updateName(name)\n        } else {\n          span.updateName(`${method} ${srcPage}`)\n        }\n      })\n    }\n    const isMinimalMode = Boolean(\n      process.env.MINIMAL_MODE || getRequestMeta(req, 'minimalMode')\n    )\n\n    const handleResponse = async (currentSpan?: Span) => {\n      const responseGenerator: ResponseGenerator = async ({\n        previousCacheEntry,\n      }) => {\n        try {\n          if (\n            !isMinimalMode &&\n            isOnDemandRevalidate &&\n            revalidateOnlyGenerated &&\n            !previousCacheEntry\n          ) {\n            res.statusCode = 404\n            // on-demand revalidate always sets this header\n            res.setHeader('x-nextjs-cache', 'REVALIDATED')\n            res.end('This page could not be found')\n            return null\n          }\n\n          const response = await invokeRouteModule(currentSpan)\n\n          ;(req as any).fetchMetrics = (context.renderOpts as any).fetchMetrics\n          let pendingWaitUntil = context.renderOpts.pendingWaitUntil\n\n          // Attempt using provided waitUntil if available\n          // if it's not we fallback to sendResponse's handling\n          if (pendingWaitUntil) {\n            if (ctx.waitUntil) {\n              ctx.waitUntil(pendingWaitUntil)\n              pendingWaitUntil = undefined\n            }\n          }\n          const cacheTags = context.renderOpts.collectedTags\n\n          // If the request is for a static response, we can cache it so long\n          // as it's not edge.\n          if (isIsr) {\n            const blob = await response.blob()\n\n            // Copy the headers from the response.\n            const headers = toNodeOutgoingHttpHeaders(response.headers)\n\n            if (cacheTags) {\n              headers[NEXT_CACHE_TAGS_HEADER] = cacheTags\n            }\n\n            if (!headers['content-type'] && blob.type) {\n              headers['content-type'] = blob.type\n            }\n\n            const revalidate =\n              typeof context.renderOpts.collectedRevalidate === 'undefined' ||\n              context.renderOpts.collectedRevalidate >= INFINITE_CACHE\n                ? false\n                : context.renderOpts.collectedRevalidate\n\n            const expire =\n              typeof context.renderOpts.collectedExpire === 'undefined' ||\n              context.renderOpts.collectedExpire >= INFINITE_CACHE\n                ? undefined\n                : context.renderOpts.collectedExpire\n\n            // Create the cache entry for the response.\n            const cacheEntry: ResponseCacheEntry = {\n              value: {\n                kind: CachedRouteKind.APP_ROUTE,\n                status: response.status,\n                body: Buffer.from(await blob.arrayBuffer()),\n                headers,\n              },\n              cacheControl: { revalidate, expire },\n            }\n\n            return cacheEntry\n          } else {\n            // send response without caching if not ISR\n            await sendResponse(\n              nodeNextReq,\n              nodeNextRes,\n              response,\n              context.renderOpts.pendingWaitUntil\n            )\n            return null\n          }\n        } catch (err) {\n          // if this is a background revalidate we need to report\n          // the request error here as it won't be bubbled\n          if (previousCacheEntry?.isStale) {\n            const silenceLog = false\n            await routeModule.onRequestError(\n              req,\n              err,\n              {\n                routerKind: 'App Router',\n                routePath: srcPage,\n                routeType: 'route',\n                revalidateReason: getRevalidateReason({\n                  isStaticGeneration,\n                  isOnDemandRevalidate,\n                }),\n              },\n              silenceLog,\n              routerServerContext\n            )\n          }\n          throw err\n        }\n      }\n\n      const cacheEntry = await routeModule.handleResponse({\n        req,\n        nextConfig,\n        cacheKey,\n        routeKind: RouteKind.APP_ROUTE,\n        isFallback: false,\n        prerenderManifest,\n        isRoutePPREnabled: false,\n        isOnDemandRevalidate,\n        revalidateOnlyGenerated,\n        responseGenerator,\n        waitUntil: ctx.waitUntil,\n        isMinimalMode,\n      })\n\n      // we don't create a cacheEntry for ISR\n      if (!isIsr) {\n        return null\n      }\n\n      if (cacheEntry?.value?.kind !== CachedRouteKind.APP_ROUTE) {\n        throw new Error(\n          `Invariant: app-route received invalid cache entry ${cacheEntry?.value?.kind}`\n        )\n      }\n\n      if (!isMinimalMode) {\n        res.setHeader(\n          'x-nextjs-cache',\n          isOnDemandRevalidate\n            ? 'REVALIDATED'\n            : cacheEntry.isMiss\n              ? 'MISS'\n              : cacheEntry.isStale\n                ? 'STALE'\n                : 'HIT'\n        )\n      }\n\n      // Draft mode should never be cached\n      if (isDraftMode) {\n        res.setHeader(\n          'Cache-Control',\n          'private, no-cache, no-store, max-age=0, must-revalidate'\n        )\n      }\n\n      const headers = fromNodeOutgoingHttpHeaders(cacheEntry.value.headers)\n\n      if (!(isMinimalMode && isIsr)) {\n        headers.delete(NEXT_CACHE_TAGS_HEADER)\n      }\n\n      // If cache control is already set on the response we don't\n      // override it to allow users to customize it via next.config\n      if (\n        cacheEntry.cacheControl &&\n        !res.getHeader('Cache-Control') &&\n        !headers.get('Cache-Control')\n      ) {\n        headers.set(\n          'Cache-Control',\n          getCacheControlHeader(cacheEntry.cacheControl)\n        )\n      }\n\n      await sendResponse(\n        nodeNextReq,\n        nodeNextRes,\n        // @ts-expect-error - Argument of type 'Buffer<ArrayBufferLike>' is not assignable to parameter of type 'BodyInit | null | undefined'.\n        new Response(cacheEntry.value.body, {\n          headers,\n          status: cacheEntry.value.status || 200,\n        })\n      )\n      return null\n    }\n\n    // TODO: activeSpan code path is for when wrapped by\n    // next-server can be removed when this is no longer used\n    if (activeSpan) {\n      await handleResponse(activeSpan)\n    } else {\n      await tracer.withPropagatedContext(req.headers, () =>\n        tracer.trace(\n          BaseServerSpan.handleRequest,\n          {\n            spanName: `${method} ${srcPage}`,\n            kind: SpanKind.SERVER,\n            attributes: {\n              'http.method': method,\n              'http.target': req.url,\n            },\n          },\n          handleResponse\n        )\n      )\n    }\n  } catch (err) {\n    if (!(err instanceof NoFallbackError)) {\n      const silenceLog = false\n      await routeModule.onRequestError(\n        req,\n        err,\n        {\n          routerKind: 'App Router',\n          routePath: normalizedSrcPage,\n          routeType: 'route',\n          revalidateReason: getRevalidateReason({\n            isStaticGeneration,\n            isOnDemandRevalidate,\n          }),\n        },\n        silenceLog,\n        routerServerContext\n      )\n    }\n\n    // rethrow so that we can handle serving error page\n\n    // If this is during static generation, throw the error again.\n    if (isIsr) throw err\n\n    // Otherwise, send a 500 response.\n    await sendResponse(\n      nodeNextReq,\n      nodeNextRes,\n      new Response(null, { status: 500 })\n    )\n    return null\n  }\n}\n"],"names":["AppRouteRouteModule","RouteKind","patchFetch","_patchFetch","addRequestMeta","getRequestMeta","getTracer","SpanKind","setManifestsSingleton","normalizeAppPath","NodeNextRequest","NodeNextResponse","NextRequestAdapter","signalFromNodeResponse","BaseServerSpan","getRevalidateReason","sendResponse","fromNodeOutgoingHttpHeaders","toNodeOutgoingHttpHeaders","getCacheControlHeader","INFINITE_CACHE","NEXT_CACHE_TAGS_HEADER","NoFallbackError","CachedRouteKind","userland","routeModule","definition","kind","APP_ROUTE","page","pathname","filename","bundlePath","distDir","process","env","__NEXT_RELATIVE_DIST_DIR","relativeProjectDir","__NEXT_RELATIVE_PROJECT_DIR","resolvedPagePath","nextConfigOutput","workAsyncStorage","workUnitAsyncStorage","serverHooks","handler","req","res","ctx","isDev","hrtime","bigint","srcPage","TURBOPACK","replace","multiZoneDraftMode","__NEXT_MULTI_ZONE_DRAFT_MODE","prepareResult","prepare","statusCode","end","waitUntil","Promise","resolve","buildId","params","nextConfig","parsedUrl","isDraftMode","prerenderManifest","routerServerContext","isOnDemandRevalidate","revalidateOnlyGenerated","resolvedPathname","clientReferenceManifest","serverActionsManifest","normalizedSrcPage","isIsr","Boolean","dynamicRoutes","routes","render404","isPrerendered","prerenderInfo","fallback","experimental","adapterPath","cacheKey","supportsDynamicResponse","isStaticGeneration","method","tracer","activeSpan","getActiveScopeSpan","context","renderOpts","authInterrupts","cacheComponents","incrementalCache","cacheLifeProfiles","cacheLife","onClose","cb","on","onAfterTaskError","undefined","onInstrumentationRequestError","error","_request","errorContext","silenceLog","onRequestError","sharedContext","nodeNextReq","nodeNextRes","nextReq","fromNodeNextRequest","invokeRouteModule","span","handle","finally","setAttributes","rootSpanAttributes","getRootSpanAttributes","get","handleRequest","console","warn","route","name","updateName","isMinimalMode","MINIMAL_MODE","handleResponse","currentSpan","cacheEntry","responseGenerator","previousCacheEntry","setHeader","response","fetchMetrics","pendingWaitUntil","cacheTags","collectedTags","blob","headers","type","revalidate","collectedRevalidate","expire","collectedExpire","value","status","body","Buffer","from","arrayBuffer","cacheControl","err","isStale","routerKind","routePath","routeType","revalidateReason","routeKind","isFallback","isRoutePPREnabled","Error","isMiss","delete","getHeader","set","Response","withPropagatedContext","trace","spanName","SERVER","attributes","url"],"mappings":"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","ignoreList":[3]}}]
}