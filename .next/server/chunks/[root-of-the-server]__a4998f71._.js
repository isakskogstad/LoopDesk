;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="911246e3-c585-aa5f-22f9-6848a28f08bf")}catch(e){}}();
module.exports=[760554,(e,t,a)=>{t.exports=e.x("playwright-core-591c66f494f15234",()=>require("playwright-core-591c66f494f15234"))},443583,e=>{"use strict";var t=e.i(881983);let a=new Map,o=new class{sessionKey="poit_session";async saveCookies(e){try{let t=(await e.cookies()).filter(e=>e.domain.includes("bolagsverket.se")||e.domain.includes("poit")).map(e=>({name:e.name,value:e.value,domain:e.domain,path:e.path,expires:e.expires,httpOnly:e.httpOnly,secure:e.secure,sameSite:e.sameSite}));if(0===t.length)return void console.log("[SessionManager] No POIT cookies to save");let o={cookies:t,savedAt:Date.now()};a.set(this.sessionKey,o),console.log(`[SessionManager] Saved ${t.length} cookies`)}catch(e){console.error("[SessionManager] Error saving cookies:",e)}}async restoreCookies(e){try{let t=a.get(this.sessionKey);if(!t)return console.log("[SessionManager] No saved session found"),!1;if(Date.now()-t.savedAt>144e5)return console.log("[SessionManager] Session expired, clearing"),a.delete(this.sessionKey),!1;let o=Date.now()/1e3,r=t.cookies.filter(e=>-1===e.expires||e.expires>o);if(0===r.length)return console.log("[SessionManager] All cookies expired"),!1;return await e.addCookies(r),console.log(`[SessionManager] Restored ${r.length} cookies`),!0}catch(e){return console.error("[SessionManager] Error restoring cookies:",e),!1}}clearSession(){a.delete(this.sessionKey),console.log("[SessionManager] Session cleared")}hasValidSession(){let e=a.get(this.sessionKey);return!(!e||Date.now()-e.savedAt>144e5)&&e.cookies.length>0}getSessionAge(){let e=a.get(this.sessionKey);return e?Math.floor((Date.now()-e.savedAt)/6e4):null}getStatus(){let e=a.get(this.sessionKey);if(!e)return{hasSession:!1,cookieCount:0,ageMinutes:null,expiresIn:null};let t=Date.now()-e.savedAt,o=144e5-t;return{hasSession:!0,cookieCount:e.cookies.length,ageMinutes:Math.floor(t/6e4),expiresIn:o>0?Math.floor(o/6e4):0}}};var r=e.i(191332),n=e.i(522734),i=e.i(814747);let l="https://poit.bolagsverket.se/poit-app/sok",s=process.env.TWOCAPTCHA_API_KEY||"",c={detailDelayMs:parseInt(process.env.SCRAPER_DETAIL_DELAY_MS||"3000",10),detailConcurrency:parseInt(process.env.SCRAPER_DETAIL_CONCURRENCY||"5",10),maxCaptchaRetries:parseInt(process.env.SCRAPER_MAX_CAPTCHA_RETRIES||"10",10),maxDetailRetries:parseInt(process.env.SCRAPER_MAX_DETAIL_RETRIES||"5",10),navigationTimeout:parseInt(process.env.SCRAPER_NAVIGATION_TIMEOUT||"90000",10),useProxy:"true"===process.env.SCRAPER_USE_PROXY};async function u(){if(!s)return 0;try{let e=new URL("https://2captcha.com/res.php");e.searchParams.set("key",s),e.searchParams.set("action","getbalance"),e.searchParams.set("json","1");let t=await fetch(e.toString()),a=await t.json();if(1===a.status)return parseFloat(a.request);return 0}catch(e){return console.error("Failed to check 2captcha balance:",e),0}}async function d(e){if(!s)throw console.warn("CAPTCHA: TWOCAPTCHA_API_KEY not configured - captcha solving disabled"),Error("TWOCAPTCHA_API_KEY not configured. Set this environment variable to enable captcha solving.");let t=await u();if(t<.001)throw console.warn("CAPTCHA: 2captcha balance too low:",t),Error(`2captcha balance too low: $${t}. Please top up your account.`);console.log("CAPTCHA: Submitting to 2captcha (balance: $"+t.toFixed(3)+")");let a=new URL("https://2captcha.com/in.php");a.searchParams.set("key",s),a.searchParams.set("method","base64"),a.searchParams.set("json","1");let o=e.includes("base64,")?e.split("base64,")[1]:e,r=await fetch(a.toString(),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({body:o})}),n=await r.json();if(1!==n.status)throw console.error("CAPTCHA: Submit failed:",n),Error(`2captcha submit failed: ${n.request}`);let i=n.request;console.log("CAPTCHA: Submitted, ID:",i);let l=new URL("https://2captcha.com/res.php");l.searchParams.set("key",s),l.searchParams.set("action","get"),l.searchParams.set("id",i),l.searchParams.set("json","1");for(let e=0;e<30;e++){await new Promise(e=>setTimeout(e,2e3));let t=await fetch(l.toString()),a=await t.json();if(1===a.status)return console.log("CAPTCHA: Solved successfully"),a.request;if("CAPCHA_NOT_READY"!==a.request)throw console.error("CAPTCHA: Failed:",a),Error(`2captcha failed: ${a.request}`);console.log("CAPTCHA: Waiting for solution... attempt",e+1)}throw Error("2captcha timeout after 60 seconds")}async function g(e){for(let a=1;a<=10;a++){if(!await e.evaluate(()=>{let e=document.body?document.body.innerText:"";return!!document.querySelector("#ans")||e.includes("human visitor")}))return t.proxyManager.recordSuccess(),!0;t.proxyManager.recordCaptcha(),console.log(`CAPTCHA: block detected, attempt ${a}`);let o=await e.evaluate(()=>{let e=Array.from(document.querySelectorAll("img")).find(e=>(e.src||"").includes("base64"));return e?e.src:null});if(!o){await e.goto(e.url(),{waitUntil:"domcontentloaded",timeout:c.navigationTimeout}).catch(()=>{}),await e.waitForTimeout(3e3);continue}try{let t=await d(o);console.log(`CAPTCHA: solved with answer '${t}'`);let a=e.locator("#ans");await a.fill(t),await e.locator("#jar").click(),await e.waitForTimeout(5e3),console.log("CAPTCHA: navigating to search page after solve"),await e.goto(l,{waitUntil:"domcontentloaded",timeout:c.navigationTimeout}).catch(e=>{console.warn("CAPTCHA: navigation after solve failed:",e)}),console.log("CAPTCHA: navigation complete, waiting for page to stabilize"),await e.waitForTimeout(3e3)}catch(t){console.warn("CAPTCHA: solve failed:",t),await e.goto(e.url(),{waitUntil:"domcontentloaded",timeout:c.navigationTimeout}).catch(()=>{}),await e.waitForTimeout(3e3)}}return!1}async function p(e){try{for(let t of['button[data-cookiefirst-action="reject"]','button[data-cookiefirst-action="accept"]',".cookiefirst-root button",'dialog[aria-label*="Cookie"] button','[class*="cookie"] button:first-of-type']){let a=e.locator(t).first();if(await a.count()>0&&await a.isVisible()){await a.click({timeout:3e3}).catch(()=>{}),await e.waitForTimeout(500),console.log("COOKIE: dismissed banner");return}}await e.keyboard.press("Escape"),await e.waitForTimeout(300)}catch{}}async function m(e){await p(e);let t=e.url();console.log(`NAV: current URL is '${t}'`);let a=await e.$("#namn"),o=await e.$("#personOrgnummer");if(a||o)return console.log("NAV: search form already present"),!0;console.log("NAV: opening search form...");let r=e.getByRole("link",{name:/Sök kungörelse/i}),n=await r.count();if(console.log(`NAV: found ${n} 'S\xf6k kung\xf6relse' links`),n>0)try{await Promise.all([r.first().click({timeout:5e3}),e.waitForURL(/\/poit-app\/sok/,{timeout:15e3}).catch(()=>{})]),console.log(`NAV: after click, URL is '${e.url()}'`)}catch(e){console.warn("NAV: click failed, trying force click:",e),await r.first().click({force:!0,timeout:5e3}).catch(()=>{})}else{console.log("NAV: no link found via getByRole, trying evaluate fallback");let t=await e.evaluate(()=>{let e=Array.from(document.querySelectorAll("a")).find(e=>(e.innerText||"").includes("Sök kungörelse"));return!!e&&(e.click(),!0)});console.log(`NAV: evaluate click result: ${t}`)}await e.waitForTimeout(2e3);try{await e.waitForSelector("#namn, #personOrgnummer",{timeout:1e4}),console.log("NAV: input selector appeared")}catch{console.log("NAV: input selector did not appear within 10s")}let i=await e.$("#namn"),l=await e.$("#personOrgnummer"),s=!!(i||l);return console.log(`NAV: after navigation - namn:${!!i}, org:${!!l}, result:${s}`),s}async function f(e){await e.waitForFunction(()=>document.querySelector("#namn")||document.querySelector("#personOrgnummer")||document.querySelector('input[placeholder*="Företagsnamn"]')||document.querySelector('input[placeholder*="Org"]')||document.querySelector('input[name*="namn"]')||document.querySelector('input[name*="org"]'),{timeout:15e3}).catch(()=>{})}async function w(e,t){let a=t.replace(/\D/g,""),o=a.length>=10,r=o?a.length>=10?`${a.slice(0,6)}-${a.slice(6,10)}`:a:t,n=null;for(let t of o?["#personOrgnummer",'input[name*="org"]','input[placeholder*="Org"]']:["#namn",'input[name*="namn"]','input[placeholder*="Företagsnamn"]']){let a=e.locator(t),o=await a.count();if(console.log(`SEARCH: checking selector '${t}' - found ${o} elements`),o>0){n=a.first();break}}if(!n)return console.warn("SEARCH: input not found. Page state:",JSON.stringify(await e.evaluate(()=>{let e=Array.from(document.querySelectorAll("input")).map(e=>({id:e.id,name:e.name,type:e.type,placeholder:e.placeholder}));return{url:window.location.href,allInputs:e,bodyText:document.body?.innerText?.substring(0,500)||""}}))),!1;let i=o?"#personOrgnummer":"#namn";console.log(`SEARCH: setting value via JS for selector '${i}' with '${r}'`),await e.evaluate(({selector:e,value:t})=>{let a=document.querySelector(e);if(!a)return void console.error("Input not found:",e);a.focus();let o=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value")?.set;o?o.call(a,t):a.value=t,a.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),a.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!0})),a.dispatchEvent(new KeyboardEvent("keyup",{bubbles:!0}));let r=a.ngModel;r&&r.$setViewValue(t),a.dispatchEvent(new CustomEvent("ngModelChange",{detail:t,bubbles:!0})),a.blur()},{selector:i,value:r}),await e.waitForTimeout(500);let l=await e.evaluate(e=>{let t=document.querySelector(e);return t?t.value:null},i);if(console.log(`SEARCH: input value is now '${l}'`),!l){console.log("SEARCH: JS set failed, trying click + type fallback"),await n.click(),await e.waitForTimeout(200),await e.keyboard.type(r,{delay:30}),await e.waitForTimeout(300);let t=await e.evaluate(e=>{let t=document.querySelector(e);return t?t.value:null},i);console.log(`SEARCH: fallback input value is now '${t}'`)}console.log("SEARCH: clicking search button...");let s=e.getByRole("button",{name:/Sök kungörelse/i});if(await s.count()){if(!await s.first().isEnabled())return console.warn("SEARCH: search button disabled, query likely invalid."),"disabled";await s.first().click(),console.log("SEARCH: button clicked via getByRole")}else console.log("SEARCH: button clicked via evaluate:",await e.evaluate(()=>{let e=Array.from(document.querySelectorAll("button")).find(e=>(e.innerText||"").includes("Sök kungörelse"));return!!e&&(e.click(),!0)}));return await e.waitForTimeout(2e3),console.log("SEARCH: post-click state:",JSON.stringify(await e.evaluate(()=>{let e=window.location.href,t=document.body?.innerText||"",a=null!==document.querySelector("#namn")||null!==document.querySelector("#personOrgnummer"),o=t.includes("Antal träffar")||t.includes("inga träffar");return{url:e,hasSearchForm:a,hasResults:o,isLoading:t.includes("Laddar")||t.includes("Söker"),bodyPreview:t.substring(0,300).replace(/\s+/g," ")}}))),!0}async function h(e){return(await e.evaluate(()=>{let e=new Set,t=[];for(let a of Array.from(document.querySelectorAll('a[href*="kungorelse/"]'))){let o=a.getAttribute("href")||"",r=o.split("/").pop()?.split("?")[0]||"";if(!r||e.has(r))continue;e.add(r);let n=a.closest("tr")||a.closest("[role=row]")||a.closest("div"),i=[];n&&(0===(i=Array.from(n.querySelectorAll("td")).map(e=>(e.innerText||"").trim()).filter(Boolean)).length&&(i=Array.from(n.querySelectorAll('[role="cell"]')).map(e=>(e.innerText||"").trim()).filter(Boolean)),0===i.length&&n.innerText&&(i=(n.innerText||"").split("\n").map(e=>e.trim()).filter(Boolean))),t.push({id:r,url:a.href,cells:i,rowText:n&&n.innerText||""})}return t})).map(e=>{let t=e.cells||[],a="",o="",r="",n="";return t.length>=5?(a=t[1]||"",o=t[2]||"",r=t[3]||"",n=t[4]||""):t.length>0&&(r=t.join(" ")),{id:e.id,url:e.url,cells:e.cells,rowText:e.rowText,reporter:a,type:o,subject:r,pubDate:n}})}async function y(a,o,r={}){let n,{chromium:i}=e.r(760554),l={apiTimeout:r.apiTimeout||3e4,detailTimeout:r.detailTimeout||4e4,waitTextTimeout:r.waitTextTimeout||3e4,postGotoWait:r.postGotoWait||1500},s=!1;if(r.proxyUrl&&c.useProxy)try{let e="browser"in a?a.browser():null;e?(n=await e.newContext({proxy:{server:r.proxyUrl,username:r.proxyUsername,password:r.proxyPassword}}),s=!0,console.log(`[fetchDetailText] Using proxy: ${r.proxyUrl}`)):n=a}catch(e){console.warn("[fetchDetailText] Failed to create context with proxy:",e),n=a}else n=a;let u=await n.newPage(),d=!1;try{u.on("response",e=>{429===e.status()&&e.url().includes("/poit/rest/")&&(d=!0,console.log(`[fetchDetailText] Got 429 for ${o.id}`),t.proxyManager.recordRateLimit())});let e="",a=u.waitForResponse(e=>e.url().includes("/poit/rest/SokKungorelse?kungorelseid=")&&200===e.status(),{timeout:l.apiTimeout}).catch(()=>null),r=u.waitForResponse(e=>e.url().includes("/poit/rest/HamtaKungorelse?")&&200===e.status(),{timeout:l.detailTimeout}).catch(()=>null);if(await u.goto(o.url,{waitUntil:"networkidle",timeout:c.navigationTimeout}),await u.waitForTimeout(l.postGotoWait),await g(u),await u.waitForFunction(()=>(document.body?.innerText||"").includes("Kungörelsetext"),{timeout:l.waitTextTimeout}).catch(()=>{}),!await u.evaluate(()=>(document.body?.innerText||"").includes("Kungörelsetext"))){let e=u.locator('a.kungorelse__link, a[href*="/poit-app/kungorelse/"]');await e.count()>0&&(await e.first().click().catch(()=>{}),await u.waitForTimeout(1500),await u.waitForFunction(()=>(document.body?.innerText||"").includes("Kungörelsetext"),{timeout:l.waitTextTimeout}).catch(()=>{}))}let n=await a;if(n)try{let t=await n.json();e=A(t)}catch{}if(!e){let t=await r;if(t)try{let a=await t.json();e=A(a)}catch{}}if(e)return{text:e,got429:d};return{text:await u.evaluate(()=>{let e=document.body?.innerText||"";if(!e)return"";let t=e.split("\n").map(e=>e.trim()).filter(Boolean),a=t.findIndex(e=>/kungörelsetext/i.test(e));if(a<0)return"";let o=t.findIndex((e,t)=>t>a&&/tillbaka|skriv ut/i.test(e));return o<0&&(o=t.length),t.slice(a+1,o).join("\n").trim()}),got429:d}}finally{await u.close(),s&&n!==a&&await n.close().catch(()=>{})}}function A(e){if(!e)return"";let t=[];return(!function e(a,o){if(a){if("string"==typeof a){let e=/text|kungorelse/i.test(o),r=/org\s*nr|företagsnamn|kungörelsetext/i.test(a);(e||r)&&a.length>20&&t.push(a);return}if(Array.isArray(a)){for(let t of a)e(t,o);return}if("object"==typeof a&&null!==a)for(let[t,r]of Object.entries(a))e(r,`${o}.${t}`)}}(e,"root"),0===t.length)?"":(t.sort((e,t)=>t.length-e.length),t[0].trim())}async function b(e){console.log("[findResults] Waiting for results to load..."),console.log("[findResults] Initial page state:",JSON.stringify(await e.evaluate(()=>{let e=document.body?.innerText||"",t=document.querySelectorAll('a[href*="kungorelse/"]').length,a=/antal\s*träffar/i.test(e),o=/inga\s*träffar/i.test(e),r=null!==document.querySelector("table");return{linkCount:t,hasCount:a,noResults:o,hasTable:r,hasLoader:e.includes("Laddar")||e.includes("Söker"),bodyPreview:e.substring(0,500).replace(/\s+/g," ")}})));try{if(await e.waitForFunction(()=>{let e=document.body?.innerText||"",t=document.querySelectorAll('a[href*="kungorelse/"]').length>0,a=/antal\s*träffar/i.test(e),o=/inga\s*träffar/i.test(e),r=/okänt\s*fel|försök\s*igen\s*senare/i.test(e);return t||a||o||r},{timeout:3e4}),await e.evaluate(()=>{let e=document.body?.innerText||"";return/okänt\s*fel|försök\s*igen\s*senare/i.test(e)}))return console.warn('[findResults] Bolagsverket returned error: "Okänt fel. Försök igen senare."'),console.log("[findResults] This may be due to proxy/session issue - signaling error for retry"),{results:[],error:"unknown_error"};console.log("[findResults] Page loaded, checking results...")}catch(t){console.warn("[findResults] Timeout waiting for results indicator"),console.log("[findResults] Timeout state:",JSON.stringify(await e.evaluate(()=>{let e=document.body?.innerText||"",t=document.querySelectorAll('a[href*="kungorelse/"]').length;return{linkCount:t,bodyPreview:e.substring(0,800).replace(/\s+/g," "),allLinks:Array.from(document.querySelectorAll("a")).map(e=>e.href).slice(0,10)}})))}for(let t=0;t<10;t++){await e.waitForTimeout(1500),await g(e);let a=await h(e);if(a.length>0)return console.log(`[findResults] Found ${a.length} results on attempt ${t+1}`),{results:a};let o=await e.textContent("body")||"";if(o.toLowerCase().includes("inga träffar"))return console.log('[findResults] Page shows "inga träffar"'),{results:[]};let r=o.match(/antal\s*träffar:\s*(\d+)/i);if(r){let a=parseInt(r[1],10);if(console.log(`[findResults] Page shows "Antal tr\xe4ffar: ${a}", attempt ${t+1}`),0===a)return{results:[]};t<9&&(console.log("[findResults] Results expected but not found, waiting more..."),await e.waitForTimeout(2e3))}}return console.log("[findResults] No results found after all attempts"),{results:[],error:"timeout"}}async function x(e,t,a){let o=e.map((e,t)=>({item:e,index:t})),r=[];for(let e=0;e<t;e++){let t=(async()=>{for(;o.length>0;){let t=o.shift();if(!t)break;try{await a(t.item,t.index)}catch(a){console.error(`[Worker ${e}] Task ${t.index} failed:`,a)}}})();r.push(t)}await Promise.all(r)}async function v(e,a){let o=0;await x(a,c.detailConcurrency,async a=>{try{let r=Date.now()-o;if(r<c.detailDelayMs&&o>0){let e=c.detailDelayMs-r;console.log(`[enrichWithDetails] Waiting ${e}ms before next fetch...`),await new Promise(t=>setTimeout(t,e))}o=Date.now();let n="",i=5e3;for(let r=1;r<=c.maxDetailRetries;r++){let l=t.proxyManager.getCurrentProxy(),s=l?.server;s&&r>1&&console.log(`[enrichWithDetails] Switching to proxy: ${s}`);let u=await y(e,a,{proxyUrl:s,proxyUsername:l?.username,proxyPassword:l?.password});if(n=u.text||"",u.got429){console.warn(`[enrichWithDetails] Got 429 for ${a.id}, attempt ${r}/${c.maxDetailRetries}`);let{shouldActivate:e,reason:n}=t.proxyManager.shouldActivate();e&&n&&(console.log(`[enrichWithDetails] Activating proxy: ${n}`),await t.proxyManager.activate(n)),t.proxyManager.getStatus().isActive?(t.proxyManager.rotateProxy(),console.log("[enrichWithDetails] Rotated proxy, retrying...")):(console.warn(`[enrichWithDetails] Waiting ${i}ms...`),await new Promise(e=>setTimeout(e,i)),i*=2),o=Date.now();continue}if(n&&n.trim()){t.proxyManager.recordSuccess();break}r<c.maxDetailRetries&&(console.log(`[enrichWithDetails] Empty text for ${a.id}, retrying (attempt ${r}/${c.maxDetailRetries})`),await new Promise(e=>setTimeout(e,4e3)))}if(!n||!n.trim()){console.log(`[enrichWithDetails] Final retry with extended timeouts for ${a.id}`),await new Promise(e=>setTimeout(e,c.detailDelayMs+2e3));let r=t.proxyManager.getCurrentProxy();n=(await y(e,a,{proxyUrl:r?.server,proxyUsername:r?.username,proxyPassword:r?.password,apiTimeout:35e3,detailTimeout:5e4,waitTextTimeout:35e3,postGotoWait:3e3})).text||"",o=Date.now()}n?(a.detailText=!function(e){return!!e&&((e?e.trim().split(/\s+/).filter(Boolean).length:0)>100||e.trim().length>1e3)}(n)?n:function(e,t){if(!e)return"";let a=e.trim().split(/\s+/);return a.length<=100?e.trim():`${a.slice(0,100).join(" ")} ...`}(n,0),a.fullText=n):console.warn(`[enrichWithDetails] Empty text for ${a.id} after all retries`)}catch(e){console.warn(`[enrichWithDetails] Failed ${a.id}:`,e)}})}async function S(a,s={}){let{chromium:u}=e.r(760554);await (0,r.forceRefreshProxies)();let d=process.env.PROXY_SERVER||"";if(c.useProxy||d&&"disabled"!==d||process.env.TWOCAPTCHA_API_KEY)t.proxyManager.getStatus().isActive||(console.log("[Scraper] Activating proxy for Bolagsverket (always required)"),await t.proxyManager.activate("Bolagsverket requires proxy"));else{let{shouldActivate:e,reason:a}=t.proxyManager.shouldActivate();e&&a&&(console.log(`[Scraper] Activating proxy: ${a}`),await t.proxyManager.activate(a))}let p=t.proxyManager.getPlaywrightConfig();p.proxy?console.log(`[Scraper] Using proxy: ${p.proxy.server}`):console.log("[Scraper] WARNING: No proxy configured - Bolagsverket may block requests");let h=function(){let e=process.env.PLAYWRIGHT_BROWSERS_PATH||"/ms-playwright";try{let t=(0,n.readdirSync)(e);for(let a of t)if(a.startsWith("chromium-")&&!a.includes("headless")){let t=(0,i.join)(e,a,"chrome-linux","chrome");if((0,n.existsSync)(t))return console.log("[Scraper] Found full Chromium at:",t),t}for(let a of t)if(a.startsWith("chromium_headless_shell-")){let t=(0,i.join)(e,a,"chrome-headless-shell-linux64","chrome-headless-shell");if((0,n.existsSync)(t))return console.log("[Scraper] Found headless shell at:",t),t}}catch(e){console.warn("[Scraper] Could not search for Chromium:",e)}}();h?console.log("[Scraper] Using Chromium:",h):console.log("[Scraper] No custom Chromium path, using default");let y=await u.launch({headless:!0,executablePath:h,args:["--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage"],...p}),A=await y.newContext();await o.restoreCookies(A)&&console.log("[Scraper] Restored session cookies");let x=await A.newPage(),T=!!p.proxy;T&&console.log("[Scraper] Skipping Angular bundle patching (proxy active - causes socket hang up)"),await x.route("**/assets/index-*.js",async e=>{if(T)return void await e.continue();console.log("[Scraper] Intercepting Angular bundle:",e.request().url());try{let t=await e.fetch(),a=await t.text(),o=a.length,r=0,n=a.length;(a=a.replace(/fixLink:function\((\w)\)\{return \1\.replaceAll/g,'fixLink:function($1){if($1==null)return"";return $1.replaceAll')).length!==n&&r++;let i=a.length;(a=a.replace(/throw new Error\('Missing required param "'\+(\w)\+'"\)/g,'console.warn("[Patched] Missing param:",$1);return""')).length!==i&&r++;let l=a.length;(a=a.replace(/throw new Error\(`Missing required param "\$\{(\w)\}"`\)/g,'console.warn("[Patched] Missing param:",$1);return""')).length!==l&&r++;let s=a.length;(a=a.replace(/kungorelseid:(\w)\.id/g,'kungorelseid:$1&&$1.id||"0"')).length!==s&&r++,console.log(`[Scraper] Angular bundle patches: ${r} applied (${o} -> ${a.length})`),await e.fulfill({response:t,body:a,headers:{...t.headers(),"Content-Length":String(a.length)}})}catch(t){console.warn("[Scraper] Failed to patch Angular bundle:",t);try{await e.continue()}catch(t){console.warn("[Scraper] route.continue() also failed, aborting route:",t);try{await e.abort("failed")}catch{}}}});try{console.log(`START: query='${a}'`),await x.goto(l,{waitUntil:"networkidle",timeout:c.navigationTimeout}),await x.waitForTimeout(1e3),await g(x);let e=await m(x);await g(x),e||(await x.goto(l,{waitUntil:"networkidle",timeout:c.navigationTimeout}),await x.waitForTimeout(1e3),await g(x),e=await m(x)),await f(x);let o=function(e){let t=(e||"").trim(),a=t?[t]:[],o=t.replace(/\D/g,"");if(10===o.length){let e=`${o.slice(0,6)}-${o.slice(6)}`;e!==t&&a.push(e),o!==t&&a.push(o)}if(/[a-zA-Z]/.test(t)){let e=t.replace(/[0-9\-]+/g," ").replace(/\s+/g," ").trim();e&&e!==t&&a.push(e)}return Array.from(new Set(a))}(a),n=[],i=a;for(let e=0;e<o.length;e++){let a=o[e];i=a;let s=!1,u=!1;for(let e=1;e<=3;e++){let t=await w(x,a);if(!0===t){s=!0;break}if("disabled"===t){u=!0;break}console.warn(`SEARCH: retrying input lookup (${e})`);try{await x.goto(l,{waitUntil:"domcontentloaded",timeout:c.navigationTimeout})}catch(t){console.warn(`SEARCH: navigation failed on retry ${e}:`,t),await x.goto(l,{waitUntil:"networkidle",timeout:c.navigationTimeout}).catch(()=>{})}await x.waitForTimeout(1e3),await g(x),await m(x)}if(!s){if(u){console.log(`SEARCH: query '${a}' invalid, trying next variant...`);continue}throw Error("Search input not found after retries.")}await x.waitForTimeout(1e3);let d=await b(x);if(n=d.results,console.log(`RESULTS: found ${n.length} for query='${a}'`),"unknown_error"===d.error){if(console.log('RESULTS: Got "Okänt fel" - rotating proxy and restarting session...'),t.proxyManager.getStatus().isActive){let e=t.proxyManager.getCurrentProxy();t.proxyManager.markFailed(e),t.proxyManager.rotateProxy(),console.log("RESULTS: Marked proxy as failed and rotated");let a=t.proxyManager.getStatus();0===a.available&&(console.log("RESULTS: All proxies exhausted, refreshing from API..."),await (0,r.forceRefreshProxies)())}await x.goto(l,{waitUntil:"domcontentloaded",timeout:c.navigationTimeout}).catch(e=>{console.warn("RESULTS: Navigation after rotation failed:",e)});let e=x.url();if(e.includes("chrome-error://")||e.includes("chromewebdata")){console.error("RESULTS: Proxy connection crashed (chrome-error) - cannot retry in same browser");break}await x.waitForTimeout(2e3),await g(x),await m(x),await f(x);let o=await w(x,a);!0===o&&(await x.waitForTimeout(1e3),n=(await b(x)).results,console.log(`RESULTS: retry found ${n.length} for query='${a}'`))}if(n.length>0)break;e<o.length-1&&(console.log(`SEARCH: no results for '${a}', trying next variant...`),await g(x),await m(x),await f(x))}if(!s.skipDetails){let e=s.detailLimit||n.length,t=n.slice(0,e);console.log(`[searchAnnouncements] Enriching ${t.length} results with details...`),await v(A,t),console.log("[searchAnnouncements] Detail enrichment complete")}let u=n.map(e=>({id:e.id,query:i,reporter:e.reporter,type:e.type,subject:e.subject||"",pubDate:e.pubDate,publishedAt:e.pubDate?function(e){if(!e)return;if(e.match(/(\d{4})-(\d{2})-(\d{2})/))return new Date(e);let t=e.toLowerCase().match(/(\d{1,2})\s+(\w{3})\s+(\d{4})/);if(t){let e=parseInt(t[1],10),a={jan:0,feb:1,mar:2,apr:3,maj:4,jun:5,jul:6,aug:7,sep:8,okt:9,nov:10,dec:11}[t[2]],o=parseInt(t[3],10);if(void 0!==a)return new Date(o,a,e)}}(e.pubDate):void 0,detailText:e.detailText,fullText:e.fullText,url:e.url,scrapedAt:new Date}));return console.log(`COMPLETE: ${u.length} announcements found`),u}finally{try{await o.saveCookies(A)}catch(e){console.warn("[Scraper] Failed to save cookies:",e)}await A.close(),await y.close()}}async function T(t,a={}){let{prisma:o}=await e.A(606844),r=await S(t,a);for(let e of r)try{await o.announcement.upsert({where:{id:e.id},create:{id:e.id,query:e.query,reporter:e.reporter,type:e.type,subject:e.subject,pubDate:e.pubDate,publishedAt:e.publishedAt,detailText:e.detailText,fullText:e.fullText,url:e.url,orgNumber:function(e,t){let a=`${e} ${t}`.match(/(\d{6}[-]?\d{4})/);if(a)return a[1].replace("-","")}(e.subject,e.query),scrapedAt:e.scrapedAt||new Date},update:{detailText:e.detailText,fullText:e.fullText,updatedAt:new Date}})}catch(t){console.error(`Failed to save announcement ${e.id}:`,t)}try{await o.announcementScrapeStats.upsert({where:{id:"stats"},create:{id:"stats",totalSearches:1,totalAnnouncements:r.length,lastSearchAt:new Date},update:{totalSearches:{increment:1},totalAnnouncements:{increment:r.length},lastSearchAt:new Date}})}catch(e){console.error("Failed to update stats:",e)}return r}async function k(t={}){let{prisma:a}=await e.A(606844),o={};t.query&&(o.OR=[{subject:{contains:t.query,mode:"insensitive"}},{query:{contains:t.query,mode:"insensitive"}},{detailText:{contains:t.query,mode:"insensitive"}}]),t.orgNumber&&(o.orgNumber=t.orgNumber),t.type&&(o.type=t.type),(t.fromDate||t.toDate)&&(o.publishedAt={},t.fromDate&&(o.publishedAt.gte=t.fromDate),t.toDate&&(o.publishedAt.lte=t.toDate));let[r,n]=await Promise.all([a.announcement.findMany({where:o,orderBy:{publishedAt:"desc"},skip:t.offset||0,take:t.limit||50}),a.announcement.count({where:o})]);return{announcements:r.map(e=>({id:e.id,query:e.query,reporter:e.reporter||void 0,type:e.type||void 0,subject:e.subject,pubDate:e.pubDate||void 0,publishedAt:e.publishedAt||void 0,detailText:e.detailText||void 0,fullText:e.fullText||void 0,url:e.url||void 0,orgNumber:e.orgNumber||void 0,scrapedAt:e.scrapedAt})),total:n}}async function C(t={}){let{prisma:a}=await e.A(606844),o={};t.query&&(o.OR=[{subject:{contains:t.query,mode:"insensitive"}},{query:{contains:t.query,mode:"insensitive"}},{detailText:{contains:t.query,mode:"insensitive"}}]),t.orgNumber&&(o.orgNumber=t.orgNumber),t.type&&(o.type=t.type),(t.fromDate||t.toDate)&&(o.publishedAt={},t.fromDate&&(o.publishedAt.gte=t.fromDate),t.toDate&&(o.publishedAt.lte=t.toDate));let r=t.limit||50,n=await a.announcement.findMany({where:o,orderBy:[{publishedAt:"desc"},{id:"desc"}],cursor:t.cursor?{id:t.cursor}:void 0,skip:+!!t.cursor,take:r+1}),i=n.length>r,l=i?n.slice(0,r):n,s=i?l[l.length-1].id:null,c=await a.announcement.count({where:o});return{announcements:l.map(e=>({id:e.id,query:e.query,reporter:e.reporter||void 0,type:e.type||void 0,subject:e.subject,pubDate:e.pubDate||void 0,publishedAt:e.publishedAt||void 0,detailText:e.detailText||void 0,fullText:e.fullText||void 0,url:e.url||void 0,orgNumber:e.orgNumber||void 0,scrapedAt:e.scrapedAt})),total:c,nextCursor:s,hasMore:i}}async function R(t){let{prisma:a}=await e.A(606844),o=await a.announcement.findUnique({where:{id:t}});return o?{id:o.id,query:o.query,reporter:o.reporter||void 0,type:o.type||void 0,subject:o.subject,pubDate:o.pubDate||void 0,publishedAt:o.publishedAt||void 0,detailText:o.detailText||void 0,fullText:o.fullText||void 0,url:o.url||void 0,orgNumber:o.orgNumber||void 0,scrapedAt:o.scrapedAt}:null}async function P(t){let{prisma:a}=await e.A(606844);return(await a.announcement.findMany({where:{orgNumber:t},orderBy:{publishedAt:"desc"}})).map(e=>({id:e.id,query:e.query,reporter:e.reporter||void 0,type:e.type||void 0,subject:e.subject,pubDate:e.pubDate||void 0,publishedAt:e.publishedAt||void 0,detailText:e.detailText||void 0,fullText:e.fullText||void 0,url:e.url||void 0,orgNumber:e.orgNumber||void 0,scrapedAt:e.scrapedAt}))}async function $(){let{prisma:t}=await e.A(606844),a=await t.announcementScrapeStats.findUnique({where:{id:"stats"}});return a?{totalSearches:a.totalSearches,totalAnnouncements:a.totalAnnouncements,lastSearchAt:a.lastSearchAt,captchaSolves:a.captchaSolves,errors:a.errors,isRunning:a.isRunning,concurrentSearches:a.concurrentSearches,delayMs:a.delayMs}:{totalSearches:0,totalAnnouncements:0,lastSearchAt:null,captchaSolves:0,errors:0,isRunning:!1,concurrentSearches:5,delayMs:3e3}}async function D(){let{prisma:t}=await e.A(606844);return(await t.announcement.findMany({select:{type:!0},distinct:["type"],where:{type:{not:null}}})).map(e=>e.type).filter(e=>null!==e)}e.s(["getAnnouncementById",()=>R,"getAnnouncementTypes",()=>D,"getAnnouncements",()=>k,"getAnnouncementsCursor",()=>C,"getCompanyAnnouncements",()=>P,"getScrapeStats",()=>$,"searchAndSaveAnnouncements",()=>T],443583)}];

//# debugId=911246e3-c585-aa5f-22f9-6848a28f08bf
//# sourceMappingURL=%5Broot-of-the-server%5D__a4998f71._.js.map