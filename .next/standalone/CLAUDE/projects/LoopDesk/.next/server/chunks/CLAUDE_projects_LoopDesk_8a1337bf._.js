;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="0ffa4b1a-9cb1-e892-8b0f-fb98897337e2")}catch(e){}}();
module.exports=[642694,e=>e.a(async(t,a)=>{try{var n=e.i(528227),r=t([n]);function s(e){let t=e.replace(/\D/g,"");return 10===t.length?`${t.slice(0,6)}-${t.slice(6)}`:t}async function o(e){let t=e.replace(/\D/g,""),a=await fetch(`https://www.allabolag.se/${t}`,{headers:{"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36",Accept:"text/html,application/xhtml+xml"}});if(!a.ok){if(404===a.status)return null;throw Error(`Allabolag returned ${a.status}`)}let n=(await a.text()).match(/<script id="__NEXT_DATA__"[^>]*>([\s\S]*?)<\/script>/);if(!n)throw Error("Could not find __NEXT_DATA__ in response");return JSON.parse(n[1]).props.pageProps.company}function i(e){if(!e||"-"===e||""===e)return null;let t=e.replace(/,/g,".").replace(/\s/g,"");return parseFloat(t)||null}async function l(e){let{limit:t=20}=await e.json(),a=new TextEncoder,r=new ReadableStream({async start(e){let r=t=>{e.enqueue(a.encode(`data: ${JSON.stringify(t)}

`))};try{let e=new Date(Date.now()-864e5),a=Math.min(t,100);r({type:"status",message:"Hämtar bolag att berika...",phase:"init"});let u=await n.prisma.watchedCompany.findMany({where:{OR:[{lastEnriched:null},{lastEnriched:{lt:e}}]},select:{orgNumber:!0,name:!0},take:a,orderBy:{lastEnriched:{sort:"asc",nulls:"first"}}}),c=u.length,p=await n.prisma.watchedCompany.count({where:{OR:[{lastEnriched:null},{lastEnriched:{lt:e}}]}});r({type:"start",message:`B\xf6rjar berika ${c} bolag`,total:c,remaining:p-c,phase:"processing"});let d=0,m=0;for(let e=0;e<u.length;e++){let t=u[e],a=Math.round((e+1)/c*100);r({type:"progress",current:e+1,total:c,progress:a,company:t.name,orgNumber:t.orgNumber,message:`H\xe4mtar data f\xf6r ${t.name}...`,phase:"fetching"});try{var l;let u=t.orgNumber.replace(/\D/g,""),p=s(t.orgNumber),h=await n.prisma.watchedCompany.findUnique({where:{orgNumber:p}});if(h||(h=await n.prisma.watchedCompany.findUnique({where:{orgNumber:u}})),!h){r({type:"error",current:e+1,company:t.name,message:`${t.name}: Finns inte i bevakningslistan`,phase:"error"}),m++;continue}let g=h.orgNumber;r({type:"progress",current:e+1,total:c,progress:a,company:t.name,message:`H\xe4mtar fr\xe5n Allabolag...`,phase:"fetching"});let y=await o(u);if(!y){await n.prisma.watchedCompany.update({where:{orgNumber:g},data:{enrichmentError:"Hittades inte på Allabolag",lastEnriched:new Date}}),r({type:"warning",current:e+1,company:t.name,message:`${t.name}: Hittades inte p\xe5 Allabolag`,phase:"warning"}),m++;continue}let f=null,w=null,R=null;if(y.companyAccounts&&y.companyAccounts.length>0){let e=y.companyAccounts[0];R=e.year,f=i(e.accounts.find(e=>"nettoomsattning"===e.code)?.amount),w=i(e.accounts.find(e=>"ars_resultat"===e.code)?.amount)}r({type:"progress",current:e+1,total:c,progress:a,company:t.name,message:`Sparar ${t.name}...`,phase:"saving"}),await n.prisma.watchedCompany.update({where:{orgNumber:g},data:{name:y.name||h.name,legalName:y.legalName||null,companyType:y.companyType?.name||null,status:y.status?.status||null,registrationDate:y.registrationDate||null,ceo:y.roles?.manager?.name||h.ceo||null,chairman:y.roles?.chairman?.name||null,city:h.city||y.location?.municipality||y.postalAddress?.postPlace||null,municipality:y.location?.municipality||null,startYear:h.startYear||y.foundationYear||null,employees:y.numberOfEmployees?parseInt(y.numberOfEmployees):y.employees?parseInt(y.employees):null,address:y.postalAddress?.addressLine||null,postalCode:y.postalAddress?.zipCode||null,phone:y.phone||null,email:y.email||null,website:y.homePage||null,sniCode:y.industries?.[0]?.code||null,sniDescription:y.industries?.[0]?.name||null,paymentRemarks:y.paymentRemarks??null,fSkatt:y.registeredForPayrollTax??null,momsRegistered:y.registeredForVat??null,parentCompany:y.corporateStructure?.parentCompanyName||null,subsidiaryCount:y.corporateStructure?.numberOfSubsidiaries||null,shareCapital:y.shareCapital?BigInt(y.shareCapital):null,largestOwners:h.largestOwners||((l=y.shareholders)&&0!==l.length?l.slice(0,5).map(e=>`${e.name}${e.ownership?` (${e.ownership}%)`:""}`).join(", "):null),turnover2024:h.turnover2024||(2024===R&&f?`${f} tkr`:h.turnover2024),profit2024:h.profit2024||(2024===R&&w?`${w} tkr`:h.profit2024),turnover2024Num:h.turnover2024Num||(2024===R&&f?BigInt(Math.round(1e3*f)):h.turnover2024Num),profit2024Num:h.profit2024Num||(2024===R&&w?BigInt(Math.round(1e3*w)):h.profit2024Num),lastEnriched:new Date,enrichmentError:null}});let E=[];y.roles?.manager?.name&&E.push("VD"),(y.numberOfEmployees||y.employees)&&E.push("anställda"),y.location?.municipality&&E.push("kommun"),y.industries?.[0]?.name&&E.push("bransch"),f&&E.push("omsättning"),d++,r({type:"success",current:e+1,total:c,progress:a,company:t.name,message:`✓ ${t.name}: ${E.length>0?E.join(", "):"uppdaterad"}`,savedFields:E,phase:"success"}),await new Promise(e=>setTimeout(e,500))}catch(o){let a=o instanceof Error?o.message:"Okänt fel";m++,r({type:"error",current:e+1,company:t.name,message:`✗ ${t.name}: ${a}`,phase:"error"});try{let e=s(t.orgNumber);await n.prisma.watchedCompany.update({where:{orgNumber:e},data:{enrichmentError:a,lastEnriched:new Date}})}catch{}}}r({type:"complete",message:`Klar! ${d} lyckades, ${m} fel`,successCount:d,errorCount:m,total:c,remaining:p-c,phase:"done"})}catch(e){r({type:"fatal",message:`Kritiskt fel: ${e instanceof Error?e.message:"Okänt fel"}`,phase:"error"})}finally{e.close()}}});return new Response(r,{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"}})}[n]=r.then?(await r)():r,e.s(["POST",()=>l]),a()}catch(e){a(e)}},!1),435779,e=>e.a(async(t,a)=>{try{var n=e.i(4345),r=e.i(886530),s=e.i(368549),o=e.i(437313),i=e.i(476054),l=e.i(905303),u=e.i(581143),c=e.i(175398),p=e.i(288930),d=e.i(521605),m=e.i(831917),h=e.i(571367),g=e.i(448720),y=e.i(615849),f=e.i(955298),w=e.i(193695);e.i(952391);var R=e.i(541372),E=e.i(642694),v=t([E]);[E]=v.then?(await v)():v;let N=new n.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/bevakning/enrich/stream/route",pathname:"/api/bevakning/enrich/stream",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/CLAUDE/projects/LoopDesk/src/app/api/bevakning/enrich/stream/route.ts",nextConfigOutput:"standalone",userland:E}),{workAsyncStorage:A,workUnitAsyncStorage:x,serverHooks:O}=N;function b(){return(0,s.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:x})}async function C(e,t,a){N.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let n="/api/bevakning/enrich/stream/route";n=n.replace(/\/index$/,"")||"/";let s=await N.prepare(e,t,{srcPage:n,multiZoneDraftMode:!1});if(!s)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:E,params:v,nextConfig:b,parsedUrl:C,isDraftMode:A,prerenderManifest:x,routerServerContext:O,isOnDemandRevalidate:T,revalidateOnlyGenerated:k,resolvedPathname:_,clientReferenceManifest:$,serverActionsManifest:S}=s,D=(0,u.normalizeAppPath)(n),P=!!(x.dynamicRoutes[D]||x.routes[_]),H=async()=>((null==O?void 0:O.render404)?await O.render404(e,t,C,!1):t.end("This page could not be found"),null);if(P&&!A){let e=!!x.routes[_],t=x.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(b.experimental.adapterPath)return await H();throw new w.NoFallbackError}}let I=null;!P||N.isDev||A||(I=_,I="/index"===I?"/":I);let M=!0===N.isDev||!P,U=P&&!M;S&&$&&(0,l.setManifestsSingleton)({page:n,clientReferenceManifest:$,serverActionsManifest:S});let q=e.method||"GET",j=(0,i.getTracer)(),F=j.getActiveScopeSpan(),K={params:v,prerenderManifest:x,renderOpts:{experimental:{authInterrupts:!!b.experimental.authInterrupts},cacheComponents:!!b.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:b.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,n,r)=>N.onRequestError(e,t,n,r,O)},sharedContext:{buildId:E}},B=new c.NodeNextRequest(e),L=new c.NodeNextResponse(t),X=p.NextRequestAdapter.fromNodeNextRequest(B,(0,p.signalFromNodeResponse)(t));try{let s=async e=>N.handle(X,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=j.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${q} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${n}`)}),l=!!(0,o.getRequestMeta)(e,"minimalMode"),u=async o=>{var i,u;let c=async({previousCacheEntry:r})=>{try{if(!l&&T&&k&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await s(o);e.fetchMetrics=K.renderOpts.fetchMetrics;let i=K.renderOpts.pendingWaitUntil;i&&a.waitUntil&&(a.waitUntil(i),i=void 0);let u=K.renderOpts.collectedTags;if(!P)return await (0,h.sendResponse)(B,L,n,K.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(n.headers);u&&(t[f.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,r=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==r?void 0:r.isStale)&&await N.onRequestError(e,t,{routerKind:"App Router",routePath:n,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:T})},!1,O),t}},p=await N.handleResponse({req:e,nextConfig:b,cacheKey:I,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:x,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:k,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:l});if(!P)return null;if((null==p||null==(i=p.value)?void 0:i.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==p||null==(u=p.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",T?"REVALIDATED":p.isMiss?"MISS":p.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,g.fromNodeOutgoingHttpHeaders)(p.value.headers);return l&&P||d.delete(f.NEXT_CACHE_TAGS_HEADER),!p.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,y.getCacheControlHeader)(p.cacheControl)),await (0,h.sendResponse)(B,L,new Response(p.value.body,{headers:d,status:p.value.status||200})),null};F?await u(F):await j.withPropagatedContext(e.headers,()=>j.trace(d.BaseServerSpan.handleRequest,{spanName:`${q} ${n}`,kind:i.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},u))}catch(t){if(t instanceof w.NoFallbackError||await N.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:T})},!1,O),P)throw t;return await (0,h.sendResponse)(B,L,new Response(null,{status:500})),null}}e.s(["handler",()=>C,"patchFetch",()=>b,"routeModule",()=>N,"serverHooks",()=>O,"workAsyncStorage",()=>A,"workUnitAsyncStorage",()=>x]),a()}catch(e){a(e)}},!1)];

//# debugId=0ffa4b1a-9cb1-e892-8b0f-fb98897337e2
//# sourceMappingURL=CLAUDE_projects_LoopDesk_8a1337bf._.js.map